<!DOCTYPE html>
<html lang="en">
<head>
        <title>charlesreid1</title>
        <meta charset="utf-8" />

        <!--
        CSS styles
        -->
        <link href="https://charlesreid1.github.io/theme/css/bootstrap.css"       rel="stylesheet" type="text/css">
        <link href="https://charlesreid1.github.io/theme/css/slate.css"              rel="stylesheet" type="text/css">
        <link href="https://charlesreid1.github.io/theme/css/font-awesome.css"       rel="stylesheet" type="text/css"/>
        <link href="https://charlesreid1.github.io/theme/css/pygment-solarized.css"  rel="stylesheet" type="text/css"/>

        <!--
        my CSS styles
        -->
        <link href="https://charlesreid1.github.io/theme/css/main.css"            rel="stylesheet" type="text/css">
        <link href="https://charlesreid1.github.io/theme/css/dox.css"             rel="stylesheet" type="text/css">


        <!--
        include Angular first
        -->
        <script type="text/javascript" src="https://charlesreid1.github.io/theme/js/angular-1.3.15.js"></script>
        <script type="text/javascript" src="https://charlesreid1.github.io/theme/js/skrollr-0.6.29.js"></script>
        <script type="text/javascript" src="https://charlesreid1.github.io/theme/js/d3-3.5.5.js"></script>

        <!--
        this seems like a bad idea.
        but if I don't put jquery first, I get errors about unrecognized $s.
        -->
        <script type="text/javascript" src="https://charlesreid1.github.io/theme/js/jquery-1.11.2.js"></script>

</head>
<body id="index">
<nav class="navbar navbar-default">
    <div class="container-fluid">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span> 
            </button>
            <a href="https://charlesreid1.github.io" class="navbar-brand">charlesreid1.github.io</a>
        </div>
        <div>
            <div class="collapse navbar-collapse" id="myNavbar">
                <ul class="nav navbar-nav">

                    <li>
                        <a href="https://charlesreid1.com/wiki">Wiki</a>
                    </li>
                    <li>
                        <a href="https://git.charlesreid1.com/explore">Git</a>
                    </li>
                    <li>
                        <a href="http://spotify.charlesreid1.com">Music</a>
                    </li>
                    <li>
                        <a href="https://charlesreid1.com/life">Life</a>
                    </li>
                    <li>
                        <a href="https://charlesreid1.github.io">Blog</a>
                    </li>
                    <li>
                        <a href="https://charlesreid1.com/about">About Me</a>
                    </li>

                </ul>
            </div>
        </div>
    </div>
</nav>



<div class="container">

<header>
<div class="row">


    <div class="col-md-12">
        <div class="headtext" style="text-align: center;">
            <h1><b>
                Incorporating Terraform Commands into Makefiles
            </b></h1>
        
            <p class="lead">
                Posted 
                <time datetime="2020-02-15T12:00:00-08:00" pubdate>Saturday 02/15/2020</time>
                in 
                <a href="https://charlesreid1.github.io/category/terraform.html">Terraform</a>
                </p>
            <p>
            <span style="font-size: 14px">
                <a href="https://charlesreid1.github.io/incorporating-terraform-commands-into-makefiles.html">permalink</a>
            </span>
            </p>
        </div>

    </div>

</div>
</header>


<div class="v50"></div>


<div class="row">
    <div class="col-md-12" style="text-align: left;">

        <div class="entry-content"><div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#summary">Summary</a></li>
<li><a href="#step-0-directory-and-file-layout">Step 0: Directory and File Layout</a><ul>
<li><a href="#environment-variables">Environment Variables</a></li>
</ul>
</li>
<li><a href="#step-1-top-level-makefile">Step 1: Top Level Makefile</a></li>
<li><a href="#step-2-infra-level-makefile">Step 2: Infra Level Makefile</a><ul>
<li><a href="#fake-targets">Fake Targets</a></li>
<li><a href="#commands-for-single-components">Commands for Single Components</a></li>
<li><a href="#commands-for-all-components">Commands for All Components</a></li>
<li><a href="#variables">Variables</a></li>
<li><a href="#final-makefile">Final Makefile</a></li>
</ul>
</li>
<li><a href="#step-3-writing-terraform-components">Step 3: Writing Terraform Components</a></li>
<li><a href="#step-4-initializing-terraform-components">Step 4: Initializing Terraform Components</a></li>
<li><a href="#workflow">Workflow</a><ul>
<li><a href="#plan">Plan</a></li>
<li><a href="#deploy">Deploy</a></li>
<li><a href="#update">Update</a></li>
<li><a href="#destroy">Destroy</a></li>
</ul>
</li>
</ul>
</div>
<h1 id="summary">Summary</h1>
<p>This blog post covers a useful pattern for incorporating terraform commands
into a Makefile.</p>
<p>This is useful for cases where terraform is being used to manage infrastructure.
In the end you will be able to run a command like</p>
<div class="highlight"><pre><span></span>make plan-infra
make deploy-infra
</pre></div>


<p>and and have this call the corresponding terraform commands to plan and deploy your
terraformed cloud infrastructure.</p>
<p>The post is divided into a few steps:</p>
<ul>
<li>Directory and file layout - how we lay out the files for this tutorial</li>
<li>Top level Makefile - make commands to add to the top level Makefile</li>
<li>Infra level Makefile - make commands to add to the infra level Makefile</li>
<li>Writing Terraform component - how to write a configurable component that is ready to terraform</li>
<li>Initializing Terraform component - script to initialize terraform components</li>
<li>Workflow - plan, deploy, update, destroy</li>
</ul>
<h1 id="step-0-directory-and-file-layout">Step 0: Directory and File Layout</h1>
<p>This tutorial presumes you have a top level directory corresponding to a git repository.
We will use the following directory structure for this example:</p>
<div class="highlight"><pre><span></span>my-project/
    Readme.md
    environment
    Makefile
    infra/
        Makefile
        component-1/
            variables.tf
            main.tf
</pre></div>


<h2 id="environment-variables">Environment Variables</h2>
<p>In order to keep track of environment variables used in the terraform
process, we use the file <code>envronment</code> in the top level project directory
to keep all environment variable values under version control.</p>
<div class="highlight"><pre><span></span><span class="nv">SOURCE</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">BASH_SOURCE</span><span class="p">[0]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="k">while</span> <span class="o">[</span> -h <span class="s2">&quot;</span><span class="nv">$SOURCE</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">do</span> <span class="nv">SOURCE</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>readlink <span class="s2">&quot;</span><span class="nv">$SOURCE</span><span class="s2">&quot;</span><span class="k">)</span><span class="s2">&quot;</span><span class="p">;</span> <span class="k">done</span>
<span class="nb">export</span> <span class="nv">PROJECT_HOME</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span><span class="nb">cd</span> -P <span class="s2">&quot;</span><span class="k">$(</span>dirname <span class="s2">&quot;</span><span class="nv">$SOURCE</span><span class="s2">&quot;</span><span class="k">)</span><span class="s2">&quot;</span> <span class="o">&amp;&amp;</span> <span class="nb">pwd</span><span class="k">)</span><span class="s2">&quot;</span>

<span class="nb">set</span> -a
<span class="nv">PROJECT_DEPLOYMENT_STAGE</span><span class="o">=</span><span class="s2">&quot;dev&quot;</span>

<span class="c1"># bucket name</span>
<span class="nv">PROJECT_S3_BUCKET</span><span class="o">=</span><span class="s2">&quot;my-organization-my-project-my-bucket&quot;</span>

<span class="c1"># aws tags</span>
<span class="nv">PROJECT_INFRA_TAG_PROJECT</span><span class="o">=</span><span class="s2">&quot;my-project&quot;</span>
<span class="nv">PROJECT_INFRA_TAG_SERVICE</span><span class="o">=</span><span class="s2">&quot;my-service&quot;</span>
<span class="nv">PROJECT_INFRA_TAG_OWNER</span><span class="o">=</span><span class="s2">&quot;whoami@email.com&quot;</span>

<span class="c1"># aws settings</span>
<span class="nv">AWS_DEFAULT_OUTPUT</span><span class="o">=</span>json
<span class="nv">AWS_DEFAULT_REGION</span><span class="o">=</span>us-east-1
<span class="nb">set</span> +a
</pre></div>


<p>Optionally, a local environment file can contain environment variable values
that are sensitive or should not be kept under version control, so add this
to the bottom of the <code>environment</code> file too:</p>
<div class="highlight"><pre><span></span><span class="k">if</span> <span class="o">[[</span> -f <span class="s2">&quot;</span><span class="si">${</span><span class="nv">PROJECT_HOME</span><span class="si">}</span><span class="s2">/environment.local&quot;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">source</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">PROJECT_HOME</span><span class="si">}</span><span class="s2">/environment.local&quot;</span>
<span class="k">fi</span>
</pre></div>


<h1 id="step-1-top-level-makefile">Step 1: Top Level Makefile</h1>
<p>Start by creating the <code>plan-infra</code> and <code>deploy-infra</code> commands in your top-level
Makefile. These commands will, in turn, call make commands defined in <code>infra/Makefile</code>:</p>
<div class="highlight"><pre><span></span><span class="nf">plan-infra</span><span class="o">:</span>
    <span class="k">$(</span>MAKE<span class="k">)</span> -C infra plan-all

<span class="nf">deploy-infra</span><span class="o">:</span>
    <span class="k">$(</span>MAKE<span class="k">)</span> -C infra apply-all
</pre></div>


<p>The <code>-C infra</code> flag indicates make should use a Makefile in a subdirectory.</p>
<h1 id="step-2-infra-level-makefile">Step 2: Infra Level Makefile</h1>
<p>Next we define <code>infra/Makefile</code>. This Makefile will have two parts:</p>
<ul>
<li>terraform commands for a single component (example: init, plan, apply, destroy)</li>
<li>wrapper commands to run the above commands for every component (example: for each component,
  run the plan terraform command)</li>
</ul>
<p>We cover the Makefile from the bottom up.</p>
<h2 id="fake-targets">Fake Targets</h2>
<p>Start by defining "fake" targets or rules, that is, make rules whose names are not file names:</p>
<div class="highlight"><pre><span></span><span class="nf">.PHONY</span><span class="o">:</span> <span class="n">init</span>-<span class="n">all</span> <span class="n">plan</span>-<span class="n">all</span> <span class="n">apply</span>-<span class="n">all</span> <span class="n">clean</span>-<span class="n">all</span> <span class="n">plan</span> <span class="n">apply</span> <span class="n">destroy</span> <span class="n">init</span> <span class="n">clean</span>
</pre></div>


<h2 id="commands-for-single-components">Commands for Single Components</h2>
<p>Next, above that, we define terraform commands for a single component:</p>
<div class="highlight"><pre><span></span><span class="nf">init</span><span class="o">:</span>
    rm -rf <span class="k">$(</span>COMPONENT<span class="k">)</span>/.terraform/*.tfstate
    ./build_deploy_config.py <span class="k">$(</span>COMPONENT<span class="k">)</span>
    <span class="nb">cd</span> <span class="k">$(</span>COMPONENT<span class="k">)</span><span class="p">;</span> terraform init<span class="p">;</span>

<span class="nf">plan</span><span class="o">:</span> <span class="n">init</span>
    <span class="nb">cd</span> <span class="k">$(</span>COMPONENT<span class="k">)</span><span class="p">;</span> terraform plan -detailed-exitcode

<span class="nf">apply</span><span class="o">:</span> <span class="n">init</span>
    <span class="nb">cd</span> <span class="k">$(</span>COMPONENT<span class="k">)</span><span class="p">;</span> terraform apply

<span class="nf">destroy</span><span class="o">:</span> <span class="n">init</span>
    <span class="nb">cd</span> <span class="k">$(</span>COMPONENT<span class="k">)</span><span class="p">;</span> terraform destroy

<span class="nf">clean</span><span class="o">:</span>
    <span class="nb">cd</span> <span class="k">$(</span>COMPONENT<span class="k">)</span><span class="p">;</span> rm -rf .terraform
</pre></div>


<p>Note that the <code>init</code> command is running a <code>build_deploy_config.py</code> script,
which we will cover in a moment. This script creates the terraform variables
file <code>variables.tf</code> and populates the variable values using environment
variables.</p>
<h2 id="commands-for-all-components">Commands for All Components</h2>
<p>Above that, we have commands to perform each action on all components:</p>
<div class="highlight"><pre><span></span><span class="nf">all</span><span class="o">:</span> <span class="n">init</span>-<span class="n">all</span>

<span class="nf">init-all</span><span class="o">:</span>
    @for c in <span class="k">$(</span>COMPONENTS<span class="k">)</span><span class="p">;</span> <span class="k">do</span> <span class="se">\</span>
        <span class="k">$(</span>MAKE<span class="k">)</span> init <span class="nv">COMPONENT</span><span class="o">=</span><span class="nv">$$</span>c <span class="o">||</span> <span class="nb">exit</span> <span class="m">1</span><span class="p">;</span> <span class="se">\</span>
    <span class="k">done</span>

<span class="nf">plan-all</span><span class="o">:</span>
    @for c in <span class="k">$(</span>COMPONENTS<span class="k">)</span><span class="p">;</span> <span class="k">do</span> <span class="se">\</span>
        <span class="k">$(</span>MAKE<span class="k">)</span> plan <span class="nv">COMPONENT</span><span class="o">=</span><span class="nv">$$</span>c <span class="o">||</span> <span class="nb">exit</span> <span class="m">1</span><span class="p">;</span> <span class="se">\</span>
    <span class="k">done</span>

<span class="nf">apply-all</span><span class="o">:</span>
    @for c in <span class="k">$(</span>COMPONENTS<span class="k">)</span><span class="p">;</span> <span class="k">do</span> <span class="se">\</span>
        <span class="k">$(</span>MAKE<span class="k">)</span> apply <span class="nv">COMPONENT</span><span class="o">=</span><span class="nv">$$</span>c <span class="o">||</span> <span class="nb">exit</span> <span class="m">1</span><span class="p">;</span> <span class="se">\</span>
    <span class="k">done</span>

<span class="nf">destroy-all</span><span class="o">:</span>
    @for c in <span class="k">$(</span>COMPONENTS<span class="k">)</span><span class="p">;</span> <span class="k">do</span> <span class="se">\</span>
        <span class="k">$(</span>MAKE<span class="k">)</span> destroy <span class="nv">COMPONENT</span><span class="o">=</span><span class="nv">$$</span>c <span class="o">||</span> <span class="nb">exit</span> <span class="m">1</span><span class="p">;</span> <span class="se">\</span>
    <span class="k">done</span>

<span class="nf">clean-all</span><span class="o">:</span>
    @for c in <span class="k">$(</span>COMPONENTS<span class="k">)</span><span class="p">;</span> <span class="k">do</span> <span class="se">\</span>
        <span class="k">$(</span>MAKE<span class="k">)</span> clean <span class="nv">COMPONENT</span><span class="o">=</span><span class="nv">$$</span>c <span class="o">||</span> <span class="nb">exit</span> <span class="m">1</span><span class="p">;</span> <span class="se">\</span>
    <span class="k">done</span>
</pre></div>


<h2 id="variables">Variables</h2>
<p>Last but not least, we define a few variables at the top of the Makefile:
most importantly, the list of infrastructure components. This is created by
extracting the names of subdirectories in <code>infra/</code> containing <code>*.tf</code> files:</p>
<div class="highlight"><pre><span></span><span class="nv">DIRS</span><span class="o">=</span><span class="si">${</span><span class="nv">shell</span><span class="p"> find . -name </span><span class="s2">&quot;*.tf&quot;</span><span class="p"> -exec dirname {</span><span class="si">}</span> <span class="se">\;</span> <span class="p">|</span> sort --unique<span class="o">}</span>
<span class="nv">COMPONENTS</span><span class="o">=</span><span class="si">${</span><span class="nv">shell</span><span class="p"> for d in </span><span class="k">$(</span>DIRS<span class="k">)</span><span class="p">; do basename </span><span class="nv">$$d</span><span class="p">; done</span><span class="si">}</span>
</pre></div>


<h2 id="final-makefile">Final Makefile</h2>
<p>Here is the final <code>infra/Makefile</code>:</p>
<p><strong><code>infra/Makefile</code>:</strong></p>
<div class="highlight"><pre><span></span><span class="nv">DIRS</span><span class="o">=</span><span class="si">${</span><span class="nv">shell</span><span class="p"> find . -name </span><span class="s2">&quot;*.tf&quot;</span><span class="p"> -exec dirname {</span><span class="si">}</span> <span class="se">\;</span> <span class="p">|</span> sort --unique<span class="o">}</span>
<span class="nv">COMPONENTS</span><span class="o">=</span><span class="si">${</span><span class="nv">shell</span><span class="p"> for d in </span><span class="k">$(</span>DIRS<span class="k">)</span><span class="p">; do basename </span><span class="nv">$$d</span><span class="p">; done</span><span class="si">}</span>

<span class="nf">all</span><span class="o">:</span> <span class="n">init</span>-<span class="n">all</span>

<span class="nf">init-all</span><span class="o">:</span>
    @for c in <span class="k">$(</span>COMPONENTS<span class="k">)</span><span class="p">;</span> <span class="k">do</span> <span class="se">\</span>
        <span class="k">$(</span>MAKE<span class="k">)</span> init <span class="nv">COMPONENT</span><span class="o">=</span><span class="nv">$$</span>c <span class="o">||</span> <span class="nb">exit</span> <span class="m">1</span><span class="p">;</span> <span class="se">\</span>
    <span class="k">done</span>

<span class="nf">plan-all</span><span class="o">:</span>
    @for c in <span class="k">$(</span>COMPONENTS<span class="k">)</span><span class="p">;</span> <span class="k">do</span> <span class="se">\</span>
        <span class="k">$(</span>MAKE<span class="k">)</span> plan <span class="nv">COMPONENT</span><span class="o">=</span><span class="nv">$$</span>c <span class="o">||</span> <span class="nb">exit</span> <span class="m">1</span><span class="p">;</span> <span class="se">\</span>
    <span class="k">done</span>

<span class="nf">apply-all</span><span class="o">:</span>
    @for c in <span class="k">$(</span>COMPONENTS<span class="k">)</span><span class="p">;</span> <span class="k">do</span> <span class="se">\</span>
        <span class="k">$(</span>MAKE<span class="k">)</span> apply <span class="nv">COMPONENT</span><span class="o">=</span><span class="nv">$$</span>c <span class="o">||</span> <span class="nb">exit</span> <span class="m">1</span><span class="p">;</span> <span class="se">\</span>
    <span class="k">done</span>

<span class="nf">destroy-all</span><span class="o">:</span>
    @for c in <span class="k">$(</span>COMPONENTS<span class="k">)</span><span class="p">;</span> <span class="k">do</span> <span class="se">\</span>
        <span class="k">$(</span>MAKE<span class="k">)</span> destroy <span class="nv">COMPONENT</span><span class="o">=</span><span class="nv">$$</span>c <span class="o">||</span> <span class="nb">exit</span> <span class="m">1</span><span class="p">;</span> <span class="se">\</span>
    <span class="k">done</span>

<span class="nf">clean-all</span><span class="o">:</span>
    @for c in <span class="k">$(</span>COMPONENTS<span class="k">)</span><span class="p">;</span> <span class="k">do</span> <span class="se">\</span>
        <span class="k">$(</span>MAKE<span class="k">)</span> clean <span class="nv">COMPONENT</span><span class="o">=</span><span class="nv">$$</span>c <span class="o">||</span> <span class="nb">exit</span> <span class="m">1</span><span class="p">;</span> <span class="se">\</span>
    <span class="k">done</span>

<span class="nf">plan</span><span class="o">:</span> <span class="n">init</span>
    <span class="nb">cd</span> <span class="k">$(</span>COMPONENT<span class="k">)</span><span class="p">;</span> terraform plan -detailed-exitcode

<span class="nf">apply</span><span class="o">:</span> <span class="n">init</span>
    <span class="nb">cd</span> <span class="k">$(</span>COMPONENT<span class="k">)</span><span class="p">;</span> terraform apply

<span class="nf">destroy</span><span class="o">:</span> <span class="n">init</span>
    <span class="nb">cd</span> <span class="k">$(</span>COMPONENT<span class="k">)</span><span class="p">;</span> terraform destroy

<span class="nf">init</span><span class="o">:</span>
    rm -rf <span class="k">$(</span>COMPONENT<span class="k">)</span>/.terraform/*.tfstate
    ./build_deploy_config.py <span class="k">$(</span>COMPONENT<span class="k">)</span>
    <span class="nb">cd</span> <span class="k">$(</span>COMPONENT<span class="k">)</span><span class="p">;</span> terraform init<span class="p">;</span>

<span class="nf">clean</span><span class="o">:</span>
    <span class="nb">cd</span> <span class="k">$(</span>COMPONENT<span class="k">)</span><span class="p">;</span> rm -rf .terraform

<span class="nf">.PHONY</span><span class="o">:</span> <span class="n">init</span>-<span class="n">all</span> <span class="n">plan</span>-<span class="n">all</span> <span class="n">apply</span>-<span class="n">all</span> <span class="n">clean</span>-<span class="n">all</span> <span class="n">plan</span> <span class="n">apply</span> <span class="n">destroy</span> <span class="n">init</span> <span class="n">clean</span>
</pre></div>


<h1 id="step-3-writing-terraform-components">Step 3: Writing Terraform Components</h1>
<p>As an example, we will consider an example of terraform-managed buckets.</p>
<p>Start by creating a directory called <code>infra/buckets/</code> to store terraform
files for creating and managing the buckets.</p>
<p>We can create one file per cloud provider. As an example, here is <code>s3.tf</code>:</p>
<p><strong><code>s3.tf</code></strong>:</p>
<div class="highlight"><pre><span></span>data &quot;aws_caller_identity&quot; &quot;current&quot; {}

locals {
  common_tags = &quot;${map(
    &quot;project&quot;   , &quot;${var.PROJECT_INFRA_TAG_PROJECT}&quot;,
    &quot;env&quot;       , &quot;${var.PROJECT_DEPLOYMENT_STAGE}&quot;,
    &quot;service&quot;   , &quot;${var.PROJECT_INFRA_TAG_SERVICE}&quot;
  )}&quot;
  aws_tags = &quot;${map(
  &quot;Name&quot;      , &quot;${var.PROJECT_INFRA_TAG_SERVICE}-s3-storage&quot;,
  &quot;owner&quot;     , &quot;${var.PROJECT_INFRA_TAG_OWNER}&quot;,
  &quot;managedBy&quot; , &quot;terraform&quot;
  )}&quot;
}

resource aws_s3_bucket dss_s3_bucket {
  count = length(var.PROJECT_S3_BUCKET) &gt; 0 ? 1 : 0
  bucket = var.PROJECT_S3_BUCKET
  server_side_encryption_configuration {
    rule {
      apply_server_side_encryption_by_default {
        sse_algorithm = &quot;AES256&quot;
      }
    }
  }
  tags = merge(local.common_tags, local.aws_tags)
}
</pre></div>


<p>Note that this requires several environment variables to be
defined in <code>environment</code> and requires the operator to run:</p>
<div class="highlight"><pre><span></span>source environment
</pre></div>


<h1 id="step-4-initializing-terraform-components">Step 4: Initializing Terraform Components</h1>
<p>The following script will automatically generate terraform files for
our component that are populated with the correct environment variable
values.</p>
<p>It is called <code>build_deploy_config.py</code>.</p>
<p>Start with a simple argument parser that just accepts a single argument,
the component to make terraform files for:</p>
<div class="highlight"><pre><span></span><span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="vm">__doc__</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;component&quot;</span><span class="p">)</span>
<span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
</pre></div>


<p>Next, we define several terraform file templates using Python's
bracket template syntax. Start with a template for defining a
terraform variable:</p>
<div class="highlight"><pre><span></span>terraform_variable_template = &quot;&quot;&quot;
variable &quot;{name}&quot; {{
  default = &quot;{val}&quot;
}}
&quot;&quot;&quot;
</pre></div>


<p>Next, define a template for the terraform backend buket:</p>
<div class="highlight"><pre><span></span>terraform_backend_template = &quot;&quot;&quot;# Auto-generated during infra build process.
# Please edit infra/build_deploy_config.py directly.
terraform {{
  backend &quot;s3&quot; {{
    bucket = &quot;{bucket}&quot;
    key = &quot;{comp}-{stage}.tfstate&quot;
    region = &quot;{region}&quot;
    {profile_setting}
  }}
}}
&quot;&quot;&quot;
</pre></div>


<p>Next define terraform cloud providers:</p>
<div class="highlight"><pre><span></span>terraform_providers_template = &quot;&quot;&quot;# Auto-generated during infra build process.
# Please edit infra/build_deploy_config.py directly.
provider aws {{
  region = &quot;{aws_region}&quot;
}}
&quot;&quot;&quot;
</pre></div>


<p>Provide a list of environment variables that should also be defined as
terraform variables:</p>
<div class="highlight"><pre><span></span><span class="nv">env_vars_to_infra</span> <span class="o">=</span> <span class="o">[</span>
<span class="nv">PROJECT_DEPLOYMENT_STAGE</span><span class="o">=</span><span class="s2">&quot;dev&quot;</span>

<span class="c1"># bucket name</span>
<span class="nv">PROJECT_S3_BUCKET</span><span class="o">=</span><span class="s2">&quot;my-organization-my-project-my-bucket&quot;</span>

<span class="c1"># aws tags</span>
<span class="nv">PROJECT_INFRA_TAG_PROJECT</span><span class="o">=</span><span class="s2">&quot;my-project&quot;</span>
<span class="nv">PROJECT_INFRA_TAG_SERVICE</span><span class="o">=</span><span class="s2">&quot;my-service&quot;</span>
<span class="nv">PROJECT_INFRA_TAG_OWNER</span><span class="o">=</span><span class="s2">&quot;whoami@email.com&quot;</span>

<span class="c1"># aws settings</span>
<span class="nv">AWS_DEFAULT_OUTPUT</span><span class="o">=</span>json
<span class="nv">AWS_DEFAULT_REGION</span><span class="o">=</span>us-east-1

    <span class="s2">&quot;AWS_DEFAULT_REGION&quot;</span>,
    <span class="s2">&quot;PROJECT_DEPLOYMENT_STAGE&quot;</span>,
    <span class="s2">&quot;PROJECT_S3_BUCKET&quot;</span>,
    <span class="s2">&quot;PROJECT_INFRA_TAG_PROJECT&quot;</span>,
    <span class="s2">&quot;PROJECT_INFRA_TAG_SERVICE&quot;</span>,
    <span class="s2">&quot;PROJECT_INFRA_TAG_OWNER&quot;</span>
<span class="o">]</span>
</pre></div>


<p>Finally, substitute environment variable values into the templates, and write
the templated content to the appropriate <code>*.tf</code> file. First, the backend:</p>
<div class="highlight"><pre><span></span><span class="c1"># Write backend.tf</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">infra_root</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">component</span><span class="p">,</span> <span class="s2">&quot;backend.tf&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
    <span class="n">caller_info</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;sts&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get_caller_identity</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;AWS_PROFILE&#39;</span><span class="p">):</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;AWS_PROFILE&#39;</span><span class="p">]</span>
        <span class="n">profile_setting</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;profile = &quot;</span><span class="si">{profile}</span><span class="s1">&quot;&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">profile_setting</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">terraform_backend_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">bucket</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;DSS_TERRAFORM_BACKEND_BUCKET_TEMPLATE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">account_id</span><span class="o">=</span><span class="n">caller_info</span><span class="p">[</span><span class="s1">&#39;Account&#39;</span><span class="p">]),</span>
        <span class="n">comp</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">component</span><span class="p">,</span>
        <span class="n">stage</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;DSS_DEPLOYMENT_STAGE&#39;</span><span class="p">],</span>
        <span class="n">region</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;AWS_DEFAULT_REGION&#39;</span><span class="p">],</span>
        <span class="n">profile_setting</span><span class="o">=</span><span class="n">profile_setting</span><span class="p">,</span>
    <span class="p">))</span>
</pre></div>


<p>Next, the <code>variables.tf</code> for the component:</p>
<div class="highlight"><pre><span></span><span class="c1"># Write variables.tf</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">infra_root</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">component</span><span class="p">,</span> <span class="s2">&quot;variables.tf&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
    <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# Auto-generated during infra build process.&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="p">)</span>
    <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# Please edit infra/build_deploy_config.py directly.&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">env_vars_to_infra</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">terraform_variable_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">val</span><span class="p">))</span>
</pre></div>


<p>Finally, the cloud providers file <code>providers.tf</code>:</p>
<div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">infra_root</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">component</span><span class="p">,</span> <span class="s2">&quot;providers.tf&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
    <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">terraform_providers_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">aws_region</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;AWS_DEFAULT_REGION&#39;</span><span class="p">],</span>
        <span class="n">gcp_project_id</span><span class="o">=</span><span class="n">GCP_PROJECT_ID</span><span class="p">,</span>
    <span class="p">))</span>
</pre></div>


<h1 id="workflow">Workflow</h1>
<p>We now have a top-level Makefile that wraps the plan and apply commands directly,
and we have an infra-level Makefile with additional commands for managing infrastructure
(plan, apply, destroy).</p>
<h2 id="plan">Plan</h2>
<p>The terraform plan step assembles the various templated terraform files and substitutes
environment variables into them, creating a new version of them with up-to-date values.</p>
<p>The plan step (<code>make plan-infra</code>) calls the <code>build_deploy_config.py</code> script (detailed above)
to regenerate the terraform files when environment variables are changed.</p>
<div class="highlight"><pre><span></span>make plan-infra
</pre></div>


<p>This script will iterate over each cloud infrastructure component in <code>infra/</code>, use terraform
to plan the changes it would make to cloud resources, and print a summary of those changes
to the screen.</p>
<p><strong>The <code>make plan-infra</code> command does not change any cloud infra.</strong></p>
<h2 id="deploy">Deploy</h2>
<p>The terraform deploy step makes the changes summarized in the <code>make plan-infra</code> step. This
command automates the terraform commands, but still requires interactive "yes" responses
to commands.</p>
<h2 id="update">Update</h2>
<p>Using the <code>make plan-infra</code> command will remake the terraform files using environment variable
values, and will display any changes that will be made to cloud infra. This includes updates to
existing infrastructure.</p>
<p>When you finish deploying infrastructure, store the version of your <code>environment</code> file in version
control and tag it as the current deployed infra. This will make it easier to delete infra later.</p>
<p>If you need to rename infra, use the following workflow:</p>
<ol>
<li>
<p>Source the old <code>environment</code> file</p>
</li>
<li>
<p>Destroy the old infra with the old names using:</p>
<p><code>text
make -C infra COMPONENT=buckets destroy</code></p>
<p>Or destroy all infra with the <code>destroy-all</code> command:</p>
<p><code>text
make -C infra destroy-all</code></p>
</li>
<li>
<p>Update the environment file with the new names, and source the new <code>environment</code> file</p>
</li>
<li>
<p>Plan the new infra with</p>
<p><code>text
make plan-infra</code></p>
</li>
<li>
<p>Deploy the new infra with</p>
<p><code>text
make deploy-infra</code></p>
</li>
</ol>
<h2 id="destroy">Destroy</h2>
<p>As seen above, infrastructure components can be deleted with the <code>delete</code> command in the infra
Makefile, and all infrastructure components can be deleted with the <code>delete-all</code> command.</p>
<p>To delete a particular component:</p>
<div class="highlight"><pre><span></span>make -C infra COMPONENT=buckets destroy
</pre></div>


<p>To destroy all infra:</p>
<div class="highlight"><pre><span></span>make -C infra destroy-all
</pre></div></div>

    </div>
</div>

<div class="v20"></div>

<div class="row">
    <div class="col-md-12" style="text-align: left;">

        <div class="tags">
            <p>Tags:&nbsp;&nbsp;&nbsp;
                    <a href="https://charlesreid1.github.io/tag/terraform.html">terraform</a>
                    &nbsp;&nbsp;
                    <a href="https://charlesreid1.github.io/tag/makefile.html">makefile</a>
                    &nbsp;&nbsp;
                    <a href="https://charlesreid1.github.io/tag/make.html">make</a>
                    &nbsp;&nbsp;
                    <a href="https://charlesreid1.github.io/tag/python.html">python</a>
                    &nbsp;&nbsp;
        </div>

    </div>
</div>


<div class="v200"></div>

</div>


<script type="text/javascript" src="https://charlesreid1.github.io/theme/js/jquery-1.11.2.js"></script>
<script type="text/javascript" src="https://charlesreid1.github.io/theme/js/bootstrap-3.3.4.js"></script>
<script type="text/javascript" src="https://charlesreid1.github.io/theme/js/d3-3.5.5.js"></script><script type="text/javascript" src="https://charlesreid1.github.io/theme/js/jquery-1.11.2.js"></script>
<script type="text/javascript" src="https://charlesreid1.github.io/theme/js/bootstrap-3.3.4.js"></script>

<footer id="contentinfo" class="body">
<p>&nbsp;</p>
<p>&nbsp;</p>
<center>
	<hr />
</center>
<p>&nbsp;</p>
<p style="text-align: center">
    <span class="fa-stack fa-lg">
        <i class="fa fa-square fa-stack-2x" style="color:#000;"></i>
        <i class="fa fa-terminal fa-stack-1x fa-inverse"></i>
    </span>
    Made from the command line with vim by 
    <a href="http://charlesreid1.com">charlesreid1</a><br />
    with help from <a href="https://getbootstrap.com/">Bootstrap</a> and <a href="http://getpelican.com">Pelican</a>.
</p>

<br />

<p style="text-align: center">
    <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">
    <span class="fa-stack fa-lg">
        <i class="fa fa-square fa-stack-2x" style="color:#000;"></i>
        <i class="fa fa-creative-commons fa-stack-1x fa-inverse"></i>
    </span>
    </a>
    <br />
    Licensed under the <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">Creative Commons Attribution-NonCommercial 4.0 License</a>.
</p>

<!-- Start of StatCounter Code for Default Guide -->
<script type="text/javascript">
var sc_project=11611748;
var sc_invisible=1;
var sc_security="9fcba820";
</script>
<script type="text/javascript"
src="https://www.statcounter.com/counter/counter.js"
async></script>

<noscript><div class="statcounter"><a title="Web Analytics"
href="http://statcounter.com/" target="_blank"><img
class="statcounter"
src="//c.statcounter.com/11611748/0/9fcba820/1/" alt="Web
Analytics"></a></div></noscript>
<!-- End of StatCounter Code for Default Guide -->
</footer><!-- /#contentinfo -->
</body>
</html>