<!DOCTYPE html>
<html lang="en">
<head>
        <title>charlesreid1</title>
        <meta charset="utf-8" />

        <!--
        CSS styles
        -->
        <link href="http://localhost:8000/theme/css/bootstrap.css"       rel="stylesheet" type="text/css">
        <link href="http://localhost:8000/theme/css/slate.css"              rel="stylesheet" type="text/css">
        <link href="http://localhost:8000/theme/css/font-awesome.css"       rel="stylesheet" type="text/css"/>
        <link href="http://localhost:8000/theme/css/pygment-solarized.css"  rel="stylesheet" type="text/css"/>

        <!--
        my CSS styles
        -->
        <link href="http://localhost:8000/theme/css/main.css"            rel="stylesheet" type="text/css">
        <link href="http://localhost:8000/theme/css/dox.css"             rel="stylesheet" type="text/css">


        <!--
        include Angular first
        -->
        <script type="text/javascript" src="http://localhost:8000/theme/js/angular-1.3.15.js"></script>
        <script type="text/javascript" src="http://localhost:8000/theme/js/skrollr-0.6.29.js"></script>
        <script type="text/javascript" src="http://localhost:8000/theme/js/d3-3.5.5.js"></script>

        <!--
        this seems like a bad idea.
        but if I don't put jquery first, I get errors about unrecognized $s.
        -->
        <script type="text/javascript" src="http://localhost:8000/theme/js/jquery-1.11.2.js"></script>

</head>
<body id="index">
<nav class="navbar navbar-default">
    <div class="container-fluid">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span> 
            </button>
            <a href="https://charlesreid1.github.io" class="navbar-brand">charlesreid1.github.io</a>
        </div>
        <div>
            <div class="collapse navbar-collapse" id="myNavbar">
                <ul class="nav navbar-nav">

                    <li>
                        <a href="https://charlesreid1.com/wiki">Wiki</a>
                    </li>
                    <li>
                        <a href="https://git.charlesreid1.com/explore">Git</a>
                    </li>
                    <li>
                        <a href="http://spotify.charlesreid1.com">Music</a>
                    </li>
                    <li>
                        <a href="https://charlesreid1.com/life">Life</a>
                    </li>
                    <li>
                        <a href="https://charlesreid1.github.io">Blog</a>
                    </li>
                    <li>
                        <a href="https://charlesreid1.com/about">About Me</a>
                    </li>

                </ul>
            </div>
        </div>
    </div>
</nav>



<div class="container">

<header>
<div class="row">


    <div class="col-md-12">
        <div class="headtext" style="text-align: center;">
            <h1><b>
                Building Snakemake Command Line Wrappers for Workflows
            </b></h1>
        
            <p class="lead">
                Posted 
                <time datetime="2019-01-21T22:00:00-08:00" pubdate>Monday 01/21/2019</time>
                in 
                <a href="http://localhost:8000/category/snakemake.html">Snakemake</a>
                </p>
            <p>
            <span style="font-size: 14px">
                <a href="http://localhost:8000/building-snakemake-command-line-wrappers-for-workflows.html">permalink</a>
            </span>
            </p>
        </div>

    </div>

</div>
</header>


<div class="v50"></div>


<div class="row">
    <div class="col-md-12" style="text-align: left;">

        <div class="entry-content"><p><strong>NOTE:</strong> These ideas are implemented in the repository
<a href="https://github.com/charlesreid/2019-snakemake-cli">charlesreid1/2019-snakemake-cli</a>.</p>
<p><br />
<br /></p>
<h2 id="table-of-contents">Table of Contents:</h2>
<ul>
<li><a href="#basic">Basic Idea: Wrapping Snakemake API Calls</a><ul>
<li><a href="#2018">2018-snakemake-cli</a></li>
<li><a href="#2019">2019-snakemake-cli</a></li>
</ul>
</li>
<li><a href="#exe">Turning Executables into Packages</a></li>
<li><a href="#using">End Result: Using bananas</a></li>
<li><a href="#travis">Adding Travis CI Tests</a></li>
<li><a href="#next">Next Steps</a></li>
</ul>
<p><br />
<br /></p>
<p><a name="basic"></a></p>
<h1 id="basic-idea-wrapping-snakemake-api-calls">Basic Idea: Wrapping Snakemake API Calls</h1>
<p><a name="2018"></a></p>
<h2 id="2018-snakemake-cli">2018-snakemake-cli</h2>
<p>This blog post covers the implementation of an idea
that was originally explored in a blog post from 
Titus Brown, <a href="http://ivory.idyll.org/blog/2018-workflows-applications.html">Pydoit, snakemake, and workflows-as-applications</a>.</p>
<p>That blog post implemented a basic command line
wrapper around the Snakemake API to demonstrate
how a Snakemake workflow could be turned into
an executable.</p>
<p>Relevant code is in <a href="https://github.com/ctb/2018-snakemake-cli">ctb/2018-snakemake-cli</a>,
but the basic idea is to implement a command line
utility that takes two orthogonal sets of inputs:
a workflow configuration file, and a parameter set.</p>
<div class="highlight"><pre><span></span><span class="err">./run &lt;workflow-config&gt; &lt;workflow-params&gt;</span>
</pre></div>


<p>The <a href="https://github.com/ctb/2018-snakemake-cli/blob/master/run">run script</a>
is a Python executable file that parses arguments
from the user.</p>
<p>Here is the main entrypoint of <code>run</code>:</p>
<div class="highlight"><pre><span></span><span class="ch">#! /usr/bin/env python</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Execution script for snakemake workflows.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">snakemake</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">pprint</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="n">thisdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="c1"># </span>
    <span class="c1"># ...see below...</span>
    <span class="c1">#</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s1">&#39;run snakemake workflows&#39;</span><span class="p">,</span> <span class="n">usage</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;run &lt;workflow&gt; &lt;parameters&gt; [&lt;target&gt;]</span>
<span class="s1">Run snakemake workflows, using the given workflow name &amp; parameters file.</span>
<span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;workflowfile&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;paramsfile&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-n&#39;</span><span class="p">,</span> <span class="s1">&#39;--dry-run&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">main</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
</pre></div>


<p>The <code>main()</code> method uses the <code>os</code> module to look for
the Snakefile, the config file, and the params file,
then makes a call to the Snakemake API:</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="c1">#</span>
    <span class="c1"># ...find the snakefile...</span>
    <span class="c1"># ...find the config file...</span>
    <span class="c1"># ...find the params file...</span>
    <span class="c1"># </span>

    <span class="n">target</span> <span class="o">=</span> <span class="n">workflow_info</span><span class="p">[</span><span class="s1">&#39;workflow_target&#39;</span><span class="p">]</span>
    <span class="n">config</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;details!&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">snakefile: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">snakefile</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">config: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">workflowfile</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">params: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">paramsfile</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">target: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------&#39;</span><span class="p">)</span>

    <span class="c1"># run!!</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">snakemake</span><span class="o">.</span><span class="n">snakemake</span><span class="p">(</span><span class="n">snakefile</span><span class="p">,</span> 
                                 <span class="n">configfile</span><span class="o">=</span><span class="n">paramsfile</span><span class="p">,</span>
                                 <span class="n">targets</span><span class="o">=</span><span class="p">[</span><span class="n">target</span><span class="p">],</span> 
                                 <span class="n">printshellcmds</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                 <span class="n">dryrun</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">dry_run</span><span class="p">,</span> 
                                 <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">status</span><span class="p">:</span> <span class="c1"># translate &quot;success&quot; into shell exit code of 0</span>
       <span class="k">return</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="mi">1</span>
</pre></div>


<p>This call uses the provided parameters file to set
the Snakemake configuration dictionary, but this can
be overridden with the <code>config</code> dictionary.
Additional argparser flags can be added, and the
<code>config</code> dictionary contents modified based on
the flags.</p>
<p><a name="2019"></a></p>
<h2 id="2019-snakemake-cli">2019-snakemake-cli</h2>
<p>We wanted to take this demo a step further, and add
a few things to it:</p>
<ul>
<li>
<p>Bundle the Snakefile and command line utility as an
  installable Python package with a <code>setup.py</code></p>
</li>
<li>
<p>Implement Travis CI tests of the Snakemake workflow.</p>
</li>
</ul>
<p>We implemented a bundled Snakemake workflow as a 
command line tool called <code>bananas</code>.</p>
<p><a name="exe"></a></p>
<h1 id="turning-executables-into-packages">Turning Executables into Packages</h1>
<p>We began with an executable script <code>run</code> and wished
to turn it into an installable command line utility
called <code>bananas</code>.</p>
<p>To do this, we moved the contents of <code>run</code> into 
a new file <code>command.py</code> in a new Python module 
called <code>cli</code>:</p>
<div class="highlight"><pre><span></span>cli/
├── Snakefile
├── __init__.py
└── command.py
</pre></div>


<p>The <code>Snakefile</code> will contain the workflow. Here is the
very simple workflow from <a href="https://github.com/ctb/2018-snakemake-cli">ctb/2018-snakemake-cli</a>.
The named rules are specified by the workflow configuration
file, while the parameters in <code>{}</code> are provided through
the parameters file (or via command line flags).</p>
<p><code>cli/Snakefile</code>:</p>
<div class="highlight"><pre><span></span><span class="n">name</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>

<span class="k">rule</span> <span class="n">rulename1</span><span class="p">:</span>
     <span class="k">input</span><span class="p">:</span>
        <span class="ss">&quot;hello.txt&quot;</span>

<span class="k">rule</span> <span class="n">target1</span><span class="p">:</span>
     <span class="k">output</span><span class="p">:</span>
        <span class="ss">&quot;hello.txt&quot;</span>
     <span class="n">shell</span><span class="p">:</span>
        <span class="ss">&quot;echo hello {name} &gt; {output}&quot;</span>

<span class="k">rule</span> <span class="n">target2</span><span class="p">:</span>
     <span class="k">output</span><span class="p">:</span>
        <span class="ss">&quot;goodbye.txt&quot;</span>
     <span class="n">shell</span><span class="p">:</span>
        <span class="ss">&quot;echo goodbye {name} &gt; {output}&quot;</span>
</pre></div>


<p><strong>NOTE:</strong> In this case we are bundling the Snakefile
with the command line wrapper, and writing the command
line wrapper to expect the Snakefile to be in the package.
But we can modify the command line wrapper function
(below) to look for the Snakefile in a local directory,
allowing the user to provide Snakefiles and workflows
to the command line wrapper.</p>
<p>The <code>__init__.py</code> file sets two important parameters:
the name of the command line utility, and the version
number:</p>
<p><code>cli/__init__.py</code>:</p>
<div class="highlight"><pre><span></span><span class="err">_program = &quot;bananas&quot;</span>
<span class="err">__version__ = &quot;0.1.0&quot;</span>
</pre></div>


<p>The contents of <code>command.py</code> are similar to <code>run</code> and
basically control how the command line utility runs:</p>
<p><code>cli/command.py</code>:</p>
<div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Command line interface driver for snakemake workflows</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">snakemake</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">pprint</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">_program</span>


<span class="n">thisdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
<span class="n">parentdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">thisdir</span><span class="p">,</span><span class="s1">&#39;..&#39;</span><span class="p">)</span>
<span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">sysargs</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">prog</span> <span class="o">=</span> <span class="n">_program</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;bananas: run snakemake workflows&#39;</span><span class="p">,</span> <span class="n">usage</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;bananas &lt;workflow&gt; &lt;parameters&gt; [&lt;target&gt;]</span>

<span class="s1">bananas: run snakemake workflows, using the given workflow name &amp; parameters file.</span>

<span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;workflowfile&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;paramsfile&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-n&#39;</span><span class="p">,</span> <span class="s1">&#39;--dry-run&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-f&#39;</span><span class="p">,</span> <span class="s1">&#39;--force&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">sysargs</span><span class="p">)</span>

    <span class="c1"># ...find the Snakefile...</span>
    <span class="c1"># ...find the config file...</span>
    <span class="c1"># ...find the params file...</span>

    <span class="n">target</span> <span class="o">=</span> <span class="n">workflow_info</span><span class="p">[</span><span class="s1">&#39;workflow_target&#39;</span><span class="p">]</span>
    <span class="n">config</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;details!&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">snakefile: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">snakefile</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">config: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">workflowfile</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">params: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">paramsfile</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">target: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------&#39;</span><span class="p">)</span>

    <span class="c1"># run bananas!!</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">snakemake</span><span class="o">.</span><span class="n">snakemake</span><span class="p">(</span><span class="n">snakefile</span><span class="p">,</span> <span class="n">configfile</span><span class="o">=</span><span class="n">paramsfile</span><span class="p">,</span>
                                 <span class="n">targets</span><span class="o">=</span><span class="p">[</span><span class="n">target</span><span class="p">],</span> <span class="n">printshellcmds</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                 <span class="n">dryrun</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">dry_run</span><span class="p">,</span> <span class="n">forceall</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">force</span><span class="p">,</span>
                                 <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">status</span><span class="p">:</span> <span class="c1"># translate &quot;success&quot; into shell exit code of 0</span>
       <span class="k">return</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="mi">1</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>


<p>The last component here is to make the function
in <code>cli/command.py</code> the entrypoint of a command line
utility called <code>bananas</code>, which can be done via
<code>setup.py</code>. This will put the executable <code>bananas</code>
in the Python binaries folder when the package is
installed.</p>
<p><code>setup.py</code>:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">setuptools</span> <span class="kn">import</span> <span class="n">setup</span><span class="p">,</span> <span class="n">find_packages</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;requirements.txt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">required</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">)]</span>

<span class="c1"># Note: the _program variable is set in __init__.py.</span>
<span class="c1"># it determines the name of the package/final command line tool.</span>
<span class="kn">from</span> <span class="nn">cli</span> <span class="kn">import</span> <span class="n">__version__</span><span class="p">,</span> <span class="n">_program</span>

<span class="n">setup</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;bananas&#39;</span><span class="p">,</span>
      <span class="n">version</span><span class="o">=</span><span class="n">__version__</span><span class="p">,</span>
      <span class="n">packages</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cli&#39;</span><span class="p">],</span>
      <span class="n">test_suite</span><span class="o">=</span><span class="s1">&#39;pytest.collector&#39;</span><span class="p">,</span>
      <span class="n">tests_require</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;pytest&#39;</span><span class="p">],</span>
      <span class="n">description</span><span class="o">=</span><span class="s1">&#39;bananas command line interface&#39;</span><span class="p">,</span>
      <span class="n">url</span><span class="o">=</span><span class="s1">&#39;https://charlesreid1.github.io/2019-snakemake-cli&#39;</span><span class="p">,</span>
      <span class="n">author</span><span class="o">=</span><span class="s1">&#39;@charlesreid1&#39;</span><span class="p">,</span>
      <span class="n">author_email</span><span class="o">=</span><span class="s1">&#39;cmreid@ucdavis.edu&#39;</span><span class="p">,</span>
      <span class="n">license</span><span class="o">=</span><span class="s1">&#39;MIT&#39;</span><span class="p">,</span>
      <span class="n">entry_points</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">      [console_scripts]</span>
<span class="s2">      </span><span class="si">{program}</span><span class="s2"> = cli.command:main</span>
<span class="s2">      &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">program</span> <span class="o">=</span> <span class="n">_program</span><span class="p">),</span>
      <span class="n">install_requires</span><span class="o">=</span><span class="n">required</span><span class="p">,</span>
      <span class="n">include_package_data</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
      <span class="n">keywords</span><span class="o">=</span><span class="p">[],</span>
      <span class="n">zip_safe</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>


<p>First, we grab the variables from <code>__init__.py</code>:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">cli</span> <span class="kn">import</span> <span class="n">__version__</span><span class="p">,</span> <span class="n">_program</span>
</pre></div>


<p>Next we specify where our package lives, the <code>cli</code> directory:</p>
<div class="highlight"><pre><span></span><span class="n">setup</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;bananas&#39;</span><span class="p">,</span>
        <span class="o">...</span>
        <span class="n">packages</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cli&#39;</span><span class="p">],</span>
</pre></div>


<p>and finally, we specify that we want to build a command line 
interface, with the entrypoint being the <code>main()</code> method of the
<code>cli/command.py</code> file using <code>entry_points</code>:</p>
<div class="highlight"><pre><span></span><span class="n">setup</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;bananas&#39;</span><span class="p">,</span>
        <span class="o">...</span>
        <span class="n">entry_points</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">[console_scripts]</span>
<span class="si">{program}</span><span class="s2"> = cli.command:main</span>
<span class="s2">      &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">program</span> <span class="o">=</span> <span class="n">_program</span><span class="p">),</span>
</pre></div>


<p><a name="using"></a></p>
<h1 id="end-result-using-bananas">End Result: Using bananas</h1>
<p>The end result is a command line utility that bundles a
Snakemake workflow. The repository contains some tests,
so let's run through the quick start installation and
run the tests.</p>
<h2 id="quick-start-installing">Quick Start: Installing</h2>
<p>Start by setting up a virtual environment:</p>
<div class="highlight"><pre><span></span>virtualenv vp
<span class="nb">source</span> vp/bin/activate
</pre></div>


<p>Install required components, then install the package:</p>
<div class="highlight"><pre><span></span>pip install -r requirements.txt
python setup.py build install
</pre></div>


<p>Now you should see <code>bananas</code> on your path:</p>
<div class="highlight"><pre><span></span><span class="err">which bananas</span>
</pre></div>


<h2 id="quick-start-running-tests">Quick Start: Running Tests</h2>
<div class="highlight"><pre><span></span><span class="err">pytest</span>
</pre></div>


<h2 id="quick-start-running-examples">Quick Start: Running Examples</h2>
<p>Change to the <code>test/</code> directory and run tests with
the example config and param files.</p>
<div class="highlight"><pre><span></span><span class="err">cd test</span>
</pre></div>


<p>Run the hello workflow with Amy params:</p>
<div class="highlight"><pre><span></span><span class="err">rm -f hello.txt</span>
<span class="err">bananas workflow-hello params-amy</span>
</pre></div>


<p>Run the hello workflow with Beth params:</p>
<div class="highlight"><pre><span></span><span class="err">rm -f hello.txt</span>
<span class="err">bananas workflow-hello params-beth</span>
</pre></div>


<p>Run the goodbye workflow with Beth params:</p>
<div class="highlight"><pre><span></span><span class="err">rm -f goodbye.txt</span>
<span class="err">bananas workflow-goodbye params-beth</span>
</pre></div>


<p><a name="travis"></a></p>
<h1 id="adding-travis-ci-tests">Adding Travis CI Tests</h1>
<p>To test or workflow, we break down the necessary tasks:</p>
<ul>
<li>Use a Python environment</li>
<li>Install our requirements (snakemake)</li>
<li>Install bananas with setup.py</li>
<li>Run pytest</li>
</ul>
<p>This is an easy Travis file to write, following the
<a href="https://docs.travis-ci.com/user/languages/python/">Travis docs</a>.</p>
<p><code>.travis.yml</code>:</p>
<div class="highlight"><pre><span></span><span class="nt">language</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">python</span>
<span class="nt">python</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="s">&quot;3.5&quot;</span>
  <span class="p p-Indicator">-</span> <span class="s">&quot;3.6&quot;</span>
  <span class="c1">#- &quot;3.7-dev&quot; # fails due to datrie build failure (snakemake dependency)</span>

<span class="c1"># command to install dependencies</span>
<span class="nt">install</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">pip install -r requirements.txt</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">python setup.py build install</span>

<span class="c1"># command to run tests</span>
<span class="nt">script</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">pytest</span>
</pre></div>


<p><a name="repo"></a></p>
<h1 id="final-repository">Final Repository</h1>
<p>All of the code for this repository is in
<a href="https://github.com/charlesreid1/2019-snakemake-cli">charlesreid1/2019-snakemake-cli</a>.</p>
<p>See the <a href="https://github.com/charlesreid1/2019-snakemake-cli/releases/tag/v2.0">v2.0 tag</a>
in case there are changes to the code that are not reflected in
this blog post.</p>
<p><a name="next"></a></p>
<h1 id="next-steps">Next Steps</h1>
<p>This demo provides a starting point for creating executable Snakemake
workflows that are installable.</p>
<p>A few open question and directions:</p>
<ul>
<li>
<p>Bundling the Snakefile vs. user-provided Snakefles</p>
<ul>
<li>There is obviously more utility and flexibility in letting the user provide Snakefiles.</li>
<li>User-provided Snakefiles provide more ways for workflows to go wrong.</li>
<li>Testing is either more difficult, or shifted to the workflow author.</li>
<li>Bundled Snakefiles take the burden of writing the workflow off of the user,
  so they can focus on param/config files.</li>
</ul>
</li>
<li>
<p>Kubernetes</p>
<ul>
<li>Can we make the command line wrapper work with a Kubernetes cluster?</li>
<li>See <a href="https://github.com/charlesreid1/2019-snakemake-byok8s">charlesreid1/2019-snakemake-byok8s</a>
  for proof of concept.</li>
</ul>
</li>
<li>
<p>Applications</p>
<ul>
<li>How can we apply this concept?</li>
<li><a href="https://github.com/spacegraphcats/spacegraphcats">spacegraphcats</a></li>
<li><a href="https://github.com/dib-lab/eelpond">eelpond</a></li>
<li><a href="https://github.com/dahak-metagenomics/dahak">dahak</a> and 
  <a href="https://github.com/dahak-metagenomics/dahak-taco">dahak-taco</a> </li>
</ul>
</li>
</ul></div>

    </div>
</div>

<div class="v20"></div>

<div class="row">
    <div class="col-md-12" style="text-align: left;">

        <div class="tags">
            <p>Tags:&nbsp;&nbsp;&nbsp;
                    <a href="http://localhost:8000/tag/python.html">python</a>
                    &nbsp;&nbsp;
                    <a href="http://localhost:8000/tag/bioinformatics.html">bioinformatics</a>
                    &nbsp;&nbsp;
                    <a href="http://localhost:8000/tag/workflows.html">workflows</a>
                    &nbsp;&nbsp;
                    <a href="http://localhost:8000/tag/pipelines.html">pipelines</a>
                    &nbsp;&nbsp;
                    <a href="http://localhost:8000/tag/snakemake.html">snakemake</a>
                    &nbsp;&nbsp;
                    <a href="http://localhost:8000/tag/travis.html">travis</a>
                    &nbsp;&nbsp;
        </div>

    </div>
</div>


<div class="v200"></div>

</div>


<script type="text/javascript" src="http://localhost:8000/theme/js/jquery-1.11.2.js"></script>
<script type="text/javascript" src="http://localhost:8000/theme/js/bootstrap-3.3.4.js"></script>
<script type="text/javascript" src="http://localhost:8000/theme/js/d3-3.5.5.js"></script><script type="text/javascript" src="http://localhost:8000/theme/js/jquery-1.11.2.js"></script>
<script type="text/javascript" src="http://localhost:8000/theme/js/bootstrap-3.3.4.js"></script>

<footer id="contentinfo" class="body">
<p>&nbsp;</p>
<p>&nbsp;</p>
<center>
	<hr />
</center>
<p>&nbsp;</p>
<p style="text-align: center">
    <span class="fa-stack fa-lg">
        <i class="fa fa-square fa-stack-2x" style="color:#000;"></i>
        <i class="fa fa-terminal fa-stack-1x fa-inverse"></i>
    </span>
    Made from the command line with vim by 
    <a href="http://charlesreid1.com">charlesreid1</a><br />
    with help from <a href="https://getbootstrap.com/">Bootstrap</a> and <a href="http://getpelican.com">Pelican</a>.
</p>

<br />

<p style="text-align: center">
    <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">
    <span class="fa-stack fa-lg">
        <i class="fa fa-square fa-stack-2x" style="color:#000;"></i>
        <i class="fa fa-creative-commons fa-stack-1x fa-inverse"></i>
    </span>
    </a>
    <br />
    Licensed under the <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">Creative Commons Attribution-NonCommercial 4.0 License</a>.
</p>

<!-- Start of StatCounter Code for Default Guide -->
<script type="text/javascript">
var sc_project=11611748;
var sc_invisible=1;
var sc_security="9fcba820";
</script>
<script type="text/javascript"
src="https://www.statcounter.com/counter/counter.js"
async></script>

<noscript><div class="statcounter"><a title="Web Analytics"
href="http://statcounter.com/" target="_blank"><img
class="statcounter"
src="//c.statcounter.com/11611748/0/9fcba820/1/" alt="Web
Analytics"></a></div></noscript>
<!-- End of StatCounter Code for Default Guide -->
</footer><!-- /#contentinfo -->
</body>
</html>