<!DOCTYPE html>
<html lang="en">
<head>
        <title>charlesreid1</title>
        <meta charset="utf-8" />

        <!--
        CSS styles
        -->
        <link href="https://charlesreid1.github.io/theme/css/bootstrap.css"       rel="stylesheet" type="text/css">
        <link href="https://charlesreid1.github.io/theme/css/slate.css"              rel="stylesheet" type="text/css">
        <link href="https://charlesreid1.github.io/theme/css/font-awesome.css"       rel="stylesheet" type="text/css"/>
        <link href="https://charlesreid1.github.io/theme/css/pygment-solarized.css"  rel="stylesheet" type="text/css"/>

        <!--
        my CSS styles
        -->
        <link href="https://charlesreid1.github.io/theme/css/main.css"            rel="stylesheet" type="text/css">
        <link href="https://charlesreid1.github.io/theme/css/dox.css"             rel="stylesheet" type="text/css">


        <!--
        include Angular first
        -->
        <script type="text/javascript" src="https://charlesreid1.github.io/theme/js/angular-1.3.15.js"></script>
        <script type="text/javascript" src="https://charlesreid1.github.io/theme/js/skrollr-0.6.29.js"></script>
        <script type="text/javascript" src="https://charlesreid1.github.io/theme/js/d3-3.5.5.js"></script>

        <!--
        this seems like a bad idea.
        but if I don't put jquery first, I get errors about unrecognized $s.
        -->
        <script type="text/javascript" src="https://charlesreid1.github.io/theme/js/jquery-1.11.2.js"></script>

</head>
<body id="index">
<nav class="navbar navbar-default">
    <div class="container-fluid">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span> 
            </button>
            <a href="https://charlesreid1.github.io" class="navbar-brand">charlesreid1.github.io</a>
        </div>
        <div>
            <div class="collapse navbar-collapse" id="myNavbar">
                <ul class="nav navbar-nav">

                    <li>
                        <a href="https://charlesreid1.com/wiki">Wiki</a>
                    </li>
                    <li>
                        <a href="https://git.charlesreid1.com/explore">Git</a>
                    </li>
                    <li>
                        <a href="http://spotify.charlesreid1.com">Music</a>
                    </li>
                    <li>
                        <a href="https://charlesreid1.com/life">Life</a>
                    </li>
                    <li>
                        <a href="https://charlesreid1.github.io">Blog</a>
                    </li>
                    <li>
                        <a href="https://charlesreid1.com/about">About Me</a>
                    </li>

                </ul>
            </div>
        </div>
    </div>
</nav>



<div class="container">

<header>
<div class="row">


    <div class="col-md-12">
        <div class="headtext" style="text-align: center;">
            <h1><b>
                Building Snakemake Command Line Wrappers for Kubernetes Workflows
            </b></h1>
        
            <p class="lead">
                Posted 
                <time datetime="2019-01-28T20:00:00-08:00" pubdate>Monday 01/28/2019</time>
                in 
                <a href="https://charlesreid1.github.io/category/snakemake.html">Snakemake</a>
                </p>
            <p>
            <span style="font-size: 14px">
                <a href="https://charlesreid1.github.io/building-snakemake-command-line-wrappers-for-kubernetes-workflows.html">permalink</a>
            </span>
            </p>
        </div>

    </div>

</div>
</header>


<div class="v50"></div>


<div class="row">
    <div class="col-md-12" style="text-align: left;">

        <div class="entry-content"><p><strong>NOTE:</strong> These ideas are implemented in the repository
<a href="https://github.com/charlesreid/2019-snakemake-byok8s">charlesreid1/2019-snakemake-byok8s</a>.</p>
<p><br />
<br /></p>
<h2>Table of Contents:</h2>
<ul>
<li><a href="#exe">Recap: Workflows as Executables</a><ul>
<li><a href="#2018">2018-snakemake-cli</a></li>
<li><a href="#2019">2019-snakemake-cli</a></li>
<li><a href="#byok8s">2019-snakemake-byok8s</a></li>
</ul>
</li>
<li><a href="#byok8s2">Overview of 2019-snakemake-byok8s</a><ul>
<li><a href="#k8s">Cloud + Scale = Kubernetes</a></li>
<li><a href="#smkk8s">Snakemake k8s support</a></li>
</ul>
</li>
<li><a href="#cli">Modifying the CLI</a><ul>
<li><a href="#ns">Namespaces</a></li>
<li><a href="#flags">Adding flags</a></li>
</ul>
</li>
<li><a href="#minikube">Local Kubernetes Clusters with Minikube</a><ul>
<li><a href="#minikube">What is minikube?</a></li>
<li><a href="#aws">AWS</a></li>
<li><a href="#dns-aws">Fixing DNS issues with AWS</a></li>
<li><a href="#travis">Travis</a></li>
<li><a href="#travis-yml"><code>.travis.yml</code></a></li>
</ul>
</li>
<li><a href="#byok8s3">End Product: byok8s</a></li>
<li><a href="#docs">Documentation</a></li>
<li><a href="#next">Next Steps</a></li>
</ul>
<p><br />
<br /></p>
<p><a name="exe"></a></p>
<h1>Recap: Workflows as Executables</h1>
<p>In our previous blog post, <a href="https://charlesreid1.github.io/building-snakemake-command-line-wrappers.html">Building Snakemake Command Line Wrappers</a>,
we covered some approaches to making Snakemake
workflows into executables that can be run as
command line utilities.</p>
<p>In this post, we extend those ideas to Snakemake workflows
that run on Kubernetes clusters.</p>
<p><a name="2018"></a></p>
<h2>2018-snakemake-cli</h2>
<p>To recap, back in March 2018 Titus Brown wrote a blog post titled
<a href="http://ivory.idyll.org/blog/2018-workflows-applications.html">Pydoit, snakemake, and workflows-as-applications</a>
in which he implemented a proof-of-concept command
line utility wrapping the Snakemake API to create
an executable Snakemake workflow.</p>
<p>The end result was a command line utility that could
be run like so:</p>
<div class="highlight"><pre><span></span><span class="p">.</span><span class="o">/</span><span class="n">run</span> <span class="o">&lt;</span><span class="n">workflow</span><span class="o">-</span><span class="n">config</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">workflow</span><span class="o">-</span><span class="n">params</span><span class="o">&gt;</span>
</pre></div>


<p>Relevant code is in <a href="https://github.com/ctb/2018-snakemake-cli">ctb/2018-snakemake-cli</a>.</p>
<p><a name="2019"></a></p>
<h2>2019-snakemake-cli</h2>
<p>In our previous blog post, <a href="https://charlesreid1.github.io/building-snakemake-command-line-wrappers.html">Building Snakemake Command Line Wrappers</a>,
we extended this idea to create a bundled executable
command line utility that could be installed with
<code>setup.py</code> and run from a working directory. We also
demonstrated a method of writing tests for the 
Snakemake workflow and running those tests with
Travis CI.</p>
<p>We packaged the Snakefile with the command line utility,
but the approach is flexible and can be modified to
use a user-provided Snakemake workflow or Snakefile.</p>
<p>The end result was a command line utility called
<code>bananas</code> that could be installed and run like
the <code>run</code> wrapper above:</p>
<div class="highlight"><pre><span></span><span class="n">bananas</span> <span class="o">&lt;</span><span class="n">workflow</span><span class="o">-</span><span class="n">config</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">workflow</span><span class="o">-</span><span class="n">params</span><span class="o">&gt;</span>
</pre></div>


<p>Relevant code is in <a href="https://github.com/charlesreid1/2019-snakemake-cli">charlesreid1/2019-snakemake-cli</a>.</p>
<p><a name="byok8s"></a></p>
<h2>2019-snakemake-byok8s</h2>
<p>The next logical step in bundling workflows was to take
advantage of Snakemake's ability to run workflows across
distributed systems.</p>
<p>Specifically, we wanted to modify the command line utility
above to run the workflow on a user-provided Kubernetes
cluster, instead of running the workflow locally.</p>
<p>The result is <a href="https://github.com/charlesreid1/2019-snakemake-byok8s">2019-snakemake-byok8s</a>,
a command line utility that can be installed with
a <code>setup.py</code> and that launches a Snakemake workflow 
on a user-provided Kubernetes cluster. Furthermore,
we demonstrate how to use minikube to run a local
Kubernetes cluster to test Snakemake workflows on
Kubernetes clusters.</p>
<p>Here's what it looks like in practice:</p>
<div class="highlight"><pre><span></span><span class="o">#</span> <span class="k">Get</span> <span class="n">byok8s</span>
<span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">charlesreid1</span><span class="o">/</span><span class="mi">2019</span><span class="o">-</span><span class="n">snakemake</span><span class="o">-</span><span class="n">byok8s</span><span class="p">.</span><span class="n">git</span>
<span class="n">cd</span> <span class="o">~/</span><span class="mi">2019</span><span class="o">-</span><span class="n">snakemake</span><span class="o">-</span><span class="n">byok8s</span>

<span class="o">#</span> <span class="k">Create</span> <span class="n">a</span> <span class="n">virtual</span> <span class="n">environment</span>
<span class="n">virtualenv</span> <span class="n">vp</span>
<span class="n">vp</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">actiavte</span>

<span class="o">#</span> <span class="n">Install</span> <span class="n">byok8s</span>
<span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">r</span> <span class="n">requirements</span><span class="p">.</span><span class="n">txt</span>
<span class="n">python</span> <span class="n">setup</span><span class="p">.</span><span class="n">py</span> <span class="n">build</span> <span class="n">install</span>

<span class="o">#</span> <span class="k">Create</span> <span class="n">virtual</span> <span class="n">k8s</span> <span class="k">cluster</span>
<span class="n">minikube</span> <span class="k">start</span>

<span class="o">#</span> <span class="n">Run</span> <span class="n">the</span> <span class="n">workflow</span> <span class="k">on</span> <span class="n">the</span> <span class="n">k8s</span> <span class="k">cluster</span>
<span class="n">cd</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="k">to</span><span class="o">/</span><span class="n">workflow</span><span class="o">/</span>
<span class="n">byok8s</span> <span class="n">my</span><span class="o">-</span><span class="n">workflowfile</span> <span class="n">my</span><span class="o">-</span><span class="n">paramsfile</span> <span class="c1">--s3-bucket=my-bucket</span>

<span class="o">#</span> <span class="n">Clean</span> <span class="n">up</span> <span class="n">the</span> <span class="n">virtual</span> <span class="n">k8s</span> <span class="k">cluster</span>
<span class="n">minikube</span> <span class="n">stop</span>
</pre></div>


<p>We cover the details below.</p>
<p><br />
<br /></p>
<p><a name="byok8s2"></a></p>
<h1>Overview of 2019-snakemake-byok8s</h1>
<p><a name="k8s"></a></p>
<h2>Cloud + Scale = Kubernetes (k8s)</h2>
<p>First, why kubernetes (k8s)?</p>
<p>To scale Snakemake workflows to multiple compute nodes,
it is not enough to just give Snakemake a pile of
compute nodes and a way to remotely connect to each.
Snakemake requires the compute nodes to have a 
controller and a job submission system.</p>
<p>When using cloud computing platforms like GCP (Google 
Cloud Platform) or AWS (Amazon Web Services),
k8s is a simple and popular way to orchestrate
multiple compute nodes (support for Docker images
is also baked directly into k8s).</p>
<p><a name="smkk8s"></a></p>
<h2>Snakemake k8s Support</h2>
<p>Snakemake has built-in support for k8s, making
the combination a logical choice for running 
Snakemake workflows at scale in the cloud. </p>
<p>The <code>minikube</code> tool, which we will cover later
in this blog post, makes it easy to run a local
virtual k8s cluster for testing purposes, and
even makes it possible to run k8s tests using
Travis CI.</p>
<p>Snakemake only requires the <code>--kubernetes</code> flag,
and an optional namespace, to connect to
the k8s cluster. (Under the hood, Snakemake
uses the Kubernetes Python API to connect
to the cluster and launch jobs.)</p>
<p>If you can run <code>kubectl</code> from a computer
to control the Kubernetes cluster, you can
run a Snakemake workflow on that cluster.</p>
<p>Let's get into the changes required in the Python code.</p>
<p><br />
<br /></p>
<p><a name="cli"></a></p>
<h1>Modifying the CLI</h1>
<p>In our <a href="https://charlesreid1.github.io/building-snakemake-command-line-wrappers.html">prior post</a>
covering <a href="https://github.com/charlesreid1/2019-snakemake-cli">charlesreid1/2019-snakemake-cli</a>,
we showed how to create a command line utility
using the <code>cli/</code> directory for the command line
interface package, and specifying it is a cli
entrypoint in <code>setup.py</code>:</p>
<div class="highlight"><pre><span></span><span class="n">cli</span><span class="o">/</span>
<span class="err">├──</span> <span class="n">Snakefile</span>
<span class="err">├──</span> <span class="n">__init__</span><span class="p">.</span><span class="n">py</span>
<span class="err">└──</span> <span class="n">command</span><span class="p">.</span><span class="n">py</span>
</pre></div>


<p>and the relevant bit from <code>setup.py</code>:</p>
<div class="highlight"><pre><span></span><span class="n">setup</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;bananas&#39;</span><span class="p">,</span>
        <span class="o">...</span>
        <span class="n">entry_points</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">[console_scripts]</span>
<span class="s2">{program} = cli.command:main</span>
<span class="s2">      &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">program</span> <span class="o">=</span> <span class="n">_program</span><span class="p">),</span>
</pre></div>


<p>We want our new command line utility, <code>byok8s</code>, to work
the same way, so we can do a <code>s/byok8s/bananas/g</code>
across the package.</p>
<p>The only change required happens in the file
<code>command.py</code>, where the Snakemake API call 
happens.</p>
<p><a name="ns"></a></p>
<h2>Namespaces</h2>
<p>Checking the <a href="https://snakemake.readthedocs.io/en/stable/api_reference/snakemake.html">Snakemake API documentation</a>,
we can see that the API has a <code>kubernetes</code> option:</p>
<blockquote>
<p><strong>kubernetes</strong> <em>(str)</em> – submit jobs to kubernetes,
using the given namespace.</p>
</blockquote>
<p>so <code>command.py</code> should modify the Snakmake API call
accordingly, adding a kubernetes namespace.
This is a parameter the user usually won't need
to provide (<code>default</code> is the typical namespace
we want to use) but we added a <code>-k</code> argument
to the ArgParser to allow the user to specify
the Kubernetes namespace name. By default
the Kubernetes namespace used is <code>default</code>.</p>
<p><a name="flags"></a></p>
<h2>Adding flags</h2>
<p>We add and modify some flags to make the workflow
more flexible:</p>
<ul>
<li>
<p>The user now provides the Snakefile, which is
  called <code>Snakefile</code> in the current working directory
  by default but can be specified with the <code>--snakefile</code>
  or <code>-s</code> flag</p>
</li>
<li>
<p>The user provides the k8s namespace using the
  <code>--k8s-namespace</code> or <code>-k</code> flag</p>
</li>
<li>
<p>The user provides the name of an S3 bucket for
  Snakemake worker nodes to use for I/O using the
  <code>--s3-bucket</code> flag</p>
</li>
</ul>
<p>Finally, the user is also required to provide their
AWS credentials to access the S3 bucket, via two
environment variables that Snakemake passes through
to the Kubernetes worker nodes:</p>
<div class="highlight"><pre><span></span><span class="n">AWS_ACCESS_KEY_ID</span>
<span class="n">AWS_SECRET_ACCESS_KEY</span>
</pre></div>


<p>For Travis CI testing, these environment variables
can be set in the repository settings on the Travis
website once Travis CI has been enabled.</p>
<p>See <a href="https://charlesreid1.github.io/2019-snakemake-byok8s/travis_tests/">https://charlesreid1.github.io/2019-snakemake-byok8s/travis_tests/</a>
for details.</p>
<p><br />
<br /></p>
<p><a name="minikube"></a></p>
<h1>Local Kubernetes Clusters with Minikube</h1>
<p><a name="minikube"></a></p>
<h2>What is minikube?</h2>
<p>Minikube is a Go program that allows users to simulate
a single-node kubernetes cluster using a virtual machine.
This is useful for local testing of Kubernetes workflows,
as it does not require setting up or tearing down cloud
infrastructure, or long waits for remote resources to
become ready.</p>
<p>We cover two ways to use it:</p>
<ol>
<li>
<p>Installing and running a minikube virtual kubernetes cluster on
   AWS (for development and testing of Snakemake + kubernetes
   workflows)</p>
</li>
<li>
<p>Running a minikube cluster on a Travis CI worker node
   to enable us to <em>test</em> Snakemake + kubernetes workflows.</p>
</li>
</ol>
<p><a name="aws"></a></p>
<h2>AWS</h2>
<p>Using Minikube from an AWS EC2 compute node comes 
with two hangups.</p>
<p>The first is that AWS nodes are virtual machines,
and you can't run virtual machines within virtual
machines, so it is not possible to use minikube's
normal VirtualBox mode, which creates a kubernetes
cluster using a virutal machine.</p>
<p>Instead, we must use minikube's native driver, meaning
minikube uses docker directly. This is tricky for several
reasons:</p>
<ul>
<li>we can't bind-mount a local directory into the
  kubernetes cluster</li>
<li>the minikube cluster must be run with sudo
  privileges, which means permissions can be
  a problem</li>
</ul>
<p>The second hangup with minikube on AWS nodes is that the
DNS settings of AWS nodes are copied into the Kubernetes
containers, including the kubernetes system's DNS service
container. Unfortunately, the AWS node's DNS settings are
not valid in the kubernetes cluster, so the DNS container
crashes, and no container in the kubernetes cluster can
reach the outside world.  This must be fixed with a
custom config file (provided with byok8s; details below).</p>
<h3>Installing Python Prerequisites</h3>
<p>To use byok8s from a fresh Ubuntu AWS node
(tested with Ubuntu 16.04 (xenial) and 18.04
(bionic)), you will want to install a version
of conda; we recommend using pyenv and miniconda:</p>
<div class="highlight"><pre><span></span><span class="n">curl</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">pyenv</span><span class="p">.</span><span class="n">run</span> <span class="o">|</span> <span class="n">bash</span>
</pre></div>


<p>Restart your shell and install miniconda:</p>
<div class="highlight"><pre><span></span><span class="n">pyenv</span> <span class="k">update</span>
<span class="n">pyenv</span> <span class="n">install</span> <span class="n">miniconda3</span><span class="o">-</span><span class="mi">4</span><span class="p">.</span><span class="mi">3</span><span class="p">.</span><span class="mi">30</span>
<span class="n">pyenv</span> <span class="k">global</span> <span class="n">miniconda3</span><span class="o">-</span><span class="mi">4</span><span class="p">.</span><span class="mi">3</span><span class="p">.</span><span class="mi">30</span>
</pre></div>


<p>You will also need the virtualenv package to
set up a virtual environment:</p>
<div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="n">virtualenv</span>
</pre></div>


<h3>Installing byok8s</h3>
<p>Start by cloning the repo and installing byok8s:</p>
<div class="highlight"><pre><span></span><span class="n">cd</span> 
<span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">charlesreid1</span><span class="o">/</span><span class="mi">2019</span><span class="o">-</span><span class="n">snakemake</span><span class="o">-</span><span class="n">byok8s</span><span class="p">.</span><span class="n">git</span>
<span class="n">cd</span> <span class="o">~/</span><span class="mi">2019</span><span class="o">-</span><span class="n">snakemake</span><span class="o">-</span><span class="n">byok8s</span>
</pre></div>


<p>Next, you'll create a virtual environment:</p>
<div class="highlight"><pre><span></span><span class="n">virtualenv</span> <span class="n">vp</span>
<span class="k">source</span> <span class="n">vp</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">activate</span>

<span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">r</span> <span class="n">requirements</span><span class="p">.</span><span class="n">txt</span>
<span class="n">python</span> <span class="n">setup</span><span class="p">.</span><span class="n">py</span> <span class="n">build</span> <span class="n">install</span>
</pre></div>


<p>Now you should be ready to rock:</p>
<div class="highlight"><pre><span></span><span class="n">which</span> <span class="n">byok8s</span>
</pre></div>


<h3>Starting a k8s cluster with minikube</h3>
<p>Install minikube:</p>
<div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">LO</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="k">storage</span><span class="p">.</span><span class="n">googleapis</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">minikube</span><span class="o">/</span><span class="n">releases</span><span class="o">/</span><span class="n">latest</span><span class="o">/</span><span class="n">minikube</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">amd64</span> <span class="err">\</span>
  <span class="o">&amp;&amp;</span> <span class="n">sudo</span> <span class="n">install</span> <span class="n">minikube</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">amd64</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="k">local</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">minikube</span>
</pre></div>


<p>Now you're ready to start a minikube k8s
cluster on your AWS node! Start a k8s cluster
as root with:</p>
<div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">minikube</span> <span class="k">start</span>
</pre></div>


<p><strong>NOTE:</strong> The <code>minikube start</code> command will print
some commands for you to run to fix permissions -
it is importat you run them!</p>
<p>Tear down the cluster with:</p>
<div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">minikube</span> <span class="n">stop</span>
</pre></div>


<p>While the k8s cluster is running, you can control
it and interact with it like a normal k8s cluster
using <code>kubectl</code>.</p>
<p>However, as-is, the cluster's DNS settings are broken!
We need to fix them before running.</p>
<p><a name="dns-aws"></a></p>
<h2>Fixing DNS issues with AWS</h2>
<p>We mentioned a second hangup with AWS was with the
DNS settings. </p>
<p>The problem is with <code>/etc/resolv.conf</code> on the
AWS host node. It is set up for AWS's internal 
cloud network routing, but this is copied
into the CoreDNS container, which is the
kube-system container that manages DNS requests
from all k8s containers. The settings from the
AWS host confuse the DNS container, and it cannot
route any DNS requests.</p>
<h3>The Problem</h3>
<p>If you're having the problem, you will see
something like this with <code>kubectl</code>, where the
coredns containers are in a <code>CrashLoopBackOff</code>:</p>
<div class="highlight"><pre><span></span>$ kubectl get pods --namespace<span class="o">=</span>kube-system

NAME                               READY   STATUS             RESTARTS   AGE
coredns-86c58d9df4-lvq8b           <span class="m">0</span>/1     CrashLoopBackOff   <span class="m">5</span>          5m17s
coredns-86c58d9df4-pr52t           <span class="m">0</span>/1     CrashLoopBackOff   <span class="m">5</span>          5m17s
etcd-minikube                      <span class="m">1</span>/1     Running            <span class="m">15</span>         4h43m
kube-addon-manager-minikube        <span class="m">1</span>/1     Running            <span class="m">16</span>         4h43m
kube-apiserver-minikube            <span class="m">1</span>/1     Running            <span class="m">15</span>         4h43m
kube-controller-manager-minikube   <span class="m">1</span>/1     Running            <span class="m">15</span>         4h43m
kube-proxy-sq77h                   <span class="m">1</span>/1     Running            <span class="m">3</span>          4h44m
kube-scheduler-minikube            <span class="m">1</span>/1     Running            <span class="m">15</span>         4h43m
storage-provisioner                <span class="m">1</span>/1     Running            <span class="m">6</span>          4h44m
</pre></div>


<p>This will cause all Snakemake jobs to fail with a name
resolution failure when it tries to write its output
files to the AWS S3 bucket:</p>
<div class="highlight"><pre><span></span>$ <span class="nv">kubectl</span> <span class="nv">logs</span> <span class="nv">snakejob</span><span class="o">-</span><span class="nv">c71fba38</span><span class="o">-</span><span class="nv">f64b</span><span class="o">-</span><span class="mi">5803</span><span class="o">-</span><span class="mi">915</span><span class="nv">d</span><span class="o">-</span><span class="mi">933</span><span class="nv">ae273d7a4</span>

<span class="nv">Building</span> <span class="nv">DAG</span> <span class="nv">of</span> <span class="nv">jobs</span>...
<span class="nv">Using</span> <span class="nv">shell</span>: <span class="o">/</span><span class="nv">bin</span><span class="o">/</span><span class="nv">bash</span>
<span class="nv">Provided</span> <span class="nv">cores</span>: <span class="mi">4</span>
<span class="nv">Rules</span> <span class="nv">claiming</span> <span class="nv">more</span> <span class="nv">threads</span> <span class="nv">will</span> <span class="nv">be</span> <span class="nv">scaled</span> <span class="nv">down</span>.
<span class="nv">Job</span> <span class="nv">counts</span>:
    <span class="nv">count</span>   <span class="nv">jobs</span>
    <span class="mi">1</span>   <span class="nv">target1</span>
    <span class="mi">1</span>

[<span class="nv">Thu</span> <span class="nv">Jan</span> <span class="mi">24</span> <span class="mi">00</span>:<span class="mi">06</span>:<span class="mi">03</span> <span class="mi">2019</span>]
<span class="nv">rule</span> <span class="nv">target1</span>:
    <span class="nv">output</span>: <span class="nv">cmr</span><span class="o">-</span><span class="nv">smk</span><span class="o">-</span><span class="mi">0123</span><span class="o">/</span><span class="nv">alpha</span>.<span class="nv">txt</span>
    <span class="nv">jobid</span>: <span class="mi">0</span>

<span class="nv">echo</span> <span class="nv">alpha</span> <span class="nv">blue</span> <span class="o">&gt;</span> <span class="nv">cmr</span><span class="o">-</span><span class="nv">smk</span><span class="o">-</span><span class="mi">0123</span><span class="o">/</span><span class="nv">alpha</span>.<span class="nv">txt</span>
<span class="nv">Traceback</span> <span class="ss">(</span><span class="nv">most</span> <span class="nv">recent</span> <span class="k">call</span> <span class="nl">last</span><span class="ss">)</span>:
  <span class="nv">File</span> <span class="s2">&quot;</span><span class="s">/opt/conda/lib/python3.7/site-packages/urllib3/connection.py</span><span class="s2">&quot;</span>, <span class="nv">line</span> <span class="mi">171</span>, <span class="nv">in</span> <span class="nv">_new_conn</span>
    <span class="ss">(</span><span class="nv">self</span>.<span class="nv">_dns_host</span>, <span class="nv">self</span>.<span class="nv">port</span><span class="ss">)</span>, <span class="nv">self</span>.<span class="nb">timeout</span>, <span class="o">**</span><span class="nv">extra_kw</span><span class="ss">)</span>
  <span class="nv">File</span> <span class="s2">&quot;</span><span class="s">/opt/conda/lib/python3.7/site-packages/urllib3/util/connection.py</span><span class="s2">&quot;</span>, <span class="nv">line</span> <span class="mi">56</span>, <span class="nv">in</span> <span class="nv">create_connection</span>
    <span class="k">for</span> <span class="nv">res</span> <span class="nv">in</span> <span class="nv">socket</span>.<span class="nv">getaddrinfo</span><span class="ss">(</span><span class="nv">host</span>, <span class="nv">port</span>, <span class="nv">family</span>, <span class="nv">socket</span>.<span class="nv">SOCK_STREAM</span><span class="ss">)</span>:
  <span class="nv">File</span> <span class="s2">&quot;</span><span class="s">/opt/conda/lib/python3.7/socket.py</span><span class="s2">&quot;</span>, <span class="nv">line</span> <span class="mi">748</span>, <span class="nv">in</span> <span class="nv">getaddrinfo</span>
    <span class="k">for</span> <span class="nv">res</span> <span class="nv">in</span> <span class="nv">_socket</span>.<span class="nv">getaddrinfo</span><span class="ss">(</span><span class="nv">host</span>, <span class="nv">port</span>, <span class="nv">family</span>, <span class="nv">type</span>, <span class="nv">proto</span>, <span class="nv">flags</span><span class="ss">)</span>:
<span class="nv">socket</span>.<span class="nv">gaierror</span>: [<span class="nv">Errno</span> <span class="o">-</span><span class="mi">3</span>] <span class="nv">Temporary</span> <span class="nv">failure</span> <span class="nv">in</span> <span class="nv">name</span> <span class="nv">resolution</span>
</pre></div>


<p>and the kubernetes log for the CoreDNS container</p>
<div class="highlight"><pre><span></span>$ <span class="nv">kubectl</span> <span class="nv">logs</span> <span class="o">--</span><span class="nv">namespace</span><span class="o">=</span><span class="nv">kube</span><span class="o">-</span><span class="nv">system</span> <span class="nv">coredns</span><span class="o">-</span><span class="mi">86</span><span class="nv">c58d9df4</span><span class="o">-</span><span class="nv">lvq8b</span>

.:<span class="mi">53</span>
<span class="mi">2019</span><span class="o">/</span><span class="mi">01</span><span class="o">/</span><span class="mi">25</span> <span class="mi">14</span>:<span class="mi">54</span>:<span class="mi">48</span> [<span class="nv">INFO</span>] <span class="nv">CoreDNS</span><span class="o">-</span><span class="mi">1</span>.<span class="mi">2</span>.<span class="mi">2</span>
<span class="mi">2019</span><span class="o">/</span><span class="mi">01</span><span class="o">/</span><span class="mi">25</span> <span class="mi">14</span>:<span class="mi">54</span>:<span class="mi">48</span> [<span class="nv">INFO</span>] <span class="nv">linux</span><span class="o">/</span><span class="nv">amd64</span>, <span class="nv">go1</span>.<span class="mi">11</span>, <span class="nv">fc62f9c</span>
<span class="nv">CoreDNS</span><span class="o">-</span><span class="mi">1</span>.<span class="mi">2</span>.<span class="mi">2</span>
<span class="nv">linux</span><span class="o">/</span><span class="nv">amd64</span>, <span class="nv">go1</span>.<span class="mi">11</span>, <span class="nv">eb51e8b</span>
<span class="mi">2019</span><span class="o">/</span><span class="mi">01</span><span class="o">/</span><span class="mi">25</span> <span class="mi">14</span>:<span class="mi">54</span>:<span class="mi">48</span> [<span class="nv">INFO</span>] <span class="nv">plugin</span><span class="o">/</span><span class="nv">reload</span>: <span class="nv">Running</span> <span class="nv">configuration</span> <span class="nv">MD5</span> <span class="o">=</span> <span class="mi">486384</span><span class="nv">b491cef6cb69c1f57a02087373</span>
<span class="mi">2019</span><span class="o">/</span><span class="mi">01</span><span class="o">/</span><span class="mi">25</span> <span class="mi">14</span>:<span class="mi">54</span>:<span class="mi">48</span> [<span class="nv">FATAL</span>] <span class="nv">plugin</span><span class="o">/</span><span class="k">loop</span>: <span class="nv">Seen</span> <span class="s2">&quot;</span><span class="s">HINFO IN 9273194449250285441.798654804648663468.</span><span class="s2">&quot;</span> <span class="nv">more</span> <span class="nv">than</span> <span class="nv">twice</span>, <span class="k">loop</span> <span class="nv">detected</span>
</pre></div>


<p>Basically, the AWS node's DNS name server settings cause 
an infinite DNS loop to be set up.</p>
<h3>The Fix</h3>
<p>Fixing this problem requires manually setting the DNS 
name servers inside the CoreDNS container to Google's
public DNS servers, <code>8.8.8.8</code> and <code>8.8.4.4</code>.</p>
<p>To apply this fix, we use a YAML configuration file to patch the
CoreDNS container image.</p>
<p>Hat tip to <a href="https://github.com/kubernetes/minikube/issues/2027">this long Github issue</a>
in the minikube Github repo, and specifically 
<a href="https://github.com/kubernetes/minikube/issues/2027#issuecomment-381574807">this comment</a>
by Github user <a href="https://github.com/jgoclawski">jgoclawski</a>.
and also <a href="https://github.com/kubernetes/minikube/issues/2027#issuecomment-419733791">this comment</a>
by Github user <a href="https://github.com/bw2">bw2</a>.
(Note that neither of these quite solve the problem -
jgoclawski's solution is for kube-dns, not CoreDNS,
and bw2's YAML is not valid, but both got me most
of the way to a solution.)</p>
<p>Here is the YAML file (also in the 2019-snakemake-byok8s
repo here: <a href="https://github.com/charlesreid1/2019-snakemake-byok8s/blob/master/test/fixcoredns.yml">https://github.com/charlesreid1/2019-snakemake-byok8s/blob/master/test/fixcoredns.yml</a>):</p>
<p><strong><code>fixcoredns.yml</code>:</strong></p>
<div class="highlight"><pre><span></span><span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
<span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">data</span><span class="p">:</span>
  <span class="nt">Corefile</span><span class="p">:</span> <span class="p p-Indicator">|</span>
    <span class="no">.:53 {</span>
        <span class="no">errors</span>
        <span class="no">health</span>
        <span class="no">kubernetes cluster.local in-addr.arpa ip6.arpa {</span>
           <span class="no">upstream 8.8.8.8 8.8.4.4</span>
           <span class="no">pods insecure</span>
           <span class="no">fallthrough in-addr.arpa ip6.arpa</span>
        <span class="no">}</span>
        <span class="no">proxy .  8.8.8.8 8.8.4.4</span>
        <span class="no">cache 30</span>
        <span class="no">reload</span>
    <span class="no">}</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">creationTimestamp</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">2019-01-25T22:55:15Z</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">coredns</span>
  <span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kube-system</span>
</pre></div>


<p>(<strong>NOTE:</strong> There is also a <code>fixkubedns.yml</code> if you are using
an older Kubernetes version that uses kube-dns instead of
CoreDNS.)</p>
<p>To tell the k8s cluster to use this image
when it creates a CoreDNS container, run
this kubectl command <em>while the cluster is
running</em>:</p>
<div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-</span><span class="n">f</span> <span class="n">fixcoredns</span><span class="p">.</span><span class="n">yml</span>
</pre></div>


<p>Last but not least, delete all <code>kube-system</code> containers
and let Kubernetes regenerate them:</p>
<div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="k">delete</span> <span class="c1">--all pods --namespace kube-system</span>
</pre></div>


<p>The pods will regenerate quickly, and you can
check to confirm that the CoreDNS container
is no longer in the <code>CrashLoopBackOff</code> state
and is <code>Running</code> nicely:</p>
<div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="k">get</span> <span class="n">pods</span> <span class="c1">--namespace=kube-system</span>
</pre></div>


<p>This is all documented in <a href="https://github.com/kubernetes/minikube/issues/2027#issuecomment-457808462">this comment</a>
in the same Github issue in the minikube repo
that was linked to above, <a href="https://github.com/kubernetes/minikube/issues/2027">kubernetes/minikube
issue #2027: dnsmasq pod CrashLoopBackOff</a>.</p>
<p><a name="aws-byok8s"></a></p>
<h2>AWS + byok8s Workflow</h2>
<p>Now that the k8s cluster is running successfully,
run the example byok8s workflow in the <code>test/</code> 
directory of the byok8s repository (assuming
you cloned the repo to <code>~/byok8s</code>, and are in
the same virtual environment as before):</p>
<div class="highlight"><pre><span></span># <span class="k">Return</span> <span class="nv">to</span> <span class="nv">our</span> <span class="nv">virtual</span> <span class="nv">environment</span>
<span class="nv">cd</span> <span class="o">~/</span><span class="mi">2019</span><span class="o">-</span><span class="nv">snakemake</span><span class="o">-</span><span class="nv">byok8s</span><span class="o">/</span><span class="nv">test</span><span class="o">/</span>
<span class="nv">source</span> <span class="nv">vp</span><span class="o">/</span><span class="nv">bin</span><span class="o">/</span><span class="nv">activate</span>

# <span class="nv">Verify</span> <span class="nv">k8s</span> <span class="nv">is</span> <span class="nv">running</span>
<span class="nv">minikube</span> <span class="nv">status</span>

# <span class="nv">Export</span> <span class="nv">AWS</span> <span class="nv">keys</span> <span class="k">for</span> <span class="nv">Snakemake</span>
<span class="nv">export</span> <span class="nv">AWS_ACCESS_KEY_ID</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">XXXXX</span><span class="s2">&quot;</span>
<span class="nv">export</span> <span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">XXXXX</span><span class="s2">&quot;</span>

# <span class="nv">Run</span> <span class="nv">byok8s</span>
<span class="nv">byok8s</span> <span class="nv">workflow</span><span class="o">-</span><span class="nv">alpha</span> <span class="nb">params</span><span class="o">-</span><span class="nv">blue</span> <span class="o">--</span><span class="nv">s3</span><span class="o">-</span><span class="nv">bucket</span><span class="o">=</span><span class="nv">mah</span><span class="o">-</span><span class="nv">bukkit</span> 
</pre></div>


<p>The bucket you specify must be created in advance
and be writable by the account whose credentials
you are passing in via environment variables.</p>
<p>When you do all of this, you should see the job
running, then exiting successfully:</p>
<div class="highlight"><pre><span></span>$ <span class="nv">byok8s</span> <span class="o">--</span><span class="nv">s3</span><span class="o">-</span><span class="nv">bucket</span><span class="o">=</span><span class="nv">cmr</span><span class="o">-</span><span class="mi">0123</span> <span class="o">-</span><span class="nv">f</span> <span class="nv">workflow</span><span class="o">-</span><span class="nv">alpha</span> <span class="nb">params</span><span class="o">-</span><span class="nv">blue</span>
<span class="o">--------</span>
<span class="nv">details</span><span class="o">!</span>
    <span class="nv">snakefile</span>: <span class="o">/</span><span class="nv">home</span><span class="o">/</span><span class="nv">ubuntu</span><span class="o">/</span><span class="mi">2019</span><span class="o">-</span><span class="nv">snakemake</span><span class="o">-</span><span class="nv">byok8s</span><span class="o">/</span><span class="nv">test</span><span class="o">/</span><span class="nv">Snakefile</span>
    <span class="nv">config</span>: <span class="o">/</span><span class="nv">home</span><span class="o">/</span><span class="nv">ubuntu</span><span class="o">/</span><span class="mi">2019</span><span class="o">-</span><span class="nv">snakemake</span><span class="o">-</span><span class="nv">byok8s</span><span class="o">/</span><span class="nv">test</span><span class="o">/</span><span class="nv">workflow</span><span class="o">-</span><span class="nv">alpha</span>.<span class="nv">json</span>
    <span class="nb">params</span>: <span class="o">/</span><span class="nv">home</span><span class="o">/</span><span class="nv">ubuntu</span><span class="o">/</span><span class="mi">2019</span><span class="o">-</span><span class="nv">snakemake</span><span class="o">-</span><span class="nv">byok8s</span><span class="o">/</span><span class="nv">test</span><span class="o">/</span><span class="nb">params</span><span class="o">-</span><span class="nv">blue</span>.<span class="nv">json</span>
    <span class="nv">target</span>: <span class="nv">target1</span>
    <span class="nv">k8s</span> <span class="nv">namespace</span>: <span class="nv">default</span>
<span class="o">--------</span>
<span class="nv">Building</span> <span class="nv">DAG</span> <span class="nv">of</span> <span class="nv">jobs</span>...
<span class="nv">Using</span> <span class="nv">shell</span>: <span class="o">/</span><span class="nv">bin</span><span class="o">/</span><span class="nv">bash</span>
<span class="nv">Provided</span> <span class="nv">cores</span>: <span class="mi">1</span>
<span class="nv">Rules</span> <span class="nv">claiming</span> <span class="nv">more</span> <span class="nv">threads</span> <span class="nv">will</span> <span class="nv">be</span> <span class="nv">scaled</span> <span class="nv">down</span>.
<span class="nv">Job</span> <span class="nv">counts</span>:
    <span class="nv">count</span>   <span class="nv">jobs</span>
    <span class="mi">1</span>   <span class="nv">target1</span>
    <span class="mi">1</span>
<span class="nv">Resources</span> <span class="nv">before</span> <span class="nv">job</span> <span class="nv">selection</span>: {<span class="s1">&#39;</span><span class="s">_cores</span><span class="s1">&#39;</span>: <span class="mi">1</span>, <span class="s1">&#39;</span><span class="s">_nodes</span><span class="s1">&#39;</span>: <span class="mi">9223372036854775807</span>}
<span class="nv">Ready</span> <span class="nv">jobs</span> <span class="ss">(</span><span class="mi">1</span><span class="ss">)</span>:
    <span class="nv">target1</span>
<span class="nv">Selected</span> <span class="nv">jobs</span> <span class="ss">(</span><span class="mi">1</span><span class="ss">)</span>:
    <span class="nv">target1</span>
<span class="nv">Resources</span> <span class="nv">after</span> <span class="nv">job</span> <span class="nv">selection</span>: {<span class="s1">&#39;</span><span class="s">_cores</span><span class="s1">&#39;</span>: <span class="mi">0</span>, <span class="s1">&#39;</span><span class="s">_nodes</span><span class="s1">&#39;</span>: <span class="mi">9223372036854775806</span>}

[<span class="nv">Mon</span> <span class="nv">Jan</span> <span class="mi">28</span> <span class="mi">18</span>:<span class="mi">06</span>:<span class="mi">08</span> <span class="mi">2019</span>]
<span class="nv">rule</span> <span class="nv">target1</span>:
    <span class="nv">output</span>: <span class="nv">cmr</span><span class="o">-</span><span class="mi">0123</span><span class="o">/</span><span class="nv">alpha</span>.<span class="nv">txt</span>
    <span class="nv">jobid</span>: <span class="mi">0</span>

<span class="nv">echo</span> <span class="nv">alpha</span> <span class="nv">blue</span> <span class="o">&gt;</span> <span class="nv">cmr</span><span class="o">-</span><span class="mi">0123</span><span class="o">/</span><span class="nv">alpha</span>.<span class="nv">txt</span>
<span class="nv">Get</span> <span class="nv">status</span> <span class="nv">with</span>:
<span class="nv">kubectl</span> <span class="nv">describe</span> <span class="nv">pod</span> <span class="nv">snakejob</span><span class="o">-</span><span class="nv">e585b53f</span><span class="o">-</span><span class="nv">f9d5</span><span class="o">-</span><span class="mi">5142</span><span class="o">-</span><span class="nv">ac50</span><span class="o">-</span><span class="nv">af5a0d532e85</span>
<span class="nv">kubectl</span> <span class="nv">logs</span> <span class="nv">snakejob</span><span class="o">-</span><span class="nv">e585b53f</span><span class="o">-</span><span class="nv">f9d5</span><span class="o">-</span><span class="mi">5142</span><span class="o">-</span><span class="nv">ac50</span><span class="o">-</span><span class="nv">af5a0d532e85</span>
<span class="nv">Checking</span> <span class="nv">status</span> <span class="k">for</span> <span class="nv">pod</span> <span class="nv">snakejob</span><span class="o">-</span><span class="nv">e585b53f</span><span class="o">-</span><span class="nv">f9d5</span><span class="o">-</span><span class="mi">5142</span><span class="o">-</span><span class="nv">ac50</span><span class="o">-</span><span class="nv">af5a0d532e85</span>
[<span class="nv">Mon</span> <span class="nv">Jan</span> <span class="mi">28</span> <span class="mi">18</span>:<span class="mi">06</span>:<span class="mi">18</span> <span class="mi">2019</span>]
<span class="nv">Finished</span> <span class="nv">job</span> <span class="mi">0</span>.
<span class="mi">1</span> <span class="nv">of</span> <span class="mi">1</span> <span class="nv">steps</span> <span class="ss">(</span><span class="mi">100</span><span class="o">%</span><span class="ss">)</span> <span class="nv">done</span>
<span class="nv">Complete</span> <span class="nv">log</span>: <span class="o">/</span><span class="nv">home</span><span class="o">/</span><span class="nv">ubuntu</span><span class="o">/</span><span class="mi">2019</span><span class="o">-</span><span class="nv">snakemake</span><span class="o">-</span><span class="nv">byok8s</span><span class="o">/</span><span class="nv">test</span><span class="o">/</span>.<span class="nv">snakemake</span><span class="o">/</span><span class="nv">log</span><span class="o">/</span><span class="mi">2019</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">28</span><span class="nv">T180607</span>.<span class="mi">988313</span>.<span class="nv">snakemake</span>.<span class="nv">log</span>
<span class="nv">unlocking</span>
<span class="nv">removing</span> <span class="nv">lock</span>
<span class="nv">removing</span> <span class="nv">lock</span>
<span class="nv">removed</span> <span class="nv">all</span> <span class="nv">locks</span>
</pre></div>


<p>Woo hoo! You've successfully run a Snakemake workflow 
on a virtual Kubernetes cluster!</p>
<p><a name="travis"></a></p>
<h2>Travis</h2>
<p>Like running minikube on an AWS node, running minikube on Travis workers
also suffers from DNS issues. Fortunately, Github user 
<a href="https://github.com/LiliC">LiliC</a> worked out how to run
minikube on Travis, and importantly, <em>did so for multiple versions</em>
of minikube and kubernetes.</p>
<p>The relevant <code>.travis.yml</code> file is available in the 
<a href="https://github.com/LiliC/travis-minikube">LiliC/travis-minikube</a>
repo on Github.</p>
<p>We ended up using the <a href="https://github.com/LiliC/travis-minikube/tree/minikube-30-kube-1.12"><code>minikube-30-kube-1.12</code></a>
branch of LiliC/travis-minikube, which used the most up-to-date
version of minikube and kubernetes available in that repo. The <code>.travis.yml</code> file
provided by LiliC on that branch is 
<a href="https://github.com/LiliC/travis-minikube/blob/minikube-30-kube-1.12/.travis.yml">here</a>.</p>
<p>The example script by LiliC provided 90% of the legwork (thanks!!!),
and we only needed to modify a few lines of LiliC's Travis file
(which launches a redis container using kubectl)
to use Snakemake (launched via byok8s) instead.</p>
<p><a name="travis-yml"></a></p>
<h2><code>.travis.yml</code></h2>
<p>Here is the final <code>.travis.yml</code> file, which has explanatory comments.</p>
<p><strong><code>.travis.yml</code>:</strong></p>
<div class="highlight"><pre><span></span><span class="c1"># Modified from original:</span>
<span class="c1"># https://raw.githubusercontent.com/LiliC/travis-minikube/minikube-30-kube-1.12/.travis.yml</span>

<span class="c1"># byok8s and Snakemake both require Python,</span>
<span class="c1"># so we make this Travis CI test Python-based.</span>
<span class="nt">language</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">python</span>
<span class="nt">python</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="s">&quot;3.6&quot;</span>

<span class="c1"># Running minikube via travis requires sudo</span>
<span class="nt">sudo</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">required</span>

<span class="c1"># We need the systemd for the kubeadm and it&#39;s default from 16.04+</span>
<span class="nt">dist</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">xenial</span>

<span class="c1"># This moves Kubernetes specific config files.</span>
<span class="nt">env</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">CHANGE_MINIKUBE_NONE_USER=true</span>

<span class="nt">install</span><span class="p">:</span>
<span class="c1"># Install byok8s requirements (snakemake, python-kubernetes)</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">pip install -r requirements.txt</span>
<span class="c1"># Install byok8s cli tool</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">python setup.py build install</span>

<span class="nt">before_script</span><span class="p">:</span>
<span class="c1"># Do everything from test/</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">cd test</span>
<span class="c1"># Make root mounted as rshared to fix kube-dns issues.</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">sudo mount --make-rshared /</span>
<span class="c1"># Download kubectl, which is a requirement for using minikube.</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">curl -Lo kubectl https://storage.googleapis.com/kubernetes-release/release/v1.12.0/bin/linux/amd64/kubectl &amp;&amp; chmod +x kubectl &amp;&amp; sudo mv kubectl /usr/local/bin/</span>
<span class="c1"># Download minikube.</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">curl -Lo minikube https://storage.googleapis.com/minikube/releases/v0.30.0/minikube-linux-amd64 &amp;&amp; chmod +x minikube &amp;&amp; sudo mv minikube /usr/local/bin/</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">sudo minikube start --vm-driver=none --bootstrapper=kubeadm --kubernetes-version=v1.12.0</span>
<span class="c1"># Fix the kubectl context, as it&#39;s often stale.</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">minikube update-context</span>
<span class="c1"># Wait for Kubernetes to be up and ready.</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">JSONPATH=&#39;{range .items[*]}{@.metadata.name}:{range @.status.conditions[*]}{@.type}={@.status};{end}{end}&#39;; until kubectl get nodes -o jsonpath=&quot;$JSONPATH&quot; 2&gt;&amp;1 | grep -q &quot;Ready=True&quot;; do sleep 1; done</span>

<span class="c1">################</span>
<span class="c1">## easy test</span>
<span class="nt">script</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">kubectl cluster-info</span>
<span class="c1"># Verify kube-addon-manager.</span>
<span class="c1"># kube-addon-manager is responsible for managing other kubernetes components, such as kube-dns, dashboard, storage-provisioner..</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">JSONPATH=&#39;{range .items[*]}{@.metadata.name}:{range @.status.conditions[*]}{@.type}={@.status};{end}{end}&#39;; until kubectl -n kube-system get pods -lcomponent=kube-addon-manager -o jsonpath=&quot;$JSONPATH&quot; 2&gt;&amp;1 | grep -q &quot;Ready=True&quot;; do sleep 1;echo &quot;waiting for kube-addon-manager to be available&quot;; kubectl get pods --all-namespaces; done</span>
<span class="c1"># Wait for kube-dns to be ready.</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">JSONPATH=&#39;{range .items[*]}{@.metadata.name}:{range @.status.conditions[*]}{@.type}={@.status};{end}{end}&#39;; until kubectl -n kube-system get pods -lk8s-app=kube-dns -o jsonpath=&quot;$JSONPATH&quot; 2&gt;&amp;1 | grep -q &quot;Ready=True&quot;; do sleep 1;echo &quot;waiting for kube-dns to be available&quot;; kubectl get pods --all-namespaces; done</span>

<span class="c1">################ </span>
<span class="c1">## hard test</span>
<span class="c1"># run byok8s workflow on the k8s cluster</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">byok8s --s3-bucket=cmr-0123 -f workflow-alpha params-blue</span>
</pre></div>


<p><a name="byok8s3"></a></p>
<h1>End Product: byok8s</h1>
<p>The final byok8s package can be found in the
<a href="https://github.com/charlesreid1/2019-snakemake-byok8s">charlesreid1/2019-snakemake-byok8s</a>
repository on Github.</p>
<p>You can find documentation for 2019-snakemake-byok8s 
here: <a href="https://charlesreid1.github.io/2019-snakemake-byok8s/">https://charlesreid1.github.io/2019-snakemake-byok8s/</a></p>
<p>To return to our quick start, here is what running
byok8s end-to-end on a minikube kubernetes cluster 
on an AWS node looks like (slightly modified from
the intro of our post):</p>
<div class="highlight"><pre><span></span># <span class="nv">Install</span> <span class="nv">minikube</span>
<span class="nv">curl</span> <span class="o">-</span><span class="nv">LO</span> <span class="nv">https</span>:<span class="o">//</span><span class="nv">storage</span>.<span class="nv">googleapis</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">minikube</span><span class="o">/</span><span class="nv">releases</span><span class="o">/</span><span class="nv">latest</span><span class="o">/</span><span class="nv">minikube</span><span class="o">-</span><span class="nv">linux</span><span class="o">-</span><span class="nv">amd64</span> \
  <span class="o">&amp;&amp;</span> <span class="nv">sudo</span> <span class="nv">install</span> <span class="nv">minikube</span><span class="o">-</span><span class="nv">linux</span><span class="o">-</span><span class="nv">amd64</span> <span class="o">/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">local</span><span class="o">/</span><span class="nv">bin</span><span class="o">/</span><span class="nv">minikube</span>

# <span class="nv">Get</span> <span class="nv">byok8s</span>
<span class="nv">git</span> <span class="nv">clone</span> <span class="nv">https</span>:<span class="o">//</span><span class="nv">github</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">charlesreid1</span><span class="o">/</span><span class="mi">2019</span><span class="o">-</span><span class="nv">snakemake</span><span class="o">-</span><span class="nv">byok8s</span>.<span class="nv">git</span>
<span class="nv">cd</span> <span class="o">~/</span><span class="mi">2019</span><span class="o">-</span><span class="nv">snakemake</span><span class="o">-</span><span class="nv">byok8s</span>

# <span class="nv">Create</span> <span class="nv">a</span> <span class="nv">virtual</span> <span class="nv">environment</span>
<span class="nv">virtualenv</span> <span class="nv">vp</span>
<span class="nv">vp</span><span class="o">/</span><span class="nv">bin</span><span class="o">/</span><span class="nv">actiavte</span>

# <span class="nv">Install</span> <span class="nv">byok8s</span>
<span class="nv">pip</span> <span class="nv">install</span> <span class="o">-</span><span class="nv">r</span> <span class="nv">requirements</span>.<span class="nv">txt</span>
<span class="nv">python</span> <span class="nv">setup</span>.<span class="nv">py</span> <span class="nv">build</span> <span class="nv">install</span>

# <span class="nv">Create</span> <span class="nv">virtual</span> <span class="nv">k8s</span> <span class="nv">cluster</span>
<span class="nv">sudo</span> <span class="nv">minikube</span> <span class="nv">start</span>

# <span class="nv">Fix</span> <span class="nv">CoreDNS</span>
<span class="nv">kubectl</span> <span class="nv">apply</span> <span class="o">-</span><span class="nv">f</span> <span class="nv">fixcoredns</span>.<span class="nv">yml</span>
<span class="nv">kubectl</span> <span class="nv">delete</span> <span class="o">--</span><span class="nv">all</span> <span class="nv">pods</span> <span class="o">--</span><span class="nv">namespace</span> <span class="nv">kube</span><span class="o">-</span><span class="nv">system</span>

# <span class="k">Wait</span> <span class="k">for</span> <span class="nv">kube</span><span class="o">-</span><span class="nv">system</span> <span class="nv">to</span> <span class="nv">respawn</span>
<span class="nv">kubectl</span> <span class="nv">get</span> <span class="nv">pods</span> <span class="o">--</span><span class="nv">namespace</span><span class="o">=</span><span class="nv">kube</span><span class="o">-</span><span class="nv">system</span>

# <span class="nv">Run</span> <span class="nv">the</span> <span class="nv">workflow</span> <span class="nv">on</span> <span class="nv">the</span> <span class="nv">k8s</span> <span class="nv">cluster</span>
<span class="nv">cd</span> <span class="nv">test</span><span class="o">/</span>
<span class="nv">byok8s</span> <span class="nv">workflow</span><span class="o">-</span><span class="nv">alpha</span> <span class="nb">params</span><span class="o">-</span><span class="nv">blue</span> <span class="o">--</span><span class="nv">s3</span><span class="o">-</span><span class="nv">bucket</span><span class="o">=</span><span class="nv">mah</span><span class="o">-</span><span class="nv">bukkit</span> 

# <span class="nv">Clean</span> <span class="nv">up</span> <span class="nv">the</span> <span class="nv">virtual</span> <span class="nv">k8s</span> <span class="nv">cluster</span>
<span class="nv">sudo</span> <span class="nv">minikube</span> <span class="nv">stop</span>
</pre></div>


<p><br />
<br /></p>
<p><a name="docs"></a></p>
<h1>Documentation</h1>
<p>You can find documentation for 2019-snakemake-byok8s 
here: <a href="https://charlesreid1.github.io/2019-snakemake-byok8s/">https://charlesreid1.github.io/2019-snakemake-byok8s/</a></p>
<p>The documentation covers a quick start on AWS nodes, 
similar to what is covered above, as well as more information
about running byok8s on other types of Kubernetes clusters
(e.g., AWS, Google Cloud, and Digital Ocean).</p>
<p><br />
<br /></p>
<p><a name="next"></a></p>
<h1>Next Steps</h1>
<p>Last year we were working on implementing metagenomic pipelines for
shotgun sequencing data as part of the <a href="https://github.com/dahak-metagenomics">dahak-metagenomics</a>
project. We implemented several Snakemake workflows
in the <a href="https://github.com/dahak-metagenomics/dahak">dahak</a>
repo, and began (but never completed) work on a command line utility
to run these workflows called <a href="https://github.com/dahak-metagenomics/dahak-taco">dahak-taco</a>.</p>
<p>Our next major goal is to reboot dahak-taco and redesign it to run metagenomic
workflows from dahak on Kubernetes clusters, similar to the way byok8s works.</p>
<p>Stay tuned for more!</p></div>

    </div>
</div>

<div class="v20"></div>

<div class="row">
    <div class="col-md-12" style="text-align: left;">

        <div class="tags">
            <p>Tags:&nbsp;&nbsp;&nbsp;
                    <a href="https://charlesreid1.github.io/tag/python.html">python</a>
                    &nbsp;&nbsp;
                    <a href="https://charlesreid1.github.io/tag/bioinformatics.html">bioinformatics</a>
                    &nbsp;&nbsp;
                    <a href="https://charlesreid1.github.io/tag/workflows.html">workflows</a>
                    &nbsp;&nbsp;
                    <a href="https://charlesreid1.github.io/tag/pipelines.html">pipelines</a>
                    &nbsp;&nbsp;
                    <a href="https://charlesreid1.github.io/tag/snakemake.html">snakemake</a>
                    &nbsp;&nbsp;
                    <a href="https://charlesreid1.github.io/tag/travis.html">travis</a>
                    &nbsp;&nbsp;
                    <a href="https://charlesreid1.github.io/tag/kubernetes.html">kubernetes</a>
                    &nbsp;&nbsp;
                    <a href="https://charlesreid1.github.io/tag/minikube.html">minikube</a>
                    &nbsp;&nbsp;
        </div>

    </div>
</div>


<div class="v200"></div>

</div>


<script type="text/javascript" src="https://charlesreid1.github.io/theme/js/jquery-1.11.2.js"></script>
<script type="text/javascript" src="https://charlesreid1.github.io/theme/js/bootstrap-3.3.4.js"></script>
<script type="text/javascript" src="https://charlesreid1.github.io/theme/js/d3-3.5.5.js"></script><script type="text/javascript" src="https://charlesreid1.github.io/theme/js/jquery-1.11.2.js"></script>
<script type="text/javascript" src="https://charlesreid1.github.io/theme/js/bootstrap-3.3.4.js"></script>

<footer id="contentinfo" class="body">
<p>&nbsp;</p>
<p>&nbsp;</p>
<center>
	<hr />
</center>
<p>&nbsp;</p>
<p style="text-align: center">
    <span class="fa-stack fa-lg">
        <i class="fa fa-square fa-stack-2x" style="color:#000;"></i>
        <i class="fa fa-terminal fa-stack-1x fa-inverse"></i>
    </span>
    Made from the command line with vim by 
    <a href="http://charlesreid1.com">charlesreid1</a><br />
    with help from <a href="https://getbootstrap.com/">Bootstrap</a> and <a href="http://getpelican.com">Pelican</a>.
</p>

<br />

<p style="text-align: center">
    <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">
    <span class="fa-stack fa-lg">
        <i class="fa fa-square fa-stack-2x" style="color:#000;"></i>
        <i class="fa fa-creative-commons fa-stack-1x fa-inverse"></i>
    </span>
    </a>
    <br />
    Licensed under the <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">Creative Commons Attribution-NonCommercial 4.0 License</a>.
</p>

<!-- Start of StatCounter Code for Default Guide -->
<script type="text/javascript">
var sc_project=11611748;
var sc_invisible=1;
var sc_security="9fcba820";
</script>
<script type="text/javascript"
src="https://www.statcounter.com/counter/counter.js"
async></script>

<noscript><div class="statcounter"><a title="Web Analytics"
href="http://statcounter.com/" target="_blank"><img
class="statcounter"
src="//c.statcounter.com/11611748/0/9fcba820/1/" alt="Web
Analytics"></a></div></noscript>
<!-- End of StatCounter Code for Default Guide -->
</footer><!-- /#contentinfo -->
</body>
</html>