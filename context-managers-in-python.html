<!DOCTYPE html>
<html lang="en">
<head>
        <title>charlesreid1</title>
        <meta charset="utf-8" />

        <!--
        CSS styles
        -->
        <link href="https://charlesreid1.github.io/theme/css/bootstrap.css"       rel="stylesheet" type="text/css">
        <link href="https://charlesreid1.github.io/theme/css/slate.css"              rel="stylesheet" type="text/css">
        <link href="https://charlesreid1.github.io/theme/css/font-awesome.css"       rel="stylesheet" type="text/css"/>
        <link href="https://charlesreid1.github.io/theme/css/pygment-solarized.css"  rel="stylesheet" type="text/css"/>

        <!--
        my CSS styles
        -->
        <link href="https://charlesreid1.github.io/theme/css/main.css"            rel="stylesheet" type="text/css">
        <link href="https://charlesreid1.github.io/theme/css/dox.css"             rel="stylesheet" type="text/css">


        <!--
        include Angular first
        -->
        <script type="text/javascript" src="https://charlesreid1.github.io/theme/js/angular-1.3.15.js"></script>
        <script type="text/javascript" src="https://charlesreid1.github.io/theme/js/skrollr-0.6.29.js"></script>
        <script type="text/javascript" src="https://charlesreid1.github.io/theme/js/d3-3.5.5.js"></script>

        <!--
        this seems like a bad idea.
        but if I don't put jquery first, I get errors about unrecognized $s.
        -->
        <script type="text/javascript" src="https://charlesreid1.github.io/theme/js/jquery-1.11.2.js"></script>

</head>
<body id="index">
<nav class="navbar navbar-default">
    <div class="container-fluid">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span> 
            </button>
            <a href="https://charlesreid1.github.io" class="navbar-brand">charlesreid1.github.io</a>
        </div>
        <div>
            <div class="collapse navbar-collapse" id="myNavbar">
                <ul class="nav navbar-nav">

                    <li>
                        <a href="https://charlesreid1.com/wiki">Wiki</a>
                    </li>
                    <li>
                        <a href="https://git.charlesreid1.com/explore">Git</a>
                    </li>
                    <li>
                        <a href="http://spotify.charlesreid1.com">Music</a>
                    </li>
                    <li>
                        <a href="https://charlesreid1.com/life">Life</a>
                    </li>
                    <li>
                        <a href="https://charlesreid1.github.io">Blog</a>
                    </li>
                    <li>
                        <a href="https://charlesreid1.com/about">About Me</a>
                    </li>

                </ul>
            </div>
        </div>
    </div>
</nav>



<div class="container">

<header>
<div class="row">


    <div class="col-md-12">
        <div class="headtext" style="text-align: center;">
            <h1><b>
                Context Managers in Python
            </b></h1>
        
            <p class="lead">
                Posted 
                <time datetime="2019-02-02T10:00:00-08:00" pubdate>Saturday 02/02/2019</time>
                in 
                <a href="https://charlesreid1.github.io/category/python.html">Python</a>
                </p>
            <p>
            <span style="font-size: 14px">
                <a href="https://charlesreid1.github.io/context-managers-in-python.html">permalink</a>
            </span>
            </p>
        </div>

    </div>

</div>
</header>


<div class="v50"></div>


<div class="row">
    <div class="col-md-12" style="text-align: left;">

        <div class="entry-content"><h2>Table of Contents</h2>
<ul>
<li><a href="#predicament">A Predicament</a></li>
<li><a href="#wat">What is a context manager?</a></li>
<li><a href="#wat">What is Graphviz dot?</a></li>
<li><a href="#stdout">Capturing stdout</a></li>
<li><a href="#replacing">Replacing stdout</a></li>
<li><a href="#context">Creating a context manager</a><ul>
<li><a href="#_init">Constructor</a></li>
<li><a href="#_enter">Enter method</a></li>
<li><a href="#_exit">Exit method</a></li>
<li><a href="#action">In action</a></li>
</ul>
</li>
<li><a href="#using">Using the new dag flags</a></li>
<li><a href="#other">Other context manager applications</a><ul>
<li><a href="#ssh">SSH connections</a></li>
<li><a href="#ssh">Jupyter notebook</a></li>
<li><a href="#figs">iPython (Jupyter) notebook and matplotlib figure management</a></li>
<li><a href="#dbconn">Database connection</a></li>
</ul>
</li>
<li><a href="#refs">References</a></li>
</ul>
<p><br />
<br /></p>
<p><a name="predicament"></a></p>
<h2>A Predicament</h2>
<p>Recently we spent some time contributing to
<a href="https://github.com/dib-lab/eelpond">dib-lab/eelpond (renamed to elvers)</a>,
an executable <a href="https://snakemake.readthedocs.io/en/stable/">Snakemake</a>
workflow for running the 
<a href="https://khmer-protocols.readthedocs.io/en/latest/mrnaseq/index.html">eelpond mRNAseq workflow</a>.</p>
<p>In the process of tracking down a confusing
bug in the Snakemake workflow, we used Snakemake's
ability to print a directed acyclic graph (hereafter
referred to as a <strong>dag</strong>) representing
its task graph. Snakemake prints the dot notation
to stdout.</p>
<p>(The graph representation ended up identifying the problem,
which was two task graphs that were independent, but 
which were not supposed to be independent.)</p>
<p>When creating the Graphviz dot notation,
Snakemake is kind enough to direct all of its output
messages to stderr, and direct the dot graph output 
to stdout, which makes it easy to redirect stdout
to a <code>.dot</code> file and process it with Graphviz.</p>
<p>Github user <a href="https://github.com/bluegenes">@bluegenes</a>
(the principal author of elvers) <a href="https://github.com/dib-lab/eelpond/pull/69">added a <code>--dag</code> file to the <code>run_eelpond</code> script</a>,
which asks Snakemake to print the dag when it calls
the Snakemake API:</p>
<div class="highlight"><pre><span></span>./run_eelpond --dag ... &gt; eelpond_dag.dot
</pre></div>


<p>This .dot file can then be rendered into a .png file
with another command from the command line,</p>
<div class="highlight"><pre><span></span>dot eelpond_dag.dot -Tpng -o eelpond_dag.png
</pre></div>


<p>Simple, right?</p>
<p><strong>But here's the problem:</strong>
While this is a simple and easy way to generate the dag,
it introduces some extra steps for the user, and it
also prevents us from being able to print <em>anything</em> to
stdout before or after the dag is generated, since
anything printed out by the program to stdout will
be redirected to the final dot file along with all
the Graphviz dot output.</p>
<p>So how to avoid the extra steps on the command line,
while also improving the flexibility in printing to
stdout (i.e., only capturing Snakemake's output to
a file)?</p>
<p>Can we add two flags like <code>--dagfile</code> and <code>--dagpng</code>
that would, respectively, save the task graph 
directly into a .dot file, or render the dot output
from Snakemake directly into a png using dot?</p>
<p>We <a href="https://github.com/dib-lab/eelpond/pull/73">implemented precisely this functionality</a>
in dib-lab/eelpond PR #73. To do this,
we utilized a context manager to capture output
from Snakemake. In this post we'll cover how
this context manager works, and mention a few
other possibilities with context managers.</p>
<p><a name="wat"></a></p>
<h2>What is a context manager?</h2>
<p>If you have done even a little Python programming,
you have probably seen and used <a href="https://docs.python.org/3/reference/datamodel.html#context-managers">context managers</a>
before - they are blocks of code that are
opened using a <code>with</code> keyword in Python. For example,
the classic Pythonic way to write to a file uses
a context manager:</p>
<div class="highlight"><pre><span></span>with open(&#39;file.txt&#39;, &#39;w&#39;) as f:
    f.write(&quot;\n&quot;.join(range(10)))
</pre></div>


<p>The context manager defines a runtime context for
all the code in the block - and that can be a different
context than the rest of the program. When a context
is opened (when the <code>with</code> block is encountered), 
a context manager object is created and its <code>__enter__()</code>
method is run. This method will modify the runtime
context in whatever way it needs,
and the rest of the code in the block will be run.
When the context is done, where the block ends,
the context manager's <code>__exit__()</code> method is run.
This restores the runtime context to its
normal state for the rest of the program.</p>
<p>It's a general concept with a <em>lot</em> of different 
applications. We cover how to use it to capture
output to <code>sys.stdout</code> below.</p>
<p><a name="dot"></a></p>
<h2>What is Graphviz dot?</h2>
<p>We mentioned that Snakemake can output visualizations of
workflows in Graphviz dot format. For the purposes
of clarity we explain what that format is here.</p>
<p>Without getting too sidetracked, <a href="https://graphviz.org/">Graphviz dot</a>
defines a notation for drawing graphs, and provides software
for laying out the graphs in rendered images.</p>
<p>The user specifies the nodes and labels and edges, as well as
formatting and layout details, and dot takes care of laying
out the graph.</p>
<p>Here's an example of a simple graph in dot notation:</p>
<p><strong><code>plot.dot</code></strong></p>
<div class="highlight"><pre><span></span>digraph G {
    Boston
    &quot;New York&quot;
    Houston
    &quot;Los Angeles&quot;
    Seattle

    Boston -&gt; &quot;New York&quot;
    Boston -&gt; Houston
    Houston -&gt; Boston
    Houston -&gt; &quot;Los Angeles&quot;
    &quot;New York&quot; -&gt; Seattle
    Seattle -&gt; &quot;New York&quot;
    &quot;New York&quot; -&gt; &quot;Los Angeles&quot;
}
</pre></div>


<p>To render this as a .png image,</p>
<div class="highlight"><pre><span></span>dot cities.dot -Tpng -o cities.png
</pre></div>


<p>which becomes:</p>
<p><img alt="dot graph of cities" src="/images/dot_cities.png"></p>
<p>This tool makes visualizing workflows a breeze,
as the flow of tasks is much easier to understand
and troubleshoot than the convoluted logic of
Snakefile rules. Here is an example from elvers:</p>
<p><img alt="elvers dag" src="/images/elvers_dag.png"></p>
<p><a name="stdout"></a></p>
<h2>Capturing stdout</h2>
<p>In elvers, the <code>run_eelpond</code> command line wrapper that kicks
off the workflow is a Python script that calls the Snakemake
API (we covered this approach in a prior blog post,
<a href="https://charlesreid1.github.io/building-snakemake-command-line-wrappers-for-workflows.html">Building Snakemake Command Line Wrappers for Workflows</a>).</p>
<p>This Python script has a call to the Snakemake API; here
is the relevant snippet:</p>
<div class="highlight"><pre><span></span>        # ...set up...

        if not building_dag:
            print(&#39;--------&#39;)
            print(&#39;details!&#39;)
            print(&#39;\tsnakefile: {}&#39;.format(snakefile))
            print(&#39;\tconfig: {}&#39;.format(configfile))
            print(&#39;\tparams: {}&#39;.format(paramsfile))
            print(&#39;\ttargets: {}&#39;.format(repr(targs)))
            print(&#39;\treport: {}&#39;.format(repr(reportfile)))
            print(&#39;--------&#39;)

        # Begin snakemake API call

        status = snakemake.snakemake(snakefile, configfile=paramsfile, use_conda=True, 
                                 targets=[&#39;eelpond&#39;], printshellcmds=True, 
                                 cores=args.threads, cleanup_conda= args.cleanup_conda,
                                 dryrun=args.dry_run, lock=not args.nolock,
                                 unlock=args.unlock,
                                 verbose=args.verbose, debug_dag=args.debug, 
                                 conda_prefix=args.conda_prefix, 
                                 create_envs_only=args.create_envs_only,
                                 restart_times=args.restart_times,
                                 printdag=building_dag, keepgoing=args.keep_going,
                                 forcetargets=args.forcetargets,forceall=args.forceall)

        # End snakemake API call

        # ...clean up...
</pre></div>


<p>Most of the code that comes before this API call is processing
the flags provided by the user. We want to have the flexibility
to print to stdout while processing flags, before we get to the
Snakemake API call; and we want those messages to be kept separate
from the dag output.</p>
<p>In other words, we only want to capture output to stdout between
"Begin snakemake API call" and "End snakemake API call". Everywhere
else, stdout can go to stdout like normal.</p>
<p>We can do this by recognizing that any Python program printing to
stdout uses <code>sys.stdout</code> under the hood to send output to stdout -
so if we can somehow tell Python to swap out stdout with a string
buffer that has the same methods (print, printf, etc.), run Snakemake,
then replace stdout again, we can isolate and capture all stdout from
the Snakemake API call.</p>
<p><a name="replacing"></a></p>
<h2>Replacing stdout</h2>
<p>The strategy for our context manager and the entry and exit
methods, then, is clear:</p>
<ul>
<li>
<p>If the user has specified the <code>--dag</code> flag, 
  the <code>__entry__()</code> method should replace stdout
  with a StringIO buffer within our new runtime 
  context; otherwise, leave stdout alone.</p>
</li>
<li>
<p>If the user has specified the <code>--dag</code> flag,
  the <code>__exit__()</code> method should clean up by
  restoring <code>sys.stdout</code>; otherwise, do nothing.</p>
</li>
</ul>
<p>Now we are ready to make our context manager object.</p>
<p>But wait! What kind of object are we using? Do we need
some kind of special context manager class?
Nope! This is one of the features of context
managers that makes them magical: </p>
<p><em><strong>Any</strong> object can be a context manager.</em></p>
<p>All we need to do is add <code>__enter__()</code> and <code>__exit__()</code>
methods to an object, and it can become a context
manager.</p>
<p><a name="context"></a></p>
<h2>Creating a context manager</h2>
<p>In our case, we are capturing stdout from Snakemake
so that we can potentially process it, and then dump 
it to a file. We don't know how many lines Snakemake
will output, so we will replace <code>sys.stdout</code> with a string
buffer. But once the context closes, we want all those
strings in something more convenient, like a list.</p>
<p>So, we can define a new class that derives from the 
list class, and just adds <code>__enter__()</code> and <code>__exit__()</code>
methods, to enable this list to be a context manager:</p>
<div class="highlight"><pre><span></span><span class="kr">class</span> <span class="nx">CaptureStdout</span><span class="p">(</span><span class="nx">list</span><span class="p">)</span><span class="o">:</span>
    <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    A utility object that uses a context manager</span>
<span class="s2">    to capture stdout from Snakemake. Useful when</span>
<span class="s2">    creating the directed acyclic graph.</span>
<span class="s2">    &quot;&quot;&quot;</span>
    <span class="nx">def</span> <span class="nx">__init__</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span><span class="o">*</span><span class="nx">args</span><span class="p">,</span><span class="o">**</span><span class="nx">kwargs</span><span class="p">)</span><span class="o">:</span>
        <span class="nx">pass</span>

    <span class="nx">def</span> <span class="nx">__enter__</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span><span class="o">*</span><span class="nx">args</span><span class="p">,</span><span class="o">**</span><span class="nx">kwargs</span><span class="p">)</span><span class="o">:</span>
        <span class="nx">pass</span>

    <span class="nx">def</span> <span class="nx">__exit__</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span><span class="o">*</span><span class="nx">args</span><span class="p">,</span><span class="o">**</span><span class="nx">kwargs</span><span class="p">)</span><span class="o">:</span>

    <span class="p">...</span>
</pre></div>


<p>(Note that we include the constructor, since we
need the context manager to have a state so that
we can restore the original runtime context to
the way it was when we're done.)</p>
<p><a name="_init"></a></p>
<h3>Constructor</h3>
<p>The constructor is where we process any input
arguments passed in when the context is created.</p>
<p>Given that we want our context manager to handle
the case of a directed acyclic graph by capturing
stdout, and do nothing otherwise, we should have
a flag in the constructor indicating whether
we want to pass stdout through, or whether we
want to capture it.</p>
<p>Additionally, we don't need to call the parent
(super) class constructor, i.e., the list constructor,
because we always start with an empty list.
No need to call <code>super().__init__()</code>.</p>
<p>Here is the constructor:</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CaptureStdout</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A utility object that uses a context manager</span>
<span class="sd">    to capture stdout from Snakemake. Useful when</span>
<span class="sd">    creating the directed acyclic graph.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">passthru</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="c1"># Boolean: should we pass everything through to stdout?</span>
        <span class="c1"># (this object is only functional if passthru is False)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">passthru</span> <span class="o">=</span> <span class="n">passthru</span>
</pre></div>


<p><a name="_enter"></a></p>
<h3>Enter method</h3>
<p>When we open the context, we want to swap out
<code>sys.stdout</code> with a string buffer. But we also
want to save the original <code>sys.stdout</code> object
reference, so that we can restore the original
runtime context and let the program continue
printing to stdout after Snakemake is done.</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">StringIO</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="k">class</span> <span class="nc">CaptureStdout</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>

    <span class="o">...</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Open a new context with this CaptureStdout</span>
<span class="sd">        object. This happens when we say</span>
<span class="sd">        &quot;with CaptureStdout() as output:&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If we are just passing input on to output, pass thru</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">passthru</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="c1"># Otherwise, we want to swap out sys.stdout with</span>
        <span class="c1"># a StringIO object that will save stdout.</span>
        <span class="c1"># </span>
        <span class="c1"># Save the existing stdout object so we can</span>
        <span class="c1"># restore it when we&#39;re done</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stdout</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
        <span class="c1"># Now swap out stdout </span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stringio</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>
</pre></div>


<p><a name="_exit"></a></p>
<h3>Exit method</h3>
<p>To clean up, we will need to restore <code>sys.stdout</code>
using the pointer we saved in <code>__enter__</code>, then
process the string buffer.</p>
<p>We can also use the <code>del</code> operator to clean up
the space used by the buffer object once we've
transferred its contents.</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">StringIO</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="k">class</span> <span class="nc">CaptureStdout</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>

    <span class="o">...</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Close the context and clean up.</span>
<span class="sd">        The *args are needed in case there is an</span>
<span class="sd">        exception (we don&#39;t deal with those here).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If we are just passing input on to output, pass thru</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">passthru</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="c1"># This entire class extends the list class,</span>
        <span class="c1"># so we call self.extend() to add a list to </span>
        <span class="c1"># the end of self (in this case, all the new</span>
        <span class="c1"># lines from our StringIO object).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stringio</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">())</span>

        <span class="c1"># Clean up (if this is missing, the garbage collector</span>
        <span class="c1"># will eventually take care of this...)</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stringio</span>

        <span class="c1"># Clean up by setting sys.stdout back to what</span>
        <span class="c1"># it was before we opened up this context.</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stdout</span>
</pre></div>


<p><a name="action"></a></p>
<h3>In action</h3>
<p>To see the context manager in action, let's go back to
the snippet of code where we call the Snakemake API:</p>
<div class="highlight"><pre><span></span>        <span class="c1"># Set up a context manager to capture stdout if we&#39;re building</span>
        <span class="c1"># a directed acyclic graph (which prints the graph in dot format</span>
        <span class="c1"># to stdout instead of to a file).</span>
        <span class="c1"># If we are not bulding a dag, pass all output straight to stdout</span>
        <span class="c1"># without capturing any of it.</span>
        <span class="n">passthru</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">building_dag</span>
        <span class="k">with</span> <span class="n">CaptureStdout</span><span class="p">(</span><span class="n">passthru</span><span class="o">=</span><span class="n">passthru</span><span class="p">)</span> <span class="k">as</span> <span class="n">output</span><span class="p">:</span>
            <span class="c1"># run!!</span>
            <span class="c1"># params file becomes snakemake configfile</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">snakemake</span><span class="o">.</span><span class="n">snakemake</span><span class="p">(</span><span class="n">snakefile</span><span class="p">,</span> <span class="n">configfile</span><span class="o">=</span><span class="n">paramsfile</span><span class="p">,</span> <span class="n">use_conda</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> 
                                     <span class="n">targets</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;eelpond&#39;</span><span class="p">],</span> <span class="n">printshellcmds</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> 
                                     <span class="n">cores</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">threads</span><span class="p">,</span> <span class="n">cleanup_conda</span><span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">cleanup_conda</span><span class="p">,</span>
                                     <span class="n">dryrun</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">dry_run</span><span class="p">,</span> <span class="n">lock</span><span class="o">=</span><span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">nolock</span><span class="p">,</span>
                                     <span class="n">unlock</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">unlock</span><span class="p">,</span>
                                     <span class="n">verbose</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span> <span class="n">debug_dag</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span> 
                                     <span class="n">conda_prefix</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">conda_prefix</span><span class="p">,</span> 
                                     <span class="n">create_envs_only</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">create_envs_only</span><span class="p">,</span>
                                     <span class="n">restart_times</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">restart_times</span><span class="p">,</span>
                                     <span class="n">printdag</span><span class="o">=</span><span class="n">building_dag</span><span class="p">,</span> <span class="n">keepgoing</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">keep_going</span><span class="p">,</span>
                                     <span class="n">forcetargets</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">forcetargets</span><span class="p">,</span><span class="n">forceall</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">forceall</span><span class="p">)</span>
</pre></div>


<p>Once we have closed the runtime context, our variable
<code>output</code> is a list with all the output from Snakemake
(assuming we're creating a dag; if not, everything is
passed through to stdout like normal).</p>
<p>The last bit here is to handle the three different
dag flags: <code>--dag</code>, <code>--dagfile</code>, and <code>--dagpng</code>.</p>
<ul>
<li>
<p><code>--dag</code> prints the dot graph straight to stdout,
  like Snakemake's default dag behavior;</p>
</li>
<li>
<p><code>--dagfile=&lt;dotfile&gt;</code> dumps the dot graph to a 
  dot file</p>
</li>
<li>
<p><code>--dagpng=&lt;pngfile&gt;</code> uses dot (installed in the
  elvers conda environment) to render the dot output
  from Snakemake directly into a png image</p>
</li>
</ul>
<p>We handle these three cases like so:</p>
<div class="highlight"><pre><span></span>        if building_dag:

            # These three --build args are mutually exclusive,
            # and are checked in order of precedence (hi to low):
            # --dag         to stdout
            # --dagfile     to .dot
            # --dagpng      to .png

            if args.dag:
                # straight to stdout
                print(&quot;\n&quot;.join(output))

            elif args.dagfile:
                with open(args.dagfile,&#39;w&#39;) as f:
                    f.write(&quot;\n&quot;.join(output))
                print(f&quot;\tPrinted workflow dag to dot file {args.dagfile}\n\n &quot;)

            elif args.dagpng:
                # dump dot output to temporary dot file
                with open(&#39;.temp.dot&#39;,&#39;w&#39;) as f:
                    f.write(&quot;\n&quot;.join(output))
                subprocess.call([&#39;dot&#39;,&#39;-Tpng&#39;,&#39;.temp.dot&#39;,&#39;-o&#39;,args.dagpng])
                subprocess.call([&#39;rm&#39;,&#39;-f&#39;,&#39;.temp.dot&#39;])
                print(f&quot;\tPrinted workflow dag to png file {args.dagpng}\n\n &quot;)
</pre></div>


<p>Note that before the Snakemake API call, we also check
whether <code>dot</code> exists:</p>
<div class="highlight"><pre><span></span>        # if user specified --dagpng,
        # graphviz dot must be present
        if args.dagpng:
            if shutil.which(&#39;dot&#39;) is None:
                sys.stderr.write(f&quot;\n\tError: Cannot find &#39;dot&#39; utility, but --dotpng flag was specified. Fix this by installing graphviz dot.\n\n&quot;)
                sys.exit(-1)
</pre></div>


<p>The final code is implemented in the <a href="https://github.com/dib-lab/eelpond/tree/cmr_better_dag_handling"><code>cmr_better_dag_handling</code> branch of eelpond/elvers</a>
and <a href="https://github.com/dib-lab/eelpond/pull/73">pull request #73 in eelpond/elvers</a>.</p>
<p><a name="using"></a></p>
<h2>Using the new dag flags</h2>
<div class="highlight"><pre><span></span>$ git clone https://github.com/dib-lab/eelpond.git
$ <span class="nb">cd</span> eelpond
$ conda env create --file environment.yml -n eelpond
$ conda activate eelpond
</pre></div>


<p>Now we're ready to run the workflow.
We can use the <code>-w</code> flag to list all workflows,
then use the <code>-n</code> flag to do a dry run.</p>
<p>We'll use the <code>kmer_trim</code> workflow target:</p>
<div class="highlight"><pre><span></span>$ ./run_eelpond examples/nema.yaml kmer_trim -n

...lots of output...

Job counts:
    count   <span class="nb">jobs</span>
    <span class="m">1</span>   eelpond
    <span class="m">10</span>  http_get_fq1
    <span class="m">10</span>  http_get_fq2
    <span class="m">10</span>  khmer_pe_diginorm
    <span class="m">10</span>  khmer_split_paired
    <span class="m">10</span>  trimmomatic_pe
    <span class="m">51</span>
This was a dry-run <span class="o">(</span>flag -n<span class="o">)</span>. The order of <span class="nb">jobs</span> does not
reflect the order of execution.
</pre></div>


<p>Now we can create a dag for this workflow target:</p>
<div class="highlight"><pre><span></span>$ ./run_eelpond examples/nema.yaml kmer_trim --dagfile<span class="o">=</span>dag_kmertrimming.dot
    Added default parameters from rule-specific params files.
    Writing full params to examples/.ep_nema.yaml
Building DAG of jobs...
    Printed workflow dag to dot file dag_kmertrimming.dot
</pre></div>


<p>Finally, we can use the <code>--dagpng</code> flag for instant
gratification:</p>
<div class="highlight"><pre><span></span>$ ./run_eelpond examples/nema.yaml kmer_trim --dagpng<span class="o">=</span>dag_kmertrimming.png
    Added default parameters from rule-specific params files.
    Writing full params to examples/.ep_nema.yaml
Building DAG of jobs...
    Printed workflow dag to png file dag_kmertrimming.png
</pre></div>


<p>Note that you can add a line <code>rankdir=LR;</code> to your dot
file to change the orientation of the graph (left-to-right
order makes highly-parallel workflows vertically stretched,
so they are eaiser to view).</p>
<div class="highlight"><pre><span></span>digraph mydigraph {

    rankdir=LR;

    ...
</pre></div>


<p>and here is the result:</p>
<p><img alt="elvers dag" src="/images/elvers_dag.png"></p>
<p><a name="other"></a></p>
<h2>Other context manager applications</h2>
<p>Actions requiring temporary contexts, which are a bit like self-contained
workspaces, are good candidates for context managers. Following are a
few examples and references.</p>
<p><br /></p>
<p><a name="ssh"></a>
<strong>SSH connections:</strong> the context manager's <code>__enter__</code> function creates/loads
connection details, creates a connection object, and opens the connection.
The <code>__exit__</code> function cleans up by closing the connection. This way,
you can say something like</p>
<div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">SSHConnectionManager</span><span class="p">(</span><span class="n">device</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span><span class="s2">&quot;echo hello world&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Enountered an error running remote command&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</pre></div>


<p>Blog post: <a href="https://packetpushers.net/using-python-context-managers/">Using Python Context Managers for SSH connections</a></p>
<p>(Note: this blog post uses a context manager that is a generator
decorated with a context manager utility function; this is a 
different approach than our class-based approach but is still
valid.</p>
<p><br /></p>
<p><a name="figs"></a>
<strong>iPython notebook and matplotlib figure management:</strong> Camille Scott has
<a href="http://www.camillescott.org/2014/05/05/context-management/">a blog post</a> 
covering a way of managing large Jupyter notebooks with
lots of figures using context managers. In this case, the context
that is being set up and torn down is a matplotlib plot context,
and it is creating each plot, saving it to a file, then closing
the plot. This makes the notebook a lot faster than trying to render
every single plot, and makes it a lot cleaner than littering the code
with manual figure and axis management.</p>
<p>Here is the example usage Camille gives:</p>
<div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">FigManager</span><span class="p">(</span><span class="s1">&#39;genes_per_sample&#39;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">tall_size</span><span class="p">)</span> <span class="k">as</span> <span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">):</span>
    <span class="n">genes_support_df</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;barh&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> 
                                <span class="n">color</span><span class="o">=</span><span class="n">labels_df</span><span class="o">.</span><span class="n">color</span><span class="p">,</span> 
                                <span class="n">figure</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Represented Genes per Sample&#39;</span><span class="p">)</span>

<span class="n">FileLink</span><span class="p">(</span><span class="s1">&#39;genes_per_sample.svg&#39;</span><span class="p">)</span>
</pre></div>


<p>(The <code>FileLink</code> function opens/processes the resulting image.)</p>
<p>Nice!</p>
<p>Blog post: <a href="http://www.camillescott.org/2014/05/05/context-management/">Context Managers and IPython Notebook</a></p>
<p><br /></p>
<p><a name="dbconn"></a>
<strong>Database Connection:</strong> this example comes from Django's test suite.
In it, a context manager is defined that creates new MySQL database
connections when the context is opened, and closes them when the
context is done.</p>
<p>Here is the context manager, which again uses the decorator + generator
approach rather than the class approach:</p>
<p><strong><code>django/tests/backends/mysql/tests.py</code>:</strong></p>
<div class="highlight"><pre><span></span><span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">get_connection</span><span class="p">():</span>
    <span class="n">new_connection</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">new_connection</span>
    <span class="n">new_connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>


<p>(<a href="https://github.com/django/django/blob/master/tests/backends/mysql/tests.py">Link to file on Github</a>)</p>
<p>The first two lines of this function are equivalent to an <code>__enter__</code> method,
while the last line is equivalent to an <code>__exit__</code> method.</p>
<p>This context manager is then used like so:</p>
<div class="highlight"><pre><span></span>    <span class="k">with</span> <span class="n">get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">new_connection</span><span class="p">:</span>
        <span class="n">new_connection</span><span class="o">.</span><span class="n">settings_dict</span><span class="p">[</span><span class="s1">&#39;OPTIONS&#39;</span><span class="p">][</span><span class="s1">&#39;isolation_level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">other_isolation_level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_isolation_level</span><span class="p">(</span><span class="n">new_connection</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isolation_values</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">other_isolation_level</span><span class="p">]</span>
        <span class="p">)</span>
</pre></div>


<p>The context manager is a convenient way of creating a copy
of an existing MySQL connection, then closing it when the
requesting method is finished using it.</p>
<p><br />
<br /></p>
<p><a name="refs"></a></p>
<h2>References</h2>
<ol>
<li>
<p><a href="https://github.com/dib-lab/eelpond">elvers (dib-lab/eelpond on Github)</a>,</p>
<ul>
<li>Author: <a href="https://github.com/bluegenes">@bluegenes on Github</a></li>
<li><a href="https://github.com/dib-lab/eelpond/pull/69">PR adding <code>--dag</code> flag</a>,</li>
<li><a href="https://github.com/dib-lab/eelpond/pull/73">PR adding <code>--dagfile</code> and <code>--dagpng</code> flags</a></li>
</ul>
</li>
<li>
<p><a href="https://khmer-protocols.readthedocs.io/en/latest/mrnaseq/index.html">eelpond mRNAseq workflow</a>.</p>
<ul>
<li>this mRNAseq data processing protocol
  served as the original inspiration for
  elvers</li>
</ul>
</li>
<li>
<p><a href="https://docs.python.org/3/reference/datamodel.html#context-managers">Context managers (Python documentation)</a></p>
</li>
<li>
<p><a href="https://www.python.org/dev/peps/pep-0343/">PEP 343 - the "with" statement</a></p>
</li>
<li>
<p><a href="https://snakemake.readthedocs.io/en/stable/">Snakemake</a></p>
</li>
<li>
<p><a href="https://graphviz.org/">Graphviz dot</a></p>
</li>
<li>
<p><a href="https://charlesreid1.github.io/building-snakemake-command-line-wrappers-for-workflows.html">Building Snakemake Command Line Wrappers for Workflows (charlesreid1 blog)</a></p>
</li>
</ol></div>

    </div>
</div>

<div class="v20"></div>

<div class="row">
    <div class="col-md-12" style="text-align: left;">

        <div class="tags">
            <p>Tags:&nbsp;&nbsp;&nbsp;
                    <a href="https://charlesreid1.github.io/tag/context-managers.html">context managers</a>
                    &nbsp;&nbsp;
                    <a href="https://charlesreid1.github.io/tag/testing.html">testing</a>
                    &nbsp;&nbsp;
                    <a href="https://charlesreid1.github.io/tag/python.html">python</a>
                    &nbsp;&nbsp;
                    <a href="https://charlesreid1.github.io/tag/programming.html">programming</a>
                    &nbsp;&nbsp;
        </div>

    </div>
</div>


<div class="v200"></div>

</div>


<script type="text/javascript" src="https://charlesreid1.github.io/theme/js/jquery-1.11.2.js"></script>
<script type="text/javascript" src="https://charlesreid1.github.io/theme/js/bootstrap-3.3.4.js"></script>
<script type="text/javascript" src="https://charlesreid1.github.io/theme/js/d3-3.5.5.js"></script><script type="text/javascript" src="https://charlesreid1.github.io/theme/js/jquery-1.11.2.js"></script>
<script type="text/javascript" src="https://charlesreid1.github.io/theme/js/bootstrap-3.3.4.js"></script>

<footer id="contentinfo" class="body">
<p>&nbsp;</p>
<p>&nbsp;</p>
<center>
	<hr />
</center>
<p>&nbsp;</p>
<p style="text-align: center">
    <span class="fa-stack fa-lg">
        <i class="fa fa-square fa-stack-2x" style="color:#000;"></i>
        <i class="fa fa-terminal fa-stack-1x fa-inverse"></i>
    </span>
    Made from the command line with vim by 
    <a href="http://charlesreid1.com">charlesreid1</a><br />
    with help from <a href="https://getbootstrap.com/">Bootstrap</a> and <a href="http://getpelican.com">Pelican</a>.
</p>

<br />

<p style="text-align: center">
    <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">
    <span class="fa-stack fa-lg">
        <i class="fa fa-square fa-stack-2x" style="color:#000;"></i>
        <i class="fa fa-creative-commons fa-stack-1x fa-inverse"></i>
    </span>
    </a>
    <br />
    Licensed under the <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">Creative Commons Attribution-NonCommercial 4.0 License</a>.
</p>

<!-- Start of StatCounter Code for Default Guide -->
<script type="text/javascript">
var sc_project=11611748;
var sc_invisible=1;
var sc_security="9fcba820";
</script>
<script type="text/javascript"
src="https://www.statcounter.com/counter/counter.js"
async></script>

<noscript><div class="statcounter"><a title="Web Analytics"
href="http://statcounter.com/" target="_blank"><img
class="statcounter"
src="//c.statcounter.com/11611748/0/9fcba820/1/" alt="Web
Analytics"></a></div></noscript>
<!-- End of StatCounter Code for Default Guide -->
</footer><!-- /#contentinfo -->
</body>
</html>