<!DOCTYPE html>
<html lang="en">
<head>
        <title>charlesreid1</title>
        <meta charset="utf-8" />

        <!--
        CSS styles
        -->
        <link href="https://charlesreid1.github.io/theme/css/bootstrap.css"       rel="stylesheet" type="text/css">
        <link href="https://charlesreid1.github.io/theme/css/slate.css"              rel="stylesheet" type="text/css">
        <link href="https://charlesreid1.github.io/theme/css/font-awesome.css"       rel="stylesheet" type="text/css"/>
        <link href="https://charlesreid1.github.io/theme/css/pygment-solarized.css"  rel="stylesheet" type="text/css"/>

        <!--
        my CSS styles
        -->
        <link href="https://charlesreid1.github.io/theme/css/main.css"            rel="stylesheet" type="text/css">
        <link href="https://charlesreid1.github.io/theme/css/dox.css"             rel="stylesheet" type="text/css">


        <!--
        include Angular first
        -->
        <script type="text/javascript" src="https://charlesreid1.github.io/theme/js/angular-1.3.15.js"></script>
        <script type="text/javascript" src="https://charlesreid1.github.io/theme/js/skrollr-0.6.29.js"></script>
        <script type="text/javascript" src="https://charlesreid1.github.io/theme/js/d3-3.5.5.js"></script>

        <!--
        this seems like a bad idea.
        but if I don't put jquery first, I get errors about unrecognized $s.
        -->
        <script type="text/javascript" src="https://charlesreid1.github.io/theme/js/jquery-1.11.2.js"></script>

</head>
<body id="index">
<nav class="navbar navbar-default">
    <div class="container-fluid">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span> 
            </button>
            <a href="https://charlesreid1.github.io" class="navbar-brand">charlesreid1.github.io</a>
        </div>
        <div>
            <div class="collapse navbar-collapse" id="myNavbar">
                <ul class="nav navbar-nav">

                    <li>
                        <a href="https://charlesreid1.com/wiki">Wiki</a>
                    </li>
                    <li>
                        <a href="https://git.charlesreid1.com/explore">Git</a>
                    </li>
                    <li>
                        <a href="http://spotify.charlesreid1.com">Music</a>
                    </li>
                    <li>
                        <a href="https://charlesreid1.com/life">Life</a>
                    </li>
                    <li>
                        <a href="https://charlesreid1.github.io">Blog</a>
                    </li>
                    <li>
                        <a href="https://charlesreid1.com/about">About Me</a>
                    </li>

                </ul>
            </div>
        </div>
    </div>
</nav>



<div class="container">

<header>
<div class="row">


    <div class="col-md-12">
        <div class="headtext" style="text-align: center;">
            <h1><b>
                Python Patterns: The Registry
            </b></h1>
        
            <p class="lead">
                Posted 
                <time datetime="2020-02-20T22:22:00-08:00" pubdate>Thursday 02/20/2020</time>
                in 
                <a href="https://charlesreid1.github.io/category/python.html">Python</a>
                </p>
            <p>
            <span style="font-size: 14px">
                <a href="https://charlesreid1.github.io/python-patterns-the-registry.html">permalink</a>
            </span>
            </p>
        </div>

    </div>

</div>
</header>


<div class="v50"></div>


<div class="row">
    <div class="col-md-12" style="text-align: left;">

        <div class="entry-content"><h1>Table of Contents</h1>
<ul>
<li><a href="#overview">Overview</a></li>
<li><a href="#what-is-the-registry-pattern">What is the Registry Pattern?</a><ul>
<li><a href="#the-registry-base-type">The Registry Base Type</a></li>
<li><a href="#the-base-registered-class">The Base Registered Class</a></li>
<li><a href="#extending-the-base-registered-class">Extending the Base Registered Class</a></li>
<li><a href="#seeing-it-in-action">Seeing it in action</a></li>
</ul>
</li>
<li><a href="#examples">Examples</a><ul>
<li><a href="#example-search-engine">Example: Search Engine</a><ul>
<li><a href="#registry-subclasses">Registry Subclasses</a></li>
<li><a href="#doctype-registry-base-type">Doctype Registry Base Type</a></li>
<li><a href="#base-registered-doctype-class">Base Registered Doctype Class</a></li>
<li><a href="#derived-registered-doctype-class">Derived Registered Doctype Class</a></li>
<li><a href="#using-the-registry">Using the Registry</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#further-modifications">Further Modifications</a></li>
<li><a href="#summary">Summary</a></li>
</ul>
<h1>Overview</h1>
<p>This post is a summary of a useful Python programming pattern called the Registry pattern.</p>
<p>The Registry pattern is a way of keeping track of all subclasses of a given class.</p>
<p>More details about this pattern are available at <a href="https://github.com/faif/python-patterns">https://github.com/faif/python-patterns</a>.</p>
<h1>What is the Registry Pattern?</h1>
<p>Let's start with a common scenario: you have some kind of manager class that is
managing multiple related subclasses, and you are looking for a simpler way to
manage the subclasses.</p>
<p>The registry pattern creates a map of labels to class types, and allows you to
access a single registry common to all of those classes. The registry is updated
every time a new class is added.</p>
<p>This is useful for several situations, including these two examples:</p>
<ul>
<li>You want the manager class to iterate over every available subclass and call a
  particular method on each subclass</li>
<li>You want to streamline a factory class, which takes an input label (like the name
  of a class) and creates/returns an object of that type</li>
</ul>
<h2>The Registry Base Type</h2>
<p>We start by defining a registry base type (or class). This class defines one behavior,
which is adding itself to the class registry. It creates a shared instance variable called
<code>REGISTRY</code> which is shared amongst all of the classes, and is also accessible via a class
method.</p>
<p>This is the base class; any class we want registered should inherit from this class.
It should also extend the <code>type</code> class, since it is itself a class type:</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">RegistryBase</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>

    <span class="n">REGISTRY</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="c1"># instantiate a new type corresponding to the type of class being defined</span>
        <span class="c1"># this is currently RegisterBase but in child classes will be the child class</span>
        <span class="n">new_cls</span> <span class="o">=</span> <span class="nb">type</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">REGISTRY</span><span class="p">[</span><span class="n">new_cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_cls</span>
        <span class="k">return</span> <span class="n">new_cls</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_registry</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">REGISTRY</span><span class="p">)</span>
</pre></div>


<p>The design here is subtle, but the details are important to understand how it works.</p>
<p>A few important things to note, progressing from top to bottom:</p>
<ul>
<li>
<p>The <code>REGISTRY</code> variable is defined outside the scope of any class methods, meaning it is a
  shared instance variable (a variable that is shared across all instances of <code>RegistryBase</code>);
  this is an example of the Borg pattern.</p>
</li>
<li>
<p>The <code>RegistryBase</code> class defines <code>__new__</code>, not <code>__init__</code>; the <code>__new__</code> method is run when
  the class is defined, while <code>__init__</code> is run when the classs is instantiated. This ensures
  that any subclasses that inherit from <code>RegistryBase</code> add themselves to the registry when they
  are defined, not when they are instantiated.</p>
</li>
<li>
<p>In the constructor, we store a reference to the current class using this line:</p>
</li>
</ul>
<p><code>new_cls = type.__new__(cls, name, bases, attrs)</code></p>
<p>This creates a new class, but of type <code>type</code> (confusing, but basically it means we store
  a reference to this <em><strong>type</strong></em> of object, not just a reference to a particular object).</p>
<p>It is important to note that once we use the registry, the value that is returned is callable,
  and will create an object corresponding to that type.</p>
<ul>
<li>We define a <code>get_registry</code> method to return a copy of the registry; this must be decorated with
  a <code>@classmethod</code> decorator (not a <code>@staticmethod</code> decorator) so that it has access to the registry,
  which is a class instance variable.</li>
</ul>
<p><strong>BONUS NOTE:</strong> From prior experience, we have found it easiest to ignore the case of the
label (uppercase, lowercase, CamelCase, etc) and convert all class names to lowercase in the
registry:</p>
<div class="highlight"><pre><span></span>        <span class="bp">cls</span><span class="o">.</span><span class="n">REGISTRY</span><span class="p">[</span><span class="n">new_cls</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="n">new_cls</span>
</pre></div>


<h2>The Base Registered Class</h2>
<p>Now we can define a base class that will extend the <code>RegistryBase</code> class. However, because <code>RegistryBase</code>
is a <code>type</code> class, we shouldn't extend it directly - we should use it as a <em>metaclass</em>.</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">BaseRegisteredClass</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">RegistryBase</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>


<p>Any class that inherits from this <code>BaseRegisteredClass</code> will now be included in the registry when it is
defined.</p>
<h2>Extending the Base Registered Class</h2>
<p>The next step is to use the base registered class to start creating interesting classes:</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ExtendedRegisteredClass</span><span class="p">(</span><span class="n">BaseRegisteredClass</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">pass</span>
</pre></div>


<p>We skip defining constructor behavior, as the call order is what's important.</p>
<h2>Seeing it in action</h2>
<p>Now we can see the process of adding subclasses to the registry in action.</p>
<p>Start by checking the registry before we have created any subclasses:</p>
<div class="highlight"><pre><span></span>&gt;&gt;&gt; print(RegistryHolder.REGISTRY)
[&#39;BaseRegisteredClass&#39;]
</pre></div>


<p>Next, define the extended registered class:</p>
<div class="highlight"><pre><span></span>&gt;&gt;&gt; class ExtendedRegisteredClass(BaseRegisteredClass):
...     def __init__(self, *args, **kwargs):
...         pass
</pre></div>


<p>Remember, we add the new class to the registry in the <code>__new__</code> method, not the
<code>__init__</code> method, so we don't even need to instantiate an <code>ExtendedRegisteredClass</code>
object for it to be added to the registry. Check the registry again:</p>
<div class="highlight"><pre><span></span>&gt;&gt;&gt; print(RegistryHolder.REGISTRY)
[&#39;BaseRegisteredClass&#39;, &#39;ExtendedRegisteredClass&#39;]
</pre></div>


<h1>Examples</h1>
<p>Let's consider a specific example to help illustrate the usefulness of the Registry pattern:
adding the ability to index different kinds of documents to a search engine.</p>
<h2>Example: Search Engine</h2>
<p>Suppose we are writing a search engine, and we are working on the search engine
backend. Specifically, consider the backend portion that iterates over a group of
documents, checks if the document is already in the search index, and either adds
a new item to the search index, updates an existing item in the search index, or
deletes an item from the search index.</p>
<h3>Registry Subclasses</h3>
<p>A search engine may index multiple kinds of documents, each living in different locations.
For example, a search index may index .docx files in a Google Drive folder,
Github issues, and/or a local folder full of Markdown files. For each of these
document types, we must define:</p>
<ul>
<li>
<p>How to add or update all documents in the document storage system (Google Drive, Github
  API, local filesystem, etc.); this method should be able to get a list of documents of this
  document type that are already in the search index, either by running a query itself, or by
  accepting a list of documents already in the index as an input argument</p>
</li>
<li>
<p>What schema to use (mapping various field names to data types) for documents of this type</p>
</li>
<li>
<p>How to display search results when they are documents of this type (i.e., how to display
  what fields when showing the user search results)</p>
</li>
</ul>
<p>This can be done by defining classes corresponding to different document types, where
each class defines how to do the above actions, and wraps them in high-level API methods
that the manager classes can call.</p>
<p>The manager classes want a way to get a list of available document types, and to call
each document type's high-level API methods. This can be done with the registry.</p>
<h3>Doctype Registry Base Type</h3>
<p>Start by defining a base type that will register new subclasses in a doctype registry. Note that
as per the <a href="https://docs.python.org/3/reference/datamodel.html#object.__new__"><code>__new__</code> documentation</a>,
the <code>__new__</code> method takes the class (in our case, a class of type <code>type</code>) as the first argument <code>cls</code>,
and it should return a new object instance (which, again, is an instance of type <code>type</code>).</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">DoctypeRegistryBase</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>

    <span class="n">DOCTYPE_REGISTRY</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="n">new_cls</span> <span class="o">=</span> <span class="nb">type</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">DOCTYPE_REGISTRY</span><span class="p">[</span><span class="n">new_cls</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="n">new_cls</span>
        <span class="k">return</span> <span class="n">new_cls</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_doctype_registry</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">DOCTYPE_REGISTRY</span><span class="p">)</span>
</pre></div>


<h3>Base Registered Doctype Class</h3>
<p>Next, we define a base class for any document type that we want registered in the doctype
registry, using <code>DoctypeRegistryBase</code> as our metaclass (because it is a class of type <code>type</code>,
as opposed to a normal class).  All document types are required to define three bits of behavior
(interacting with the document storage system to iterate over all documents; extracting information
from individual documents; and displaying a given document type when it is a search result. We
define these virtual methods on the base registered doctype class.</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">BaseRegisteredDoctypeClass</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">DoctypeRegistryBase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">add_update_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Iterate over all documents in the document storage system</span>
<span class="sd">        and add/update/delete documents as needed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assemble and return the schema (map of field names to data types)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">render_search_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Use a Jinja template to render a single search result of type doctype</span>
<span class="sd">        to display to the user via the web interface</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</pre></div>


<h3>Derived Registered Doctype Class</h3>
<p>Now that we have a base class, we can define child classes that have the specific
API functionality needed.</p>
<p>Here is a high-level sketch of what the Github issue document type class might look like,
starting with the add/update/delete method, which boils down to some set operations to determine
what documents to add, update, or delete from the search index.</p>
<p>(Also note, these methods are defined as class methods because they are called once for each
doctype class, but this does not necessarily need to be the case.)</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">GithubIssueDoctype</span><span class="p">(</span><span class="n">BaseRegisteredDoctypeClass</span><span class="p">):</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">add_update_delete</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Get set of indexed document IDs</span>
        <span class="n">indexed_docs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">run_search_index_query</span><span class="p">(</span><span class="n">doctype</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">indexed_docs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="c1"># Get set of remote document IDs</span>
        <span class="n">remote_docs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">org_name</span> <span class="ow">in</span> <span class="n">get_org_names</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">repo_name</span> <span class="ow">in</span> <span class="n">get_repo_names</span><span class="p">(</span><span class="n">org_name</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">get_repo_files</span><span class="p">(</span><span class="n">repo_name</span><span class="p">,</span> <span class="n">org_name</span><span class="p">):</span>
                    <span class="n">remote_docs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="c1"># Do some set math to figure out what to add/update/delete</span>
        <span class="n">add_ids</span> <span class="o">=</span> <span class="n">remote_docs</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">indexed_docs</span><span class="p">)</span>
        <span class="n">update_ids</span> <span class="o">=</span> <span class="n">indexed_docs</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">remote_docs</span><span class="p">)</span>
        <span class="n">delete_ids</span> <span class="o">=</span> <span class="n">indexed_docs</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">remote_docs</span><span class="p">)</span>

        <span class="c1"># Do the operations</span>
        <span class="k">for</span> <span class="n">add_id</span> <span class="ow">in</span> <span class="n">add_ids</span><span class="p">:</span>
            <span class="n">add_document_to_index</span><span class="p">(</span><span class="n">add_id</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">update_id</span> <span class="ow">in</span> <span class="n">update_ids</span><span class="p">:</span>
            <span class="n">update_document_in_index</span><span class="p">(</span><span class="n">update_id</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">delete_id</span> <span class="ow">in</span> <span class="n">delete_ids</span><span class="p">:</span>
            <span class="n">delete_document_in_index</span><span class="p">(</span><span class="n">delete_id</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_schema</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="o">...</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">render_search_result</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="o">...</span>
</pre></div>


<p>Now we do the same for documents on Google Drive, defining a different <code>add_update_delete()</code> method
specific to Google Drive documents (note that while the sketch of this method looks similar to the
Github doctype above, the implementation will look more and more different as we include more and more
detail in our method and API calls).</p>
<p>As before, we make these methods class methods.</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">GoogleDocsDoctype</span><span class="p">(</span><span class="n">BaseRegisteredDoctypeClass</span><span class="p">):</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">add_update_delete</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Get set of indexed document IDs</span>
        <span class="n">indexed_dcos</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">run_search_index_query</span><span class="p">(</span><span class="n">doctype</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">indexed_docs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="c1"># Get set of remote document IDs</span>
        <span class="n">remote_docs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">get_gdrive_file_list</span><span class="p">():</span>
            <span class="n">remote_docs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="c1"># Do some math to figure out what to add/update/delete</span>
        <span class="n">add_ids</span> <span class="o">=</span> <span class="n">remote_docs</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">indexed_docs</span><span class="p">)</span>
        <span class="n">update_ids</span> <span class="o">=</span> <span class="n">indexed_docs</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">remote_docs</span><span class="p">)</span>
        <span class="n">delete_ids</span> <span class="o">=</span> <span class="n">indexed_docs</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">remote_docs</span><span class="p">)</span>

        <span class="c1"># Do the operations</span>
        <span class="k">for</span> <span class="n">add_id</span> <span class="ow">in</span> <span class="n">add_ids</span><span class="p">:</span>
            <span class="n">add_document_to_index</span><span class="p">(</span><span class="n">add_id</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">update_id</span> <span class="ow">in</span> <span class="n">update_ids</span><span class="p">:</span>
            <span class="n">update_document_in_index</span><span class="p">(</span><span class="n">update_id</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">delete_id</span> <span class="ow">in</span> <span class="n">delete_ids</span><span class="p">:</span>
            <span class="n">delete_document_in_index</span><span class="p">(</span><span class="n">delete_id</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_schema</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="o">...</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">render_search_result</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="o">...</span>
</pre></div>


<h3>Using the Registry</h3>
<p>The last step is to actually use the registry from the class that manages all of our subclasses.
In this case, we have a <code>Search</code> class that defines high-level operations (such as, "add/update/delete
all documents indexed by this search engine") and in turn calls the corresponding method for each doctype
that has been registered.</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Search</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">add_update_delete_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="c1"># Iterate over every doc type</span>
        <span class="k">for</span> <span class="n">doctype_name</span> <span class="ow">in</span> <span class="n">DoctypeRegistryBase</span><span class="o">.</span><span class="n">DOCTYPE_REGISTRY</span><span class="p">:</span>

            <span class="c1"># Get a handle to the doctype class</span>
            <span class="n">doctype_class</span> <span class="o">=</span> <span class="n">DoctypeRegistryBase</span><span class="o">.</span><span class="n">DOCTYPE_REGISTRY</span><span class="p">[</span><span class="n">doctype_name</span><span class="p">]</span>

            <span class="c1"># Call the class method add_update_delete on the doctype class</span>
            <span class="n">doctype_class</span><span class="o">.</span><span class="n">add_update_delete</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="c1"># Note: if we need to create an instance first</span>
            <span class="c1"># doctype_instance = doctype_class()</span>
            <span class="c1"># doctype_instance.add_update_delete(*args, **kwargs)</span>
</pre></div>


<h1>Further Modifications</h1>
<p>In the example above, we don't have any need to create specific instances of the document type classes,
since they do not need to preserve their state between calls, and we only need one instance of the doctype
class per search engine.</p>
<p>We could re-implement this pattern, modifying the search engine doctype classes to be normal, non-static
classes. This would allow us to have, say, two instances of the Github issues doctype class (corresponding
to two different sets of Github API credentials, or two different Github accounts), or two instances of the
Google Drive doctype class (corresponding to two different Google Drive folders). In this case, we would
want to restructure the Search class to instantiate and save doctype class instances in the constructor,
and use them later.</p>
<p>Here's an example <code>Search</code> class that would instantiate one of each subclass in the constructor, to be used
in later methods:</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Search</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="c1"># Store instances of each doctype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_doctypes</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Iterate over every doc type</span>
        <span class="k">for</span> <span class="n">doctype_name</span> <span class="ow">in</span> <span class="n">DoctypeRegistryBase</span><span class="o">.</span><span class="n">DOCTYPE_REGISTRY</span><span class="p">:</span>

        <span class="c1"># Get a handle to the doctype class</span>
        <span class="n">doctype_class</span> <span class="o">=</span> <span class="n">DoctypeRegistryBase</span><span class="o">.</span><span class="n">DOCTYPE_REGISTRY</span><span class="p">[</span><span class="n">doctype_name</span><span class="p">]</span>

        <span class="c1"># Create an instance of type doctype_class</span>
        <span class="n">doctype_instance</span> <span class="o">=</span> <span class="n">doctype_class</span><span class="p">()</span>

        <span class="c1"># Save for later</span>
        <span class="n">all_doctypes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">doctype_instance</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_update_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="c1"># Call the add_update_delete method on each doctype instance</span>
        <span class="k">for</span> <span class="n">doctype_name</span><span class="p">,</span> <span class="n">doctype_instance</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_doctypes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">doctype_instance</span><span class="o">.</span><span class="n">add_update_delete</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>


<p>(Note that this would work best if we removed the <code>@classmethod</code> decorators from the doctype classes
defined above.)</p>
<h1>Summary</h1>
<p>In this post, we covered a useful programming pattern, the Registry, and showed it in action for one
example - allowing a search engine index to register various document type subclasses, then use those
registered subclasses to propagate calls to all document types later.</p></div>

    </div>
</div>

<div class="v20"></div>

<div class="row">
    <div class="col-md-12" style="text-align: left;">

        <div class="tags">
            <p>Tags:&nbsp;&nbsp;&nbsp;
                    <a href="https://charlesreid1.github.io/tag/python.html">python</a>
                    &nbsp;&nbsp;
                    <a href="https://charlesreid1.github.io/tag/programming.html">programming</a>
                    &nbsp;&nbsp;
                    <a href="https://charlesreid1.github.io/tag/patterns.html">patterns</a>
                    &nbsp;&nbsp;
                    <a href="https://charlesreid1.github.io/tag/design-patterns.html">design patterns</a>
                    &nbsp;&nbsp;
                    <a href="https://charlesreid1.github.io/tag/registry.html">registry</a>
                    &nbsp;&nbsp;
                    <a href="https://charlesreid1.github.io/tag/computer-science.html">computer science</a>
                    &nbsp;&nbsp;
        </div>

    </div>
</div>


<div class="v200"></div>

</div>


<script type="text/javascript" src="https://charlesreid1.github.io/theme/js/jquery-1.11.2.js"></script>
<script type="text/javascript" src="https://charlesreid1.github.io/theme/js/bootstrap-3.3.4.js"></script>
<script type="text/javascript" src="https://charlesreid1.github.io/theme/js/d3-3.5.5.js"></script><script type="text/javascript" src="https://charlesreid1.github.io/theme/js/jquery-1.11.2.js"></script>
<script type="text/javascript" src="https://charlesreid1.github.io/theme/js/bootstrap-3.3.4.js"></script>

<footer id="contentinfo" class="body">
<p>&nbsp;</p>
<p>&nbsp;</p>
<center>
	<hr />
</center>
<p>&nbsp;</p>
<p style="text-align: center">
    <span class="fa-stack fa-lg">
        <i class="fa fa-square fa-stack-2x" style="color:#000;"></i>
        <i class="fa fa-terminal fa-stack-1x fa-inverse"></i>
    </span>
    Made from the command line with vim by 
    <a href="http://charlesreid1.com">charlesreid1</a><br />
    with help from <a href="https://getbootstrap.com/">Bootstrap</a> and <a href="http://getpelican.com">Pelican</a>.
</p>

<br />

<p style="text-align: center">
    <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">
    <span class="fa-stack fa-lg">
        <i class="fa fa-square fa-stack-2x" style="color:#000;"></i>
        <i class="fa fa-creative-commons fa-stack-1x fa-inverse"></i>
    </span>
    </a>
    <br />
    Licensed under the <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">Creative Commons Attribution-NonCommercial 4.0 License</a>.
</p>

<!-- Start of StatCounter Code for Default Guide -->
<script type="text/javascript">
var sc_project=11611748;
var sc_invisible=1;
var sc_security="9fcba820";
</script>
<script type="text/javascript"
src="https://www.statcounter.com/counter/counter.js"
async></script>

<noscript><div class="statcounter"><a title="Web Analytics"
href="http://statcounter.com/" target="_blank"><img
class="statcounter"
src="//c.statcounter.com/11611748/0/9fcba820/1/" alt="Web
Analytics"></a></div></noscript>
<!-- End of StatCounter Code for Default Guide -->
</footer><!-- /#contentinfo -->
</body>
</html>