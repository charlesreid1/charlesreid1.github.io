<!DOCTYPE html>
<html lang="en">
<head>
        <title>charlesreid1</title>
        <meta charset="utf-8" />

        <!--
        CSS styles
        -->
        <link href="https://charlesreid1.github.io/theme/css/bootstrap.css"       rel="stylesheet" type="text/css">
        <link href="https://charlesreid1.github.io/theme/css/slate.css"              rel="stylesheet" type="text/css">
        <link href="https://charlesreid1.github.io/theme/css/font-awesome.css"       rel="stylesheet" type="text/css"/>
        <link href="https://charlesreid1.github.io/theme/css/pygment-solarized.css"  rel="stylesheet" type="text/css"/>

        <!--
        my CSS styles
        -->
        <link href="https://charlesreid1.github.io/theme/css/main.css"            rel="stylesheet" type="text/css">
        <link href="https://charlesreid1.github.io/theme/css/dox.css"             rel="stylesheet" type="text/css">


        <!--
        include Angular first
        -->
        <script type="text/javascript" src="https://charlesreid1.github.io/theme/js/angular-1.3.15.js"></script>
        <script type="text/javascript" src="https://charlesreid1.github.io/theme/js/skrollr-0.6.29.js"></script>
        <script type="text/javascript" src="https://charlesreid1.github.io/theme/js/d3-3.5.5.js"></script>

        <!--
        this seems like a bad idea.
        but if I don't put jquery first, I get errors about unrecognized $s.
        -->
        <script type="text/javascript" src="https://charlesreid1.github.io/theme/js/jquery-1.11.2.js"></script>

</head>
<body id="index">
<nav class="navbar navbar-default">
    <div class="container-fluid">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span> 
            </button>
            <a href="https://charlesreid1.github.io" class="navbar-brand">charlesreid1.github.io</a>
        </div>
        <div>
            <div class="collapse navbar-collapse" id="myNavbar">
                <ul class="nav navbar-nav">

                    <li>
                        <a href="https://charlesreid1.com/wiki">Wiki</a>
                    </li>
                    <li>
                        <a href="https://git.charlesreid1.com/explore">Git</a>
                    </li>
                    <li>
                        <a href="http://spotify.charlesreid1.com">Music</a>
                    </li>
                    <li>
                        <a href="https://charlesreid1.com/life">Life</a>
                    </li>
                    <li>
                        <a href="https://charlesreid1.github.io">Blog</a>
                    </li>
                    <li>
                        <a href="https://charlesreid1.com/about">About Me</a>
                    </li>

                </ul>
            </div>
        </div>
    </div>
</nav>



<div class="container">

    <div class="row">
        <div class="col-md-12 col-centered" style="text-align: center;">
            <div class="v50"></div>
            <div class="cosmojumbo">
                <h1 class="jumbojumbo">charlesreid1.com blog<h1>
            </div>
        </div>
    </div>


    <div class="v50"></div>


    <div class="row">

        <div class="col-md-8" style="text-align: center;">

  	            	<article>
<header>
<div class="row">


    <div class="col-md-12">
        <div class="headtext" style="text-align: center;">
            <h1><b>
                Python Patterns: The Registry
            </b></h1>
        
            <p class="lead">
                Posted 
                <time datetime="2020-02-20T22:22:00-08:00" pubdate>Thursday 02/20/2020</time>
                in 
                <a href="https://charlesreid1.github.io/category/computer-science.html">Computer Science</a>
                </p>
            <p>
            <span style="font-size: 14px">
                <a href="https://charlesreid1.github.io/python-patterns-the-registry.html">permalink</a>
            </span>
            </p>
        </div>

    </div>

</div>
</header>


<div class="v50"></div>


<div class="row">
    <div class="col-md-12" style="text-align: left;">

        <div class="entry-content"><h1>Table of Contents</h1>
<ul>
<li><a href="#overview">Overview</a></li>
<li><a href="#what-is-the-registry-pattern">What is the Registry Pattern?</a><ul>
<li><a href="#the-registry-base-type">The Registry Base Type</a></li>
<li><a href="#the-base-registered-class">The Base Registered Class</a></li>
<li><a href="#extending-the-base-registered-class">Extending the Base Registered Class</a></li>
<li><a href="#seeing-it-in-action">Seeing it in action</a></li>
</ul>
</li>
<li><a href="#examples">Examples</a><ul>
<li><a href="#example-search-engine">Example: Search Engine</a><ul>
<li><a href="#registry-subclasses">Registry Subclasses</a></li>
<li><a href="#doctype-registry-base-type">Doctype Registry Base Type</a></li>
<li><a href="#base-registered-doctype-class">Base Registered Doctype Class</a></li>
<li><a href="#derived-registered-doctype-class">Derived Registered Doctype Class</a></li>
<li><a href="#using-the-registry">Using the Registry</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#further-modifications">Further Modifications</a></li>
<li><a href="#summary">Summary</a></li>
</ul>
<h1>Overview</h1>
<p>This post is a summary of a useful Python programming pattern called the Registry pattern.</p>
<p>The Registry pattern is a way of keeping track of all subclasses of a given class.</p>
<p>More details about this pattern are available at <a href="https://github.com/faif/python-patterns">https://github.com/faif/python-patterns</a>.</p>
<h1>What is the Registry Pattern?</h1>
<p>Let's start with a common scenario: you have some kind of manager class that is
managing multiple related subclasses, and you are looking for a simpler way to
manage the subclasses.</p>
<p>The registry pattern creates a map of labels to class types, and allows you to
access a single registry common to all of those classes. The registry is updated
every time a new class is added.</p>
<p>This is useful for several situations, including these two examples:</p>
<ul>
<li>You want the manager class to iterate over every available subclass and call a
  particular method on each subclass</li>
<li>You want to streamline a factory class, which takes an input label (like the name
  of a class) and creates/returns an object of that type</li>
</ul>
<h2>The Registry Base Type</h2>
<p>We start by defining a registry base type (or class). This class defines one behavior,
which is adding itself to the class registry. It creates a shared instance variable called
<code>REGISTRY</code> which is shared amongst all of the classes, and is also accessible via a class
method.</p>
<p>This is the base class; any class we want registered should inherit from this class.
It should also extend the <code>type</code> class, since it is itself a class type:</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">RegistryBase</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>

    <span class="n">REGISTRY</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="n">new_cls</span> <span class="o">=</span> <span class="nb">type</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Here the name of the class is used as key but it could be any class</span>
<span class="sd">            parameter.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">REGISTRY</span><span class="p">[</span><span class="n">new_cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_cls</span>
        <span class="k">return</span> <span class="n">new_cls</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_registry</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">REGISTRY</span><span class="p">)</span>
</pre></div>


<p>Three things to note:</p>
<ul>
<li>
<p>The <code>REGISTRY</code> variable is defined outside the scope of any class methods, meaning it is a
  shared instance variable (a variable that is shared across all instances of <code>RegistryBase</code>);
  this is an example of the Borg pattern.</p>
</li>
<li>
<p>The <code>RegistryBase</code> class defines <code>__new__</code>, not <code>__init__</code>; the <code>__new__</code> method is run when
  the class is defined, while <code>__init__</code> is run when the classs is instantiated. This ensures
  that any subclasses that inherit from <code>RegistryBase</code> add themselves to the registry when they
  are defined, not when they are instantiated.</p>
</li>
<li>
<p>We define a <code>get_registry</code> method to return a copy of the registry; this must be decorated with
  a <code>@classmethod</code> decorator (not a <code>@staticmethod</code> decorator) so that it has access to the registry,
  which is a class instance variable.</p>
</li>
</ul>
<p><strong>BONUS NOTE:</strong> From prior experience, we have found it easiest to ignore the case of the
label (uppercase, lowercase, CamelCase, etc) and convert all class names to lowercase in the
registry:</p>
<div class="highlight"><pre><span></span>        <span class="bp">cls</span><span class="o">.</span><span class="n">REGISTRY</span><span class="p">[</span><span class="n">new_cls</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="n">new_cls</span>
</pre></div>


<h2>The Base Registered Class</h2>
<p>Now we can define a base class that will extend the <code>RegistryBase</code> class. However, because <code>RegistryBase</code>
is a <code>type</code> class, we shouldn't extend it directly - we should use it as a <em>metaclass</em>.</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">BaseRegisteredClass</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">RegistryBase</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>


<p>Any class that inherits from this <code>BaseRegisteredClass</code> will now be included in the registry when it is
defined.</p>
<h2>Extending the Base Registered Class</h2>
<p>The next step is to use the base registered class to start creating interesting classes:</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ExtendedRegisteredClass</span><span class="p">(</span><span class="n">BaseRegisteredClass</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">pass</span>
</pre></div>


<h2>Seeing it in action</h2>
<p>Now we can see the process of adding subclasses to the registry in action.</p>
<p>Start by checking the registry before we have created any subclasses:</p>
<div class="highlight"><pre><span></span>&gt;&gt;&gt; print(RegistryHolder.REGISTRY)
[&#39;BaseRegisteredClass&#39;]
</pre></div>


<p>Next, define the extended registered class:</p>
<div class="highlight"><pre><span></span>&gt;&gt;&gt; class ExtendedRegisteredClass(BaseRegisteredClass):
...     def __init__(self, *args, **kwargs):
...         pass
</pre></div>


<p>Remember, we add the new class to the registry in the <code>__new__</code> method, not the
<code>__init__</code> method, so we don't even need to instantiate an <code>ExtendedRegisteredClass</code>
object for it to be added to the registry. Check the registry again:</p>
<div class="highlight"><pre><span></span>&gt;&gt;&gt; print(RegistryHolder.REGISTRY)
[&#39;BaseRegisteredClass&#39;, &#39;ExtendedRegisteredClass&#39;]
</pre></div>


<h1>Examples</h1>
<p>Let's consider a specific example to help illustrate the usefulness of the Registry pattern:
adding the ability to index different kinds of documents to a search engine.</p>
<h2>Example: Search Engine</h2>
<p>Suppose we are writing a search engine, and we are working on the search engine
backend. Specifically, consider the backend portion that iterates over a group of
documents, checks if the document is already in the search index, and either adds
a new item to the search index, updates an existing item in the search index, or
deletes an item from the search index.</p>
<h3>Registry Subclasses</h3>
<p>A search engine may index multiple kinds of documents, each living in different locations.
For example, a search index may index .docx files in a Google Drive folder,
Github issues, and/or a local folder full of Markdown files. For each of these
document types, we must define:</p>
<ul>
<li>
<p>How to add or update all documents in the document storage system (Google Drive, Github
  API, local filesystem, etc.); this method should be able to get a list of documents of this
  document type that are already in the search index, either by running a query itself, or by
  accepting a list of documents already in the index as an input argument</p>
</li>
<li>
<p>What schema to use (mapping various field names to data types) for documents of this type</p>
</li>
<li>
<p>How to display search results when they are documents of this type (i.e., how to display
  what fields when showing the user search results)</p>
</li>
</ul>
<p>This can be done by defining classes corresponding to different document types, where
each class defines how to do the above actions, and wraps them in high-level API methods
that the manager classes can call.</p>
<p>The manager classes want a way to get a list of available document types, and to call
each document type's high-level API methods. This can be done with the registry.</p>
<h3>Doctype Registry Base Type</h3>
<p>Start by defining a base type that will register new subclasses in a doctype registry. Note that
as per the <a href="https://docs.python.org/3/reference/datamodel.html#object.__new__"><code>__new__</code> documentation</a>,
the <code>__new__</code> method takes the class (in our case, a class of type <code>type</code>) as the first argument <code>cls</code>,
and it should return a new object instance (which, again, is an instance of type <code>type</code>).</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">DoctypeRegistryBase</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>

    <span class="n">DOCTYPE_REGISTRY</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="n">new_cls</span> <span class="o">=</span> <span class="nb">type</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">DOCTYPE_REGISTRY</span><span class="p">[</span><span class="n">new_cls</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="n">new_cls</span>
        <span class="k">return</span> <span class="n">new_cls</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_doctype_registry</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">DOCTYPE_REGISTRY</span><span class="p">)</span>
</pre></div>


<h3>Base Registered Doctype Class</h3>
<p>Next, we define a base class for any document type that we want registered in the doctype
registry, using <code>DoctypeRegistryBase</code> as our metaclass (because it is a class of type <code>type</code>,
as opposed to a normal class).  All document types are required to define three bits of behavior
(interacting with the document storage system to iterate over all documents; extracting information
from individual documents; and displaying a given document type when it is a search result. We
define these virtual methods on the base registered doctype class.</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">BaseRegisteredDoctypeClass</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">DoctypeRegistryBase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">add_update_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Iterate over all documents in the document storage system</span>
<span class="sd">        and add/update/delete documents as needed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assemble and return the schema (map of field names to data types)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">render_search_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Use a Jinja template to render a single search result of type doctype</span>
<span class="sd">        to display to the user via the web interface</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</pre></div>


<h3>Derived Registered Doctype Class</h3>
<p>Now that we have a base class, we can define child classes that have the specific
API functionality needed.</p>
<p>Here is a high-level sketch of what the Github issue document type class might look like,
starting with the add/update/delete method, which boils down to some set operations to determine
what documents to add, update, or delete from the search index.</p>
<p>(Also note, these methods are defined as static methods because they are called once for each
doctype class, but this does not necessarily need to be the case.)</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">GithubIssueDoctype</span><span class="p">(</span><span class="n">BaseRegisteredDoctypeClass</span><span class="p">):</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">add_update_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Get set of indexed document IDs</span>
        <span class="n">indexed_docs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">run_search_index_query</span><span class="p">(</span><span class="n">doctype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">indexed_docs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="c1"># Get set of remote document IDs</span>
        <span class="n">remote_docs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">org_name</span> <span class="ow">in</span> <span class="n">get_org_names</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">repo_name</span> <span class="ow">in</span> <span class="n">get_repo_names</span><span class="p">(</span><span class="n">org_name</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">get_repo_files</span><span class="p">(</span><span class="n">repo_name</span><span class="p">,</span> <span class="n">org_name</span><span class="p">):</span>
                    <span class="n">remote_docs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="c1"># Do some set math to figure out what to add/update/delete</span>
        <span class="n">add_ids</span> <span class="o">=</span> <span class="n">remote_docs</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">indexed_docs</span><span class="p">)</span>
        <span class="n">update_ids</span> <span class="o">=</span> <span class="n">indexed_docs</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">remote_docs</span><span class="p">)</span>
        <span class="n">delete_ids</span> <span class="o">=</span> <span class="n">indexed_docs</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">remote_docs</span><span class="p">)</span>

        <span class="c1"># Do the operations</span>
        <span class="k">for</span> <span class="n">add_id</span> <span class="ow">in</span> <span class="n">add_ids</span><span class="p">:</span>
            <span class="n">add_document_to_index</span><span class="p">(</span><span class="n">add_id</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">update_id</span> <span class="ow">in</span> <span class="n">update_ids</span><span class="p">:</span>
            <span class="n">update_document_in_index</span><span class="p">(</span><span class="n">update_id</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">delete_id</span> <span class="ow">in</span> <span class="n">delete_ids</span><span class="p">:</span>
            <span class="n">delete_document_in_index</span><span class="p">(</span><span class="n">delete_id</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="o">...</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">render_search_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="o">...</span>
</pre></div>


<p>Now we do the same for documents on Google Drive, defining a different <code>add_update_delete()</code> method
specific to Google Drive documents (note that while the sketch of this method looks similar to the
Github doctype above, the implementation will look more and more different as we include more and more
detail in our method and API calls).</p>
<p>As before, we make these methods static.</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">GoogleDocsDoctype</span><span class="p">(</span><span class="n">BaseRegisteredDoctypeClass</span><span class="p">):</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">add_update_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Get set of indexed document IDs</span>
        <span class="n">indexed_dcos</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">run_search_index_query</span><span class="p">(</span><span class="n">doctype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">indexed_docs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="c1"># Get set of remote document IDs</span>
        <span class="n">remote_docs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">get_gdrive_file_list</span><span class="p">():</span>
            <span class="n">remote_docs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="c1"># Do some math to figure out what to add/update/delete</span>
        <span class="n">add_ids</span> <span class="o">=</span> <span class="n">remote_docs</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">indexed_docs</span><span class="p">)</span>
        <span class="n">update_ids</span> <span class="o">=</span> <span class="n">indexed_docs</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">remote_docs</span><span class="p">)</span>
        <span class="n">delete_ids</span> <span class="o">=</span> <span class="n">indexed_docs</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">remote_docs</span><span class="p">)</span>

        <span class="c1"># Do the operations</span>
        <span class="k">for</span> <span class="n">add_id</span> <span class="ow">in</span> <span class="n">add_ids</span><span class="p">:</span>
            <span class="n">add_document_to_index</span><span class="p">(</span><span class="n">add_id</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">update_id</span> <span class="ow">in</span> <span class="n">update_ids</span><span class="p">:</span>
            <span class="n">update_document_in_index</span><span class="p">(</span><span class="n">update_id</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">delete_id</span> <span class="ow">in</span> <span class="n">delete_ids</span><span class="p">:</span>
            <span class="n">delete_document_in_index</span><span class="p">(</span><span class="n">delete_id</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="o">...</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">render_search_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="o">...</span>
</pre></div>


<h3>Using the Registry</h3>
<p>The last step is to actually use the registry from the class that manages all of our subclasses.
In this case, we have a <code>Search</code> class that defines high-level operations (such as, "add/update/delete
all documents indexed by this search engine") and in turn calls the corresponding method for each doctype
that has been registered.</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Search</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">add_update_delete_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="c1"># Iterate over every doc type</span>
        <span class="k">for</span> <span class="n">doctype_name</span> <span class="ow">in</span> <span class="n">DoctypeRegistryBase</span><span class="o">.</span><span class="n">DOCTYPE_REGISTRY</span><span class="p">:</span>

            <span class="c1"># Get a handle to the doctype class</span>
            <span class="n">doctype_class</span> <span class="o">=</span> <span class="n">DoctypeRegistryBase</span><span class="o">.</span><span class="n">DOCTYPE_REGISTRY</span><span class="p">[</span><span class="n">doctype_name</span><span class="p">]</span>

            <span class="c1"># Call the static method add_update_delete on the doctype class</span>
            <span class="n">doctype_class</span><span class="o">.</span><span class="n">add_update_delete</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="c1"># Note: if these methods were not static, we would need to create an instance first</span>
            <span class="c1"># doctype_instance = doctype_class()</span>
            <span class="c1"># doctype_instance.add_update_delete(*args, **kwargs)</span>
</pre></div>


<h1>Further Modifications</h1>
<p>In the example above, we don't have any need to create specific instances of the document type classes,
since they do not need to preserve their state between calls, and we only need one instance of the doctype
class per search engine.</p>
<p>We could re-implement this pattern, modifying the search engine doctype classes to be normal, non-static
classes. This would allow us to have, say, two instances of the Github issues doctype class (corresponding
to two different sets of Github API credentials, or two different Github accounts), or two instances of the
Google Drive doctype class (corresponding to two different Google Drive folders). In this case, we would
want to restructure the Search class to instantiate and save doctype class instances in the constructor,
and use them later.</p>
<p>Here's an example <code>Search</code> class that would instantiate one of each subclass in the constructor, to be used
in later methods:</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Search</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="c1"># Store instances of each doctype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_doctypes</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Iterate over every doc type</span>
        <span class="k">for</span> <span class="n">doctype_name</span> <span class="ow">in</span> <span class="n">DoctypeRegistryBase</span><span class="o">.</span><span class="n">DOCTYPE_REGISTRY</span><span class="p">:</span>

        <span class="c1"># Get a handle to the doctype class</span>
        <span class="n">doctype_class</span> <span class="o">=</span> <span class="n">DoctypeRegistryBase</span><span class="o">.</span><span class="n">DOCTYPE_REGISTRY</span><span class="p">[</span><span class="n">doctype_name</span><span class="p">]</span>

        <span class="c1"># Create an instance of type doctype_class</span>
        <span class="n">doctype_instance</span> <span class="o">=</span> <span class="n">doctype_class</span><span class="p">()</span>

        <span class="c1"># Save for later</span>
        <span class="n">all_doctypes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">doctype_instance</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_update_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="c1"># Call the add_update_delete method on each doctype instance</span>
        <span class="k">for</span> <span class="n">doctype_name</span><span class="p">,</span> <span class="n">doctype_instance</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_doctypes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">doctype_instance</span><span class="o">.</span><span class="n">add_update_delete</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>


<p>(Note that this would work best if we removed the <code>@staticmethod</code> decorators from the doctype classes
defined above.)</p>
<h1>Summary</h1>
<p>In this post, we covered a useful programming pattern, the Registry, and showed it in action for one
example - allowing a search engine index to register various document type subclasses, then use those
registered subclasses to propagate calls to all document types later.</p></div>

    </div>
</div>

<div class="v20"></div>

<div class="row">
    <div class="col-md-12" style="text-align: left;">

        <div class="tags">
            <p>Tags:&nbsp;&nbsp;&nbsp;
                    <a href="https://charlesreid1.github.io/tag/python.html">python</a>
                    &nbsp;&nbsp;
                    <a href="https://charlesreid1.github.io/tag/programming.html">programming</a>
                    &nbsp;&nbsp;
                    <a href="https://charlesreid1.github.io/tag/patterns.html">patterns</a>
                    &nbsp;&nbsp;
                    <a href="https://charlesreid1.github.io/tag/design-patterns.html">design patterns</a>
                    &nbsp;&nbsp;
                    <a href="https://charlesreid1.github.io/tag/registry.html">registry</a>
                    &nbsp;&nbsp;
                    <a href="https://charlesreid1.github.io/tag/computer-science.html">computer science</a>
                    &nbsp;&nbsp;
        </div>

    </div>
</div>


<div class="v200"></div>
  	            	</article>
  	            	<article>
<header>
<div class="row">


    <div class="col-md-12">
        <div class="headtext" style="text-align: center;">
            <h1><b>
                Incorporating Terraform Commands into Makefiles
            </b></h1>
        
            <p class="lead">
                Posted 
                <time datetime="2020-02-15T12:00:00-08:00" pubdate>Saturday 02/15/2020</time>
                in 
                <a href="https://charlesreid1.github.io/category/terraform.html">Terraform</a>
                </p>
            <p>
            <span style="font-size: 14px">
                <a href="https://charlesreid1.github.io/incorporating-terraform-commands-into-makefiles.html">permalink</a>
            </span>
            </p>
        </div>

    </div>

</div>
</header>


<div class="v50"></div>


<div class="row">
    <div class="col-md-12" style="text-align: left;">

        <div class="entry-content"><h1>Table of Contents</h1>
<ul>
<li><a href="#summary">Summary</a></li>
<li><a href="#step-0-directory-and-file-layout">Step 0: Directory and File Layout</a><ul>
<li><a href="#environment-variables">Environment Variables</a></li>
</ul>
</li>
<li><a href="#step-1-top-level-makefile">Step 1: Top Level Makefile</a></li>
<li><a href="#step-2-infra-level-makefile">Step 2: Infra Level Makefile</a><ul>
<li><a href="#fake-targets">Fake Targets</a></li>
<li><a href="#commands-for-single-components">Commands for Single Components</a></li>
<li><a href="#commands-for-all-components">Commands for All Components</a></li>
<li><a href="#variables">Variables</a></li>
<li><a href="#final-makefile">Final Makefile</a></li>
</ul>
</li>
<li><a href="#step-3-writing-terraform-components">Step 3: Writing Terraform Components</a></li>
<li><a href="#step-4-initializing-terraform-components">Step 4: Initializing Terraform Components</a></li>
<li><a href="#workflow">Workflow</a><ul>
<li><a href="#plan">Plan</a></li>
<li><a href="#deploy">Deploy</a></li>
<li><a href="#update">Update</a></li>
<li><a href="#destroy">Destroy</a></li>
</ul>
</li>
</ul>
<h1>Summary</h1>
<p>This blog post covers a useful pattern for incorporating terraform commands
into a Makefile.</p>
<p>This is useful for cases where terraform is being used to manage infrastructure.
In the end you will be able to run a command like</p>
<div class="highlight"><pre><span></span>make plan-infra
make deploy-infra
</pre></div>


<p>and and have this call the corresponding terraform commands to plan and deploy your
terraformed cloud infrastructure.</p>
<p>The post is divided into a few steps:</p>
<ul>
<li>Directory and file layout - how we lay out the files for this tutorial</li>
<li>Top level Makefile - make commands to add to the top level Makefile</li>
<li>Infra level Makefile - make commands to add to the infra level Makefile</li>
<li>Writing Terraform component - how to write a configurable component that is ready to terraform</li>
<li>Initializing Terraform component - script to initialize terraform components</li>
<li>Workflow - plan, deploy, update, destroy</li>
</ul>
<h1>Step 0: Directory and File Layout</h1>
<p>This tutorial presumes you have a top level directory corresponding to a git repository.
We will use the following directory structure for this example:</p>
<div class="highlight"><pre><span></span>my-project/
    Readme.md
    environment
    Makefile
    infra/
        Makefile
        component-1/
            variables.tf
            main.tf
</pre></div>


<h2>Environment Variables</h2>
<p>In order to keep track of environment variables used in the terraform
process, we use the file <code>envronment</code> in the top level project directory
to keep all environment variable values under version control.</p>
<div class="highlight"><pre><span></span><span class="nv">SOURCE</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">BASH_SOURCE</span><span class="p">[0]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="k">while</span> <span class="o">[</span> -h <span class="s2">&quot;</span><span class="nv">$SOURCE</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">do</span> <span class="nv">SOURCE</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>readlink <span class="s2">&quot;</span><span class="nv">$SOURCE</span><span class="s2">&quot;</span><span class="k">)</span><span class="s2">&quot;</span><span class="p">;</span> <span class="k">done</span>
<span class="nb">export</span> <span class="nv">PROJECT_HOME</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span><span class="nb">cd</span> -P <span class="s2">&quot;</span><span class="k">$(</span>dirname <span class="s2">&quot;</span><span class="nv">$SOURCE</span><span class="s2">&quot;</span><span class="k">)</span><span class="s2">&quot;</span> <span class="o">&amp;&amp;</span> <span class="nb">pwd</span><span class="k">)</span><span class="s2">&quot;</span>

<span class="nb">set</span> -a
<span class="nv">PROJECT_DEPLOYMENT_STAGE</span><span class="o">=</span>dev
<span class="nv">AWS_DEFAULT_OUTPUT</span><span class="o">=</span>json
<span class="nv">AWS_DEFAULT_REGION</span><span class="o">=</span>us-east-1
<span class="nb">set</span> +a
</pre></div>


<p>Optionally, a local environment file can contain environment variable values
that are sensitive or should not be kept under version control, so add this
to the bottom of the <code>environment</code> file too:</p>
<div class="highlight"><pre><span></span><span class="k">if</span> <span class="o">[[</span> -f <span class="s2">&quot;</span><span class="si">${</span><span class="nv">PROJECT_HOME</span><span class="si">}</span><span class="s2">/environment.local&quot;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">source</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">PROJECT_HOME</span><span class="si">}</span><span class="s2">/environment.local&quot;</span>
<span class="k">fi</span>
</pre></div>


<h1>Step 1: Top Level Makefile</h1>
<p>Start by creating the <code>plan-infra</code> and <code>deploy-infra</code> commands in your top-level
Makefile. These commands will, in turn, call make commands defined in <code>infra/Makefile</code>:</p>
<div class="highlight"><pre><span></span><span class="nf">plan-infra</span><span class="o">:</span>
    <span class="k">$(</span>MAKE<span class="k">)</span> -C infra plan-all

<span class="nf">deploy-infra</span><span class="o">:</span>
    <span class="k">$(</span>MAKE<span class="k">)</span> -C infra apply-all
</pre></div>


<p>The <code>-C infra</code> flag indicates make should use a Makefile in a subdirectory.</p>
<h1>Step 2: Infra Level Makefile</h1>
<p>Next we define <code>infra/Makefile</code>. This Makefile will have two parts:</p>
<ul>
<li>terraform commands for a single component (example: init, plan, apply, destroy)</li>
<li>wrapper commands to run the above commands for every component (example: for each component,
  run the plan terraform command)</li>
</ul>
<p>We cover the Makefile from the bottom up.</p>
<h2>Fake Targets</h2>
<p>Start by defining "fake" targets or rules, that is, make rules whose names are not file names:</p>
<div class="highlight"><pre><span></span><span class="nf">.PHONY</span><span class="o">:</span> <span class="n">init</span>-<span class="n">all</span> <span class="n">plan</span>-<span class="n">all</span> <span class="n">apply</span>-<span class="n">all</span> <span class="n">clean</span>-<span class="n">all</span> <span class="n">plan</span> <span class="n">apply</span> <span class="n">destroy</span> <span class="n">init</span> <span class="n">clean</span>
</pre></div>


<h2>Commands for Single Components</h2>
<p>Next, above that, we define terraform commands for a single component:</p>
<div class="highlight"><pre><span></span><span class="nf">init</span><span class="o">:</span>
    rm -rf <span class="k">$(</span>COMPONENT<span class="k">)</span>/.terraform/*.tfstate
    ./build_deploy_config.py <span class="k">$(</span>COMPONENT<span class="k">)</span>
    <span class="nb">cd</span> <span class="k">$(</span>COMPONENT<span class="k">)</span><span class="p">;</span> terraform init<span class="p">;</span>

<span class="nf">plan</span><span class="o">:</span> <span class="n">init</span>
    <span class="nb">cd</span> <span class="k">$(</span>COMPONENT<span class="k">)</span><span class="p">;</span> terraform plan -detailed-exitcode

<span class="nf">apply</span><span class="o">:</span> <span class="n">init</span>
    <span class="nb">cd</span> <span class="k">$(</span>COMPONENT<span class="k">)</span><span class="p">;</span> terraform apply

<span class="nf">destroy</span><span class="o">:</span> <span class="n">init</span>
    <span class="nb">cd</span> <span class="k">$(</span>COMPONENT<span class="k">)</span><span class="p">;</span> terraform destroy

<span class="nf">clean</span><span class="o">:</span>
    <span class="nb">cd</span> <span class="k">$(</span>COMPONENT<span class="k">)</span><span class="p">;</span> rm -rf .terraform
</pre></div>


<p>Note that the <code>init</code> command is running a <code>build_deploy_config.py</code> script,
which we will cover in a moment. This script creates the terraform variables
file <code>variables.tf</code> and populates the variable values using environment
variables.</p>
<h2>Commands for All Components</h2>
<p>Above that, we have commands to perform each action on all components:</p>
<div class="highlight"><pre><span></span><span class="nf">all</span><span class="o">:</span> <span class="n">init</span>-<span class="n">all</span>

<span class="nf">init-all</span><span class="o">:</span>
    @for c in <span class="k">$(</span>COMPONENTS<span class="k">)</span><span class="p">;</span> <span class="k">do</span> <span class="se">\</span>
        <span class="k">$(</span>MAKE<span class="k">)</span> init <span class="nv">COMPONENT</span><span class="o">=</span><span class="nv">$$</span>c <span class="o">||</span> <span class="nb">exit</span> <span class="m">1</span><span class="p">;</span> <span class="se">\</span>
    <span class="k">done</span>

<span class="nf">plan-all</span><span class="o">:</span>
    @for c in <span class="k">$(</span>COMPONENTS<span class="k">)</span><span class="p">;</span> <span class="k">do</span> <span class="se">\</span>
        <span class="k">$(</span>MAKE<span class="k">)</span> plan <span class="nv">COMPONENT</span><span class="o">=</span><span class="nv">$$</span>c <span class="o">||</span> <span class="nb">exit</span> <span class="m">1</span><span class="p">;</span> <span class="se">\</span>
    <span class="k">done</span>

<span class="nf">apply-all</span><span class="o">:</span>
    @for c in <span class="k">$(</span>COMPONENTS<span class="k">)</span><span class="p">;</span> <span class="k">do</span> <span class="se">\</span>
        <span class="k">$(</span>MAKE<span class="k">)</span> apply <span class="nv">COMPONENT</span><span class="o">=</span><span class="nv">$$</span>c <span class="o">||</span> <span class="nb">exit</span> <span class="m">1</span><span class="p">;</span> <span class="se">\</span>
    <span class="k">done</span>

<span class="nf">destroy-all</span><span class="o">:</span>
    @for c in <span class="k">$(</span>COMPONENTS<span class="k">)</span><span class="p">;</span> <span class="k">do</span> <span class="se">\</span>
        <span class="k">$(</span>MAKE<span class="k">)</span> destroy <span class="nv">COMPONENT</span><span class="o">=</span><span class="nv">$$</span>c <span class="o">||</span> <span class="nb">exit</span> <span class="m">1</span><span class="p">;</span> <span class="se">\</span>
    <span class="k">done</span>

<span class="nf">clean-all</span><span class="o">:</span>
    @for c in <span class="k">$(</span>COMPONENTS<span class="k">)</span><span class="p">;</span> <span class="k">do</span> <span class="se">\</span>
        <span class="k">$(</span>MAKE<span class="k">)</span> clean <span class="nv">COMPONENT</span><span class="o">=</span><span class="nv">$$</span>c <span class="o">||</span> <span class="nb">exit</span> <span class="m">1</span><span class="p">;</span> <span class="se">\</span>
    <span class="k">done</span>
</pre></div>


<h2>Variables</h2>
<p>Last but not least, we define a few variables at the top of the Makefile:
most importantly, the list of infrastructure components. This is created by
extracting the names of subdirectories in <code>infra/</code> containing <code>*.tf</code> files:</p>
<div class="highlight"><pre><span></span><span class="nv">DIRS</span><span class="o">=</span><span class="si">${</span><span class="nv">shell</span><span class="p"> find . -name </span><span class="s2">&quot;*.tf&quot;</span><span class="p"> -exec dirname {</span><span class="si">}</span> <span class="se">\;</span> <span class="p">|</span> sort --unique<span class="o">}</span>
<span class="nv">COMPONENTS</span><span class="o">=</span><span class="si">${</span><span class="nv">shell</span><span class="p"> for d in </span><span class="k">$(</span>DIRS<span class="k">)</span><span class="p">; do basename </span><span class="nv">$$d</span><span class="p">; done</span><span class="si">}</span>
</pre></div>


<h2>Final Makefile</h2>
<p>Here is the final <code>infra/Makefile</code>:</p>
<p><strong><code>infra/Makefile</code>:</strong></p>
<div class="highlight"><pre><span></span><span class="nv">DIRS</span><span class="o">=</span><span class="si">${</span><span class="nv">shell</span><span class="p"> find . -name </span><span class="s2">&quot;*.tf&quot;</span><span class="p"> -exec dirname {</span><span class="si">}</span> <span class="se">\;</span> <span class="p">|</span> sort --unique<span class="o">}</span>
<span class="nv">COMPONENTS</span><span class="o">=</span><span class="si">${</span><span class="nv">shell</span><span class="p"> for d in </span><span class="k">$(</span>DIRS<span class="k">)</span><span class="p">; do basename </span><span class="nv">$$d</span><span class="p">; done</span><span class="si">}</span>

<span class="nf">all</span><span class="o">:</span> <span class="n">init</span>-<span class="n">all</span>

<span class="nf">init-all</span><span class="o">:</span>
    @for c in <span class="k">$(</span>COMPONENTS<span class="k">)</span><span class="p">;</span> <span class="k">do</span> <span class="se">\</span>
        <span class="k">$(</span>MAKE<span class="k">)</span> init <span class="nv">COMPONENT</span><span class="o">=</span><span class="nv">$$</span>c <span class="o">||</span> <span class="nb">exit</span> <span class="m">1</span><span class="p">;</span> <span class="se">\</span>
    <span class="k">done</span>

<span class="nf">plan-all</span><span class="o">:</span>
    @for c in <span class="k">$(</span>COMPONENTS<span class="k">)</span><span class="p">;</span> <span class="k">do</span> <span class="se">\</span>
        <span class="k">$(</span>MAKE<span class="k">)</span> plan <span class="nv">COMPONENT</span><span class="o">=</span><span class="nv">$$</span>c <span class="o">||</span> <span class="nb">exit</span> <span class="m">1</span><span class="p">;</span> <span class="se">\</span>
    <span class="k">done</span>

<span class="nf">apply-all</span><span class="o">:</span>
    @for c in <span class="k">$(</span>COMPONENTS<span class="k">)</span><span class="p">;</span> <span class="k">do</span> <span class="se">\</span>
        <span class="k">$(</span>MAKE<span class="k">)</span> apply <span class="nv">COMPONENT</span><span class="o">=</span><span class="nv">$$</span>c <span class="o">||</span> <span class="nb">exit</span> <span class="m">1</span><span class="p">;</span> <span class="se">\</span>
    <span class="k">done</span>

<span class="nf">destroy-all</span><span class="o">:</span>
    @for c in <span class="k">$(</span>COMPONENTS<span class="k">)</span><span class="p">;</span> <span class="k">do</span> <span class="se">\</span>
        <span class="k">$(</span>MAKE<span class="k">)</span> destroy <span class="nv">COMPONENT</span><span class="o">=</span><span class="nv">$$</span>c <span class="o">||</span> <span class="nb">exit</span> <span class="m">1</span><span class="p">;</span> <span class="se">\</span>
    <span class="k">done</span>

<span class="nf">clean-all</span><span class="o">:</span>
    @for c in <span class="k">$(</span>COMPONENTS<span class="k">)</span><span class="p">;</span> <span class="k">do</span> <span class="se">\</span>
        <span class="k">$(</span>MAKE<span class="k">)</span> clean <span class="nv">COMPONENT</span><span class="o">=</span><span class="nv">$$</span>c <span class="o">||</span> <span class="nb">exit</span> <span class="m">1</span><span class="p">;</span> <span class="se">\</span>
    <span class="k">done</span>

<span class="nf">plan</span><span class="o">:</span> <span class="n">init</span>
    <span class="nb">cd</span> <span class="k">$(</span>COMPONENT<span class="k">)</span><span class="p">;</span> terraform plan -detailed-exitcode

<span class="nf">apply</span><span class="o">:</span> <span class="n">init</span>
    <span class="nb">cd</span> <span class="k">$(</span>COMPONENT<span class="k">)</span><span class="p">;</span> terraform apply

<span class="nf">destroy</span><span class="o">:</span> <span class="n">init</span>
    <span class="nb">cd</span> <span class="k">$(</span>COMPONENT<span class="k">)</span><span class="p">;</span> terraform destroy

<span class="nf">init</span><span class="o">:</span>
    rm -rf <span class="k">$(</span>COMPONENT<span class="k">)</span>/.terraform/*.tfstate
    ./build_deploy_config.py <span class="k">$(</span>COMPONENT<span class="k">)</span>
    <span class="nb">cd</span> <span class="k">$(</span>COMPONENT<span class="k">)</span><span class="p">;</span> terraform init<span class="p">;</span>

<span class="nf">clean</span><span class="o">:</span>
    <span class="nb">cd</span> <span class="k">$(</span>COMPONENT<span class="k">)</span><span class="p">;</span> rm -rf .terraform

<span class="nf">.PHONY</span><span class="o">:</span> <span class="n">init</span>-<span class="n">all</span> <span class="n">plan</span>-<span class="n">all</span> <span class="n">apply</span>-<span class="n">all</span> <span class="n">clean</span>-<span class="n">all</span> <span class="n">plan</span> <span class="n">apply</span> <span class="n">destroy</span> <span class="n">init</span> <span class="n">clean</span>
</pre></div>


<h1>Step 3: Writing Terraform Components</h1>
<p>As an example, we will consider an example of terraform-managed buckets.</p>
<p>Start by creating a directory called <code>infra/buckets/</code> to store terraform
files for creating and managing the buckets.</p>
<p>We can create one file per cloud provider. As an example, here is <code>s3.tf</code>:</p>
<p><strong><code>s3.tf</code></strong>:</p>
<div class="highlight"><pre><span></span>data &quot;aws_caller_identity&quot; &quot;current&quot; {}

locals {
  common_tags = &quot;${map(
    &quot;project&quot;   , &quot;${var.PROJECT_INFRA_TAG_PROJECT}&quot;,
    &quot;env&quot;       , &quot;${var.PROJECT_DEPLOYMENT_STAGE}&quot;,
    &quot;service&quot;   , &quot;${var.PROJECT_INFRA_TAG_SERVICE}&quot;
  )}&quot;
  aws_tags = &quot;${map(
  &quot;Name&quot;      , &quot;${var.PROJECT_INFRA_TAG_SERVICE}-s3-storage&quot;,
  &quot;owner&quot;     , &quot;${var.PROJECT_INFRA_TAG_OWNER}&quot;,
  &quot;managedBy&quot; , &quot;terraform&quot;
  )}&quot;
}

resource aws_s3_bucket dss_s3_bucket {
  count = length(var.PROJECT_S3_BUCKET) &gt; 0 ? 1 : 0
  bucket = var.PROJECT_S3_BUCKET
  server_side_encryption_configuration {
    rule {
      apply_server_side_encryption_by_default {
        sse_algorithm = &quot;AES256&quot;
      }
    }
  }
  tags = merge(local.common_tags, local.aws_tags)
}
</pre></div>


<p>Note that this requires several environment variables to be
defined in <code>environment</code> and requires the operator to run:</p>
<div class="highlight"><pre><span></span>source environment
</pre></div>


<h1>Step 4: Initializing Terraform Components</h1>
<p>The following script will automatically generate terraform files for
our component that are populated with the correct environment variable
values.</p>
<p>Start with a simple argument parser that just accepts a single argument,
the component to make terraform files for:</p>
<div class="highlight"><pre><span></span><span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="vm">__doc__</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;component&quot;</span><span class="p">)</span>
<span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
</pre></div>


<p>Next, we define several terraform file templates using Python's
bracket template syntax. Start with a template for defining a
terraform variable:</p>
<div class="highlight"><pre><span></span>terraform_variable_template = &quot;&quot;&quot;
variable &quot;{name}&quot; {{
  default = &quot;{val}&quot;
}}
&quot;&quot;&quot;
</pre></div>


<p>Next, define a template for the terraform backend buket:</p>
<div class="highlight"><pre><span></span>terraform_backend_template = &quot;&quot;&quot;# Auto-generated during infra build process.
# Please edit infra/build_deploy_config.py directly.
terraform {{
  backend &quot;s3&quot; {{
    bucket = &quot;{bucket}&quot;
    key = &quot;{comp}-{stage}.tfstate&quot;
    region = &quot;{region}&quot;
    {profile_setting}
  }}
}}
&quot;&quot;&quot;
</pre></div>


<p>Next define terraform cloud providers:</p>
<div class="highlight"><pre><span></span>terraform_providers_template = &quot;&quot;&quot;# Auto-generated during infra build process.
# Please edit infra/build_deploy_config.py directly.
provider aws {{
  region = &quot;{aws_region}&quot;
}}
&quot;&quot;&quot;
</pre></div>


<p>Provide a list of environment variables that should also be defined as
terraform variables:</p>
<div class="highlight"><pre><span></span><span class="nv">env_vars_to_infra</span> <span class="o">=</span> <span class="o">[</span>
    <span class="s2">&quot;ACM_CERTIFICATE_IDENTIFIER&quot;</span>,
    <span class="s2">&quot;API_DOMAIN_NAME&quot;</span>,
    <span class="s2">&quot;AWS_DEFAULT_REGION&quot;</span>,
    <span class="s2">&quot;DSS_BLOB_TTL_DAYS&quot;</span>,
    <span class="s2">&quot;DSS_CHECKOUT_BUCKET_OBJECT_VIEWERS&quot;</span>,
    <span class="s2">&quot;DSS_DEPLOYMENT_STAGE&quot;</span>,
    <span class="s2">&quot;DSS_ES_DOMAIN&quot;</span>,
    <span class="s2">&quot;DSS_ES_DOMAIN_INDEX_LOGS_ENABLED&quot;</span>,
    <span class="s2">&quot;DSS_ES_INSTANCE_COUNT&quot;</span>,
    <span class="s2">&quot;DSS_ES_INSTANCE_TYPE&quot;</span>,
    <span class="s2">&quot;DSS_ES_VOLUME_SIZE&quot;</span>,
    <span class="s2">&quot;DSS_GCP_SERVICE_ACCOUNT_NAME&quot;</span>,
    <span class="s2">&quot;DSS_GS_BUCKET&quot;</span>,
    <span class="s2">&quot;DSS_GS_BUCKET_TEST&quot;</span>,
    <span class="s2">&quot;DSS_GS_BUCKET_TEST_FIXTURES&quot;</span>,
    <span class="s2">&quot;DSS_GS_CHECKOUT_BUCKET&quot;</span>,
    <span class="s2">&quot;DSS_GS_CHECKOUT_BUCKET_TEST&quot;</span>,
    <span class="s2">&quot;DSS_GS_CHECKOUT_BUCKET_TEST_USER&quot;</span>,
    <span class="s2">&quot;DSS_INFRA_TAG_OWNER&quot;</span>,
    <span class="s2">&quot;DSS_INFRA_TAG_PROJECT&quot;</span>,
    <span class="s2">&quot;DSS_INFRA_TAG_SERVICE&quot;</span>,
    <span class="s2">&quot;DSS_S3_BUCKET&quot;</span>,
    <span class="s2">&quot;DSS_S3_BUCKET_TEST&quot;</span>,
    <span class="s2">&quot;DSS_S3_BUCKET_TEST_FIXTURES&quot;</span>,
    <span class="s2">&quot;DSS_S3_CHECKOUT_BUCKET&quot;</span>,
    <span class="s2">&quot;DSS_S3_CHECKOUT_BUCKET_TEST&quot;</span>,
    <span class="s2">&quot;DSS_S3_CHECKOUT_BUCKET_TEST_USER&quot;</span>,
    <span class="s2">&quot;DSS_S3_CHECKOUT_BUCKET_UNWRITABLE&quot;</span>,
    <span class="s2">&quot;DSS_FLASHFLOOD_BUCKET&quot;</span>,
    <span class="s2">&quot;DSS_FLASHFLOOD_BUCKET_INTEGRATION&quot;</span>,
    <span class="s2">&quot;DSS_FLASHFLOOD_BUCKET_PROD&quot;</span>,
    <span class="s2">&quot;DSS_FLASHFLOOD_BUCKET_STAGING&quot;</span>,
    <span class="s2">&quot;DSS_SECRETS_STORE&quot;</span>,
    <span class="s2">&quot;DSS_ZONE_NAME&quot;</span>,
    <span class="s2">&quot;ES_ALLOWED_SOURCE_IP_SECRETS_NAME&quot;</span>,
    <span class="s2">&quot;GCP_DEFAULT_REGION&quot;</span>,
<span class="o">]</span>
</pre></div>


<p>Finally, substitute environment variable values into the templates, and write
the templated content to the appropriate <code>*.tf</code> file. First, the backend:</p>
<div class="highlight"><pre><span></span><span class="c1"># Write backend.tf</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">infra_root</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">component</span><span class="p">,</span> <span class="s2">&quot;backend.tf&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
    <span class="n">caller_info</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;sts&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get_caller_identity</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;AWS_PROFILE&#39;</span><span class="p">):</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;AWS_PROFILE&#39;</span><span class="p">]</span>
        <span class="n">profile_setting</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;profile = &quot;</span><span class="si">{profile}</span><span class="s1">&quot;&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">profile_setting</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">terraform_backend_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">bucket</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;DSS_TERRAFORM_BACKEND_BUCKET_TEMPLATE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">account_id</span><span class="o">=</span><span class="n">caller_info</span><span class="p">[</span><span class="s1">&#39;Account&#39;</span><span class="p">]),</span>
        <span class="n">comp</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">component</span><span class="p">,</span>
        <span class="n">stage</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;DSS_DEPLOYMENT_STAGE&#39;</span><span class="p">],</span>
        <span class="n">region</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;AWS_DEFAULT_REGION&#39;</span><span class="p">],</span>
        <span class="n">profile_setting</span><span class="o">=</span><span class="n">profile_setting</span><span class="p">,</span>
    <span class="p">))</span>
</pre></div>


<p>Next, the <code>variables.tf</code> for the component:</p>
<div class="highlight"><pre><span></span><span class="c1"># Write variables.tf</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">infra_root</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">component</span><span class="p">,</span> <span class="s2">&quot;variables.tf&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
    <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# Auto-generated during infra build process.&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="p">)</span>
    <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# Please edit infra/build_deploy_config.py directly.&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">env_vars_to_infra</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">terraform_variable_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">val</span><span class="p">))</span>
</pre></div>


<p>Finally, the cloud providers file <code>providers.tf</code>:</p>
<div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">infra_root</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">component</span><span class="p">,</span> <span class="s2">&quot;providers.tf&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
    <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">terraform_providers_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">aws_region</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;AWS_DEFAULT_REGION&#39;</span><span class="p">],</span>
        <span class="n">gcp_project_id</span><span class="o">=</span><span class="n">GCP_PROJECT_ID</span><span class="p">,</span>
    <span class="p">))</span>
</pre></div>


<h1>Workflow</h1>
<h2>Plan</h2>
<h2>Deploy</h2>
<h2>Update</h2>
<h2>Destroy</h2></div>

    </div>
</div>

<div class="v20"></div>

<div class="row">
    <div class="col-md-12" style="text-align: left;">

        <div class="tags">
            <p>Tags:&nbsp;&nbsp;&nbsp;
                    <a href="https://charlesreid1.github.io/tag/terraform.html">terraform</a>
                    &nbsp;&nbsp;
                    <a href="https://charlesreid1.github.io/tag/makefile.html">makefile</a>
                    &nbsp;&nbsp;
                    <a href="https://charlesreid1.github.io/tag/make.html">make</a>
                    &nbsp;&nbsp;
                    <a href="https://charlesreid1.github.io/tag/python.html">python</a>
                    &nbsp;&nbsp;
        </div>

    </div>
</div>


<div class="v200"></div>
  	            	</article>
  	            	<article>
<header>
<div class="row">


    <div class="col-md-12">
        <div class="headtext" style="text-align: center;">
            <h1><b>
                Automatically Generating Up-To-Date requirements.txt for Python Projects
            </b></h1>
        
            <p class="lead">
                Posted 
                <time datetime="2019-12-12T12:12:00-08:00" pubdate>Thursday 12/12/2019</time>
                in 
                <a href="https://charlesreid1.github.io/category/python.html">Python</a>
                </p>
            <p>
            <span style="font-size: 14px">
                <a href="https://charlesreid1.github.io/automatically-generating-up-to-date-requirementstxt-for-python-projects.html">permalink</a>
            </span>
            </p>
        </div>

    </div>

</div>
</header>


<div class="v50"></div>


<div class="row">
    <div class="col-md-12" style="text-align: left;">

        <div class="entry-content"><h2>Table of Contents</h2>
<ul>
<li><a href="#summary">Summary</a></li>
<li><a href="#what-is-requirementstxt">What is requirements.txt?</a></li>
<li><a href="#converting-requirementstxtin-to-requirementstxt">Converting requirements.txt.in to requirements.txt</a></li>
<li><a href="#automating-the-step-with-a-make-rule">Automating the step with a make rule</a></li>
<li><a href="#refreshing-requirements">Refreshing requirements</a></li>
</ul>
<p><br />
<br /></p>
<h2>Summary</h2>
<p>In this post, we cover a pattern for automatically generating a <code>requirements.txt</code> file that has the latest
compatible versions of required software, and that specifies the full and exact version of each package to
make the Python environment reproducible.</p>
<p>This will turn a requirements input file (called <code>requirements.txt.in</code> for example) that looks like</p>
<div class="highlight"><pre><span></span>numpy
</pre></div>


<p>into a requirements file that specifies the exact version of <code>numpy</code> and all dependencies, like</p>
<div class="highlight"><pre><span></span>numpy==1.18.1
</pre></div>


<p>By the end of this post, you'll be able to do this to refresh and update the versions of all the software your
project depends on:</p>
<div class="highlight"><pre><span></span>make requirements.txt
</pre></div>


<p><strong>All of this code comes from the Human Cell Atlas <a href="https://github.com/HumanCellAtlas/data-store">data-store</a>
project!</strong></p>
<h2>What is requirements.txt?</h2>
<p>When developing a Python project, the <code>requirements.txt</code> file is a plain text file that contains a list of
Python software packages that need to be installed for the current Python software package to work. The software
can be installed using the command</p>
<div class="highlight"><pre><span></span>pip install -r requirements.txt
</pre></div>


<p>For example, if a package <code>foobar</code> has <code>import numpy</code> at the top of a Python file in the project, the <code>numpy</code> package
must be installed before importing <code>foobar</code>. In this case, the <code>requirements.txt</code> could just contain</p>
<div class="highlight"><pre><span></span>numpy
</pre></div>


<p>or it could specify a particular version of numpy, or a minimum version of numpy:</p>
<div class="highlight"><pre><span></span>numpy &gt;= 1.10
</pre></div>


<p>Start by creating a <code>requirements.txt.in</code>, which should look like a normal <code>requirements.txt</code> file,
listing software packages for pip to install (and optionally version information - but version information
does not <em>need</em> to be specified).</p>
<p>This file is a looser set of specifications of software versions.</p>
<p>Example <code>requirements.txt.in</code>:</p>
<div class="highlight"><pre><span></span>numpy
pandas &gt; 0.22
sphinx
</pre></div>


<h2>Converting requirements.txt.in to requirements.txt</h2>
<p>Next, we use the <code>requirements.txt.in</code> file to install the latest versions of each software package (and all
dependent software packages) into a virtual environment.</p>
<p>From that virtual environment, we can use <code>pip freeze</code> to output the names of each software package installed in
the virtual environment, along with its exact version. This can be used to make a <code>requirements.txt</code> file.</p>
<p>The manual steps are</p>
<div class="highlight"><pre><span></span>virtualenv -p $(which python3) venv
venv/bin/pip install -r requirements.txt
venv/bin/pip install -r requirements.txt.in
venv/bin/pip freeze &gt;&gt; requirements.txt
rm -fr venv
</pre></div>


<p>Using pip freeze means the resulting <code>results.txt</code> contains detailed version numbers:</p>
<div class="highlight"><pre><span></span>alabaster==0.7.12
Babel==2.7.0
certifi==2019.11.28
chardet==3.0.4
docutils==0.15.2
idna==2.8
imagesize==1.1.0
Jinja2==2.10.3
MarkupSafe==1.1.1
numpy==1.17.4
packaging==19.2
pandas==0.25.3
Pygments==2.5.2
pyparsing==2.4.5
python-dateutil==2.8.1
pytz==2019.3
requests==2.22.0
six==1.13.0
snowballstemmer==2.0.0
Sphinx==2.2.2
sphinxcontrib-applehelp==1.0.1
sphinxcontrib-devhelp==1.0.1
sphinxcontrib-htmlhelp==1.0.2
sphinxcontrib-jsmath==1.0.1
sphinxcontrib-qthelp==1.0.2
sphinxcontrib-serializinghtml==1.1.3
urllib3==1.25.7
</pre></div>


<p>This is automated with a make rule next.</p>
<h2>Automating the step with a make rule</h2>
<p>We have a nice Makefile rule that can be dropped into
any Makefile that allows users to run</p>
<div class="highlight"><pre><span></span>make requirements.txt
</pre></div>


<p>and it will use <code>requirements.txt.in</code>, perform the above steps, and output an updated <code>requirements.txt</code> with the
latest compatible versions of software.</p>
<p>Here is the Makefile rule:</p>
<div class="highlight"><pre><span></span><span class="nf">requirements.txt</span><span class="o">:</span> %.<span class="n">txt</span> : %.<span class="n">txt</span>.<span class="n">in</span>
    <span class="o">[</span> ! -e .requirements-env <span class="o">]</span> <span class="o">||</span> <span class="nb">exit</span> <span class="m">1</span>
    virtualenv -p <span class="k">$(</span>shell which python3<span class="k">)</span> .$&lt;-env
    .$&lt;-env/bin/pip install -r <span class="nv">$@</span>
    .$&lt;-env/bin/pip install -r $&lt;
    <span class="nb">echo</span> <span class="s2">&quot;# You should not edit this file directly.  Instead, you should edit </span>$<span class="s2">&lt;.&quot;</span> &gt;<span class="p">|</span> <span class="nv">$@</span>
    .$&lt;-env/bin/pip freeze &gt;&gt; <span class="nv">$@</span>
    rm -rf .$&lt;-env
</pre></div>


<p>Summary of the make rule:</p>
<ul>
<li>
<p>The first two lines create a virtual environment at <code>.requirements-env/</code></p>
</li>
<li>
<p>The next two lines run <code>pip install</code>, first on <code>requirements.txt</code> (the existing version), then
  <code>requirements.txt.in</code> (which installs/updates any software packages in <code>requirements.txt.in</code>)</p>
</li>
<li>
<p>A comment is added to the top of the <code>requirements.txt</code> file to help give users a hint about
  where to update software requirements.</p>
</li>
<li>
<p>The <code>pip freeze</code> command is used to create a <code>requirements.txt</code> file from the current virtual
  environment</p>
</li>
</ul>
<h2>Refreshing requirements</h2>
<p>To update the requirements, update the <code>requirements.txt</code> with these manual steps:</p>
<div class="highlight"><pre><span></span><span class="nf">refresh_all_requirements</span><span class="o">:</span>
    @cat /dev/null &gt; requirements.txt
    @if <span class="o">[</span> <span class="nv">$$</span><span class="o">(</span>uname -s<span class="o">)</span> <span class="o">==</span> <span class="s2">&quot;Darwin&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span> sleep <span class="m">1</span><span class="p">;</span> <span class="k">fi</span>  <span class="c1"># this is require because Darwin HFS+ only has second-resolution for timestamps.</span>
    @touch requirements.txt.in
    @<span class="k">$(</span>MAKE<span class="k">)</span> requirements.txt
</pre></div>


<p>Now <code>requirements.txt</code> can be updated with</p>
<div class="highlight"><pre><span></span>make refresh_all_requirements
</pre></div>


<p>This can be done periodically, and the new <code>requirements.txt</code> updated in the version control system.</p></div>

    </div>
</div>

<div class="v20"></div>

<div class="row">
    <div class="col-md-12" style="text-align: left;">

        <div class="tags">
            <p>Tags:&nbsp;&nbsp;&nbsp;
                    <a href="https://charlesreid1.github.io/tag/python.html">python</a>
                    &nbsp;&nbsp;
                    <a href="https://charlesreid1.github.io/tag/pip.html">pip</a>
                    &nbsp;&nbsp;
                    <a href="https://charlesreid1.github.io/tag/version-control.html">version control</a>
                    &nbsp;&nbsp;
                    <a href="https://charlesreid1.github.io/tag/make.html">make</a>
                    &nbsp;&nbsp;
                    <a href="https://charlesreid1.github.io/tag/makefile.html">makefile</a>
                    &nbsp;&nbsp;
        </div>

    </div>
</div>


<div class="v200"></div>
  	            	</article>

<div class="row">
    <div class="col-md-4 col-centered" style="text-align: center;">

        <div class="pagination">



            <a class="prev" href="https://charlesreid1.github.io/index2.html">Older &rarr;</a>
        
          <br />
        </div>

    </div>
</div>

<div class="v50"></div>


        </div>

        <div class="col-md-4" style="text-align: center;">
<a name="a_archive"></a>


        <div class="well">

            <h2>February 2020</h2>

            <p class="archive">
            <a href="https://charlesreid1.github.io/python-patterns-the-registry.html">Python Patterns: The Registry</a>
            </p>
            <p class="archive">
            <a href="https://charlesreid1.github.io/incorporating-terraform-commands-into-makefiles.html">Incorporating Terraform Commands into Makefiles</a>
            </p>

        </div>

        <div class="v20"></div>


        <div class="well">

            <h2>December 2019</h2>

            <p class="archive">
            <a href="https://charlesreid1.github.io/automatically-generating-up-to-date-requirementstxt-for-python-projects.html">Automatically Generating Up-To-Date requirements.txt for Python Projects</a>
            </p>
            <p class="archive">
            <a href="https://charlesreid1.github.io/git-workflows-part-3-refactoring-large-branches-and-pull-requests.html">Git Workflows, Part 3: Refactoring Large Branches and Pull Requests</a>
            </p>

        </div>

        <div class="v20"></div>


        <div class="well">

            <h2>November 2019</h2>

            <p class="archive">
            <a href="https://charlesreid1.github.io/git-workflows-part-2-crafting-commits.html">Git Workflows, Part 2: Crafting Commits</a>
            </p>

        </div>

        <div class="v20"></div>


        <div class="well">

            <h2>October 2019</h2>

            <p class="archive">
            <a href="https://charlesreid1.github.io/git-workflows-part-1-supercharging-your-git-config.html">Git Workflows, Part 1: Supercharging your Git Config</a>
            </p>

        </div>

        <div class="v20"></div>


        <div class="well">

            <h2>September 2019</h2>

            <p class="archive">
            <a href="https://charlesreid1.github.io/mocking-aws-in-unit-tests.html">Mocking AWS in Unit Tests</a>
            </p>

        </div>

        <div class="v20"></div>


        <div class="well">

            <h2>May 2019</h2>

            <p class="archive">
            <a href="https://charlesreid1.github.io/deconvoluting-convolutional-neural-networks.html">Deconvoluting Convolutional Neural Networks</a>
            </p>
            <p class="archive">
            <a href="https://charlesreid1.github.io/graphs-for-bioinformatics-part-2-finding-eulerian-paths.html">Graphs for Bioinformatics, Part 2: Finding Eulerian Paths</a>
            </p>
            <p class="archive">
            <a href="https://charlesreid1.github.io/graphs-for-bioinformatics-part-1-de-bruijn-graphs-hamiltonian-paths-and-eulerian-paths.html">Graphs for Bioinformatics, Part 1: de Bruijn Graphs, Hamiltonian Paths, and Eulerian Paths</a>
            </p>

        </div>

        <div class="v20"></div>


        <div class="well">

            <h2>April 2019</h2>

            <p class="archive">
            <a href="https://charlesreid1.github.io/the-git-commit-ectomy.html">The Git-Commit-Ectomy</a>
            </p>

        </div>

        <div class="v20"></div>


        <div class="well">

            <h2>March 2019</h2>

            <p class="archive">
            <a href="https://charlesreid1.github.io/the-josephus-problem-part-3-solving-the-double-step-case.html">The Josephus Problem: Part 3: Solving the Double Step Case</a>
            </p>
            <p class="archive">
            <a href="https://charlesreid1.github.io/the-josephus-problem-part-2-two-examples.html">The Josephus Problem: Part 2: Two Examples</a>
            </p>
            <p class="archive">
            <a href="https://charlesreid1.github.io/the-josephus-problem-part-1-the-problem.html">The Josephus Problem: Part 1: The Problem</a>
            </p>
            <p class="archive">
            <a href="https://charlesreid1.github.io/approximating-pi-happy-pi-day.html">Approximating Pi (Happy Pi Day)</a>
            </p>
            <p class="archive">
            <a href="https://charlesreid1.github.io/five-letter-words-part-5-the-try-trie-tree.html">Five Letter Words: Part 5: The Try Trie Tree</a>
            </p>
            <p class="archive">
            <a href="https://charlesreid1.github.io/five-letter-words-part-4-revisiting-diff-by-one.html">Five Letter Words: Part 4: Revisiting Diff by One</a>
            </p>
            <p class="archive">
            <a href="https://charlesreid1.github.io/centillion-a-document-search-engine.html">centillion: a document search engine</a>
            </p>

        </div>

        <div class="v20"></div>


        <div class="well">

            <h2>February 2019</h2>

            <p class="archive">
            <a href="https://charlesreid1.github.io/any-color-you-like-as-long-as-its-00add8.html">Any Color You Like, As Long As It's 00ADD8</a>
            </p>
            <p class="archive">
            <a href="https://charlesreid1.github.io/a-few-of-my-favorite-peps.html">A Few of My Favorite PEPs</a>
            </p>
            <p class="archive">
            <a href="https://charlesreid1.github.io/context-managers-in-python.html">Context Managers in Python</a>
            </p>

        </div>

        <div class="v20"></div>


        <div class="well">

            <h2>January 2019</h2>

            <p class="archive">
            <a href="https://charlesreid1.github.io/building-snakemake-command-line-wrappers-for-kubernetes-workflows.html">Building Snakemake Command Line Wrappers for Kubernetes Workflows</a>
            </p>
            <p class="archive">
            <a href="https://charlesreid1.github.io/building-snakemake-command-line-wrappers-for-workflows.html">Building Snakemake Command Line Wrappers for Workflows</a>
            </p>
            <p class="archive">
            <a href="https://charlesreid1.github.io/recursive-backtracking-in-go-for-bioinformatics-applications-3-go-implementation-of-backtracking.html">Recursive Backtracking in Go for Bioinformatics Applications: 3. Go Implementation of Backtracking</a>
            </p>

        </div>

        <div class="v20"></div>


        <div class="well">

            <h2>December 2018</h2>

            <p class="archive">
            <a href="https://charlesreid1.github.io/recursive-backtracking-in-go-for-bioinformatics-applications-2-generating-variations.html">Recursive Backtracking in Go for Bioinformatics Applications: 2. Generating Variations</a>
            </p>
            <p class="archive">
            <a href="https://charlesreid1.github.io/recursive-backtracking-in-go-for-bioinformatics-applications-1-counting-variations.html">Recursive Backtracking in Go for Bioinformatics Applications: 1. Counting Variations</a>
            </p>
            <p class="archive">
            <a href="https://charlesreid1.github.io/basic-data-structures-in-go-maps.html">Basic Data Structures in Go: Maps</a>
            </p>
            <p class="archive">
            <a href="https://charlesreid1.github.io/learning-bioinformatics-with-go-and-rosalind.html">Learning Bioinformatics with Go and Rosalind</a>
            </p>

        </div>

        <div class="v20"></div>


        <div class="well">

            <h2>October 2018</h2>

            <p class="archive">
            <a href="https://charlesreid1.github.io/first-post-of-the-fall-part-2-flaskadillo.html">First Post of the Fall, Part 2: Flaskadillo</a>
            </p>
            <p class="archive">
            <a href="https://charlesreid1.github.io/first-post-of-the-fall-part-1-data-commons.html">First Post of the Fall, Part 1: Data Commons</a>
            </p>

        </div>

        <div class="v20"></div>


        <div class="well">

            <h2>May 2018</h2>

            <p class="archive">
            <a href="https://charlesreid1.github.io/current-projects.html">Current Projects</a>
            </p>

        </div>

        <div class="v20"></div>


        <div class="well">

            <h2>March 2018</h2>

            <p class="archive">
            <a href="https://charlesreid1.github.io/charlesreid1com-stack.html">Charlesreid1.com Stack</a>
            </p>

        </div>

        <div class="v20"></div>


        <div class="well">

            <h2>February 2018</h2>

            <p class="archive">
            <a href="https://charlesreid1.github.io/d3-calendar-visualizations.html">D3 Calendar Visualizations</a>
            </p>
            <p class="archive">
            <a href="https://charlesreid1.github.io/project-euler-problem-172.html">Project Euler Problem 172</a>
            </p>

        </div>

        <div class="v20"></div>


        <div class="well">

            <h2>January 2018</h2>

            <p class="archive">
            <a href="https://charlesreid1.github.io/4x4-rubiks-cube-part-4-sequence-order.html">4x4 Rubik's Cube: Part 4: Sequence Order</a>
            </p>
            <p class="archive">
            <a href="https://charlesreid1.github.io/4x4-rubiks-cube-part-3-factoring-permutations.html">4x4 Rubik's Cube: Part 3: Factoring Permutations</a>
            </p>
            <p class="archive">
            <a href="https://charlesreid1.github.io/4x4-rubiks-cube-part-2-permutations.html">4x4 Rubik's Cube: Part 2: Permutations</a>
            </p>
            <p class="archive">
            <a href="https://charlesreid1.github.io/4x4-rubiks-cube-part-1-representations.html">4x4 Rubik's Cube: Part 1: Representations</a>
            </p>
            <p class="archive">
            <a href="https://charlesreid1.github.io/lets-generate-permutations.html">Let's Generate Permutations!</a>
            </p>

        </div>

        <div class="v20"></div>


        <div class="well">

            <h2>September 2017</h2>

            <p class="archive">
            <a href="https://charlesreid1.github.io/five-letter-words-part-3-letter-coverage-and-dynamic-programming.html">Five Letter Words: Part 3: Letter Coverage and Dynamic Programming</a>
            </p>
            <p class="archive">
            <a href="https://charlesreid1.github.io/five-letter-words-part-2-more-five-word-algorithms.html">Five Letter Words: Part 2: More Five-Word Algorithms</a>
            </p>
            <p class="archive">
            <a href="https://charlesreid1.github.io/five-letter-words-part-1-getting-familiar-with-the-list.html">Five Letter Words: Part 1: Getting Familiar With The List</a>
            </p>

        </div>

        <div class="v20"></div>


        <div class="well">

            <h2>August 2017</h2>

            <p class="archive">
            <a href="https://charlesreid1.github.io/eulers-theorem-the-totient-function-and-calculating-totients-by-hand.html">Euler's Theorem, the Totient Function, and Calculating Totients By Hand</a>
            </p>

        </div>

        <div class="v20"></div>


        <div class="well">

            <h2>July 2017</h2>

            <p class="archive">
            <a href="https://charlesreid1.github.io/mad-combinatoric-castles.html">Mad Combinatoric Castles</a>
            </p>
            <p class="archive">
            <a href="https://charlesreid1.github.io/project-euler-problem-1.html">Project Euler Problem 1</a>
            </p>
            <p class="archive">
            <a href="https://charlesreid1.github.io/shortest-lattice-paths-and-multiset-permutations.html">Shortest Lattice Paths and Multiset Permutations</a>
            </p>
            <p class="archive">
            <a href="https://charlesreid1.github.io/computing-square-roots-part-2-using-continued-fractions.html">Computing Square Roots: Part 2: Using Continued Fractions</a>
            </p>
            <p class="archive">
            <a href="https://charlesreid1.github.io/computing-square-roots-part-1-using-newtons-method.html">Computing Square Roots: Part 1: Using Newton's Method</a>
            </p>

        </div>

        <div class="v20"></div>


        <div class="well">

            <h2>June 2017</h2>

            <p class="archive">
            <a href="https://charlesreid1.github.io/cse-143-final-project-hilbert-sort-3-the-code.html">CSE 143 Final Project: Hilbert Sort: 3. The Code</a>
            </p>
            <p class="archive">
            <a href="https://charlesreid1.github.io/cse-143-final-project-hilbert-sort-2-the-solution-algorithm.html">CSE 143 Final Project: Hilbert Sort: 2. The Solution Algorithm</a>
            </p>
            <p class="archive">
            <a href="https://charlesreid1.github.io/cse-143-final-project-hilbert-sort-1-the-problem.html">CSE 143 Final Project: Hilbert Sort: 1. The Problem</a>
            </p>
            <p class="archive">
            <a href="https://charlesreid1.github.io/cse-143-final-project-classy.html">CSE 143 Final Project: Classy</a>
            </p>
            <p class="archive">
            <a href="https://charlesreid1.github.io/cse-143-final-project-checkers.html">CSE 143 Final Project: Checkers</a>
            </p>

        </div>

        <div class="v20"></div>


        <div class="well">

            <h2>May 2017</h2>

            <p class="archive">
            <a href="https://charlesreid1.github.io/teaching-recursion-with-the-n-queens-problem.html">Teaching Recursion with the N Queens Problem</a>
            </p>
            <p class="archive">
            <a href="https://charlesreid1.github.io/undergraduate-research-project-wireless-sensor-networks-for-internet-of-things-applications-part-2-the-technologies.html">Undergraduate Research Project: Wireless Sensor Networks for Internet of Things Applications (Part 2: The Technologies)</a>
            </p>
            <p class="archive">
            <a href="https://charlesreid1.github.io/undergraduate-research-project-wireless-sensor-networks-for-internet-of-things-applications-part-1-the-project.html">Undergraduate Research Project: Wireless Sensor Networks for Internet of Things Applications (Part 1: The Project)</a>
            </p>

        </div>

        <div class="v20"></div>


        <div class="well">

            <h2>April 2017</h2>

            <p class="archive">
            <a href="https://charlesreid1.github.io/stunnel.html">Stunnel</a>
            </p>
            <p class="archive">
            <a href="https://charlesreid1.github.io/traveling-schoolteacher-problem.html">Traveling Schoolteacher Problem</a>
            </p>
            <p class="archive">
            <a href="https://charlesreid1.github.io/the-z-machine-a-simple-turing-machine.html">The Z-Machine: A Simple Turing Machine</a>
            </p>
            <p class="archive">
            <a href="https://charlesreid1.github.io/awsome-day-seattle-notes-part-2-networking-security-and-miscellany.html">AWSome Day Seattle Notes: Part 2: Networking, Security, and Miscellany</a>
            </p>
            <p class="archive">
            <a href="https://charlesreid1.github.io/awsome-day-seattle-notes-part-1-the-basics.html">AWSome Day Seattle Notes: Part 1: The Basics</a>
            </p>
            <p class="archive">
            <a href="https://charlesreid1.github.io/setting-up-a-self-hosted-github-clone-with-gitea.html">Setting Up a Self-Hosted Github Clone with Gitea</a>
            </p>
            <p class="archive">
            <a href="https://charlesreid1.github.io/better-timing-of-guava-traveling-salesperson-problem-code-timing-scripts.html">Better Timing of Guava Traveling Salesperson Problem Code: Timing Scripts</a>
            </p>

        </div>

        <div class="v20"></div>


        <div class="well">

            <h2>March 2017</h2>

            <p class="archive">
            <a href="https://charlesreid1.github.io/fixing-bottlenecks-in-the-guava-traveling-salesperson-problem-code.html">Fixing Bottlenecks in the Guava Traveling Salesperson Problem Code</a>
            </p>
            <p class="archive">
            <a href="https://charlesreid1.github.io/python-vs-perl-n-queens-problem.html">Python vs. Perl: N Queens Problem</a>
            </p>
            <p class="archive">
            <a href="https://charlesreid1.github.io/solving-the-traveling-salesperson-problem-with-java-and-guava.html">Solving the Traveling Salesperson Problem with Java and Guava</a>
            </p>
            <p class="archive">
            <a href="https://charlesreid1.github.io/perl-vs-java-n-queens-problem.html">Perl vs. Java: N Queens Problem</a>
            </p>
            <p class="archive">
            <a href="https://charlesreid1.github.io/enigma-cipher-implementation-part-4-combinatorics.html">Enigma Cipher Implementation: Part 4: Combinatorics</a>
            </p>
            <p class="archive">
            <a href="https://charlesreid1.github.io/enigma-cipher-implementation-part-3-enigma-in-java-without-objects.html">Enigma Cipher Implementation: Part 3: Enigma in Java Without Objects</a>
            </p>
            <p class="archive">
            <a href="https://charlesreid1.github.io/enigma-cipher-implementation-part-2-pseudocode.html">Enigma Cipher Implementation: Part 2: Pseudocode</a>
            </p>
            <p class="archive">
            <a href="https://charlesreid1.github.io/enigma-cipher-implementation-part-1-how-it-works.html">Enigma Cipher Implementation: Part 1: How It Works</a>
            </p>

        </div>

        <div class="v20"></div>



<div class="v100"></div>
        </div>

    </div>



</div>



<script type="text/javascript" src="https://charlesreid1.github.io/theme/js/jquery-1.11.2.js"></script>
<script type="text/javascript" src="https://charlesreid1.github.io/theme/js/bootstrap-3.3.4.js"></script>
<script type="text/javascript" src="https://charlesreid1.github.io/theme/js/d3-3.5.5.js"></script><script type="text/javascript" src="https://charlesreid1.github.io/theme/js/jquery-1.11.2.js"></script>
<script type="text/javascript" src="https://charlesreid1.github.io/theme/js/bootstrap-3.3.4.js"></script>

<footer id="contentinfo" class="body">
<p>&nbsp;</p>
<p>&nbsp;</p>
<center>
	<hr />
</center>
<p>&nbsp;</p>
<p style="text-align: center">
    <span class="fa-stack fa-lg">
        <i class="fa fa-square fa-stack-2x" style="color:#000;"></i>
        <i class="fa fa-terminal fa-stack-1x fa-inverse"></i>
    </span>
    Made from the command line with vim by 
    <a href="http://charlesreid1.com">charlesreid1</a><br />
    with help from <a href="https://getbootstrap.com/">Bootstrap</a> and <a href="http://getpelican.com">Pelican</a>.
</p>

<br />

<p style="text-align: center">
    <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">
    <span class="fa-stack fa-lg">
        <i class="fa fa-square fa-stack-2x" style="color:#000;"></i>
        <i class="fa fa-creative-commons fa-stack-1x fa-inverse"></i>
    </span>
    </a>
    <br />
    Licensed under the <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">Creative Commons Attribution-NonCommercial 4.0 License</a>.
</p>

<!-- Start of StatCounter Code for Default Guide -->
<script type="text/javascript">
var sc_project=11611748;
var sc_invisible=1;
var sc_security="9fcba820";
</script>
<script type="text/javascript"
src="https://www.statcounter.com/counter/counter.js"
async></script>

<noscript><div class="statcounter"><a title="Web Analytics"
href="http://statcounter.com/" target="_blank"><img
class="statcounter"
src="//c.statcounter.com/11611748/0/9fcba820/1/" alt="Web
Analytics"></a></div></noscript>
<!-- End of StatCounter Code for Default Guide -->
</footer><!-- /#contentinfo -->
</body>
</html>