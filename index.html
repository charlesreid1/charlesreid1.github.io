<!DOCTYPE html>
<html lang="en">
<head>
        <title>charlesreid1</title>
        <meta charset="utf-8" />

        <!--
        CSS styles
        -->
        <link href="/theme/css/bootstrap.css"       rel="stylesheet" type="text/css">
        <link href="/theme/css/slate.css"              rel="stylesheet" type="text/css">
        <link href="/theme/css/font-awesome.css"       rel="stylesheet" type="text/css"/>
        <link href="/theme/css/pygment-solarized.css"  rel="stylesheet" type="text/css"/>

        <!--
        my CSS styles
        -->
        <link href="/theme/css/main.css"            rel="stylesheet" type="text/css">
        <link href="/theme/css/dox.css"             rel="stylesheet" type="text/css">


        <!--
        include Angular first
        -->
        <script type="text/javascript" src="/theme/js/angular-1.3.15.js"></script>
        <script type="text/javascript" src="/theme/js/skrollr-0.6.29.js"></script>
        <script type="text/javascript" src="/theme/js/d3-3.5.5.js"></script>

        <!--
        this seems like a bad idea.
        but if I don't put jquery first, I get errors about unrecognized $s.
        -->
        <script type="text/javascript" src="/theme/js/jquery-1.11.2.js"></script>

</head>
<body id="index">
<nav class="navbar navbar-default">
    <div class="container-fluid">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span> 
            </button>
            <a href="https://charlesreid1.github.io" class="navbar-brand">charlesreid1.github.io</a>
        </div>
        <div>
            <div class="collapse navbar-collapse" id="myNavbar">
                <ul class="nav navbar-nav">

                    <li>
                        <a href="https://charlesreid1.com/wiki">Wiki</a>
                    </li>
                    <li>
                        <a href="https://git.charlesreid1.com/explore">Git</a>
                    </li>
                    <li>
                        <a href="http://spotify.charlesreid1.com">Music</a>
                    </li>
                    <li>
                        <a href="https://charlesreid1.com/life">Life</a>
                    </li>
                    <li>
                        <a href="https://charlesreid1.github.io">Blog</a>
                    </li>
                    <li>
                        <a href="https://charlesreid1.com/about">About Me</a>
                    </li>

                </ul>
            </div>
        </div>
    </div>
</nav>



<div class="container">

    <div class="row">
        <div class="col-md-12 col-centered" style="text-align: center;">
            <div class="v50"></div>
            <div class="cosmojumbo">
                <h1 class="jumbojumbo">charlesreid1.com blog<h1>
            </div>
        </div>
    </div>


    <div class="v50"></div>


    <div class="row">

        <div class="col-md-8" style="text-align: center;">

  	            	<article>
<header>
<div class="row">


    <div class="col-md-12">
        <div class="headtext" style="text-align: center;">
            <h1><b>
                A Few of My Favorite PEPs
            </b></h1>
        
            <p class="lead">
                Posted 
                <time datetime="2019-02-11T12:00:00-08:00" pubdate>Monday 02/11/2019</time>
                in 
                <a href="/category/python.html">Python</a>
                </p>
            <p>
            <span style="font-size: 14px">
                <a href="/a-few-of-my-favorite-peps.html">permalink</a>
            </span>
            </p>
        </div>

    </div>

</div>
</header>


<div class="v50"></div>


<div class="row">
    <div class="col-md-12" style="text-align: left;">

        <div class="entry-content"><h2>Table of Contents</h2>
<ul>
<li><a href="#fav">What's your favorite PEP?</a></li>
<li><a href="#p0">PEP 0</a></li>
<li><a href="#p8">PEP 8</a></li>
<li><a href="#p20">PEP 20</a></li>
<li><a href="#p3099">PEP 3099</a><ul>
<li><a href="#2to3">Addendum: 2 to 3 Changes</a></li>
</ul>
</li>
<li><a href="#p202">PEP 202</a></li>
<li><a href="#gh">All the PEPs on Github</a></li>
</ul>
<p><br />
<br /></p>
<p><a name="fav"></a></p>
<h2>What's your favorite PEP?</h2>
<p>PEPs, or <strong>Python Enhancement Proposals</strong>, are documents in which
features, additions, or general ideas are proposed as additions
to the core Python language.</p>
<p>As a Python user, we believe it's important to ask questions like this.</p>
<p>Picking a "favorite PEP" is not just about having a ready and clever
answer to a question you might expect in a technical interview;
the PEP documents really <em>are</em> important, and really <em>do</em> shape 
where Python is today and where it will be in the future.</p>
<p>So let's look at a few of our favorite PEPs.</p>
<p><a name="p0"></a></p>
<h2>PEP 0: The PEP Index</h2>
<p>PEP0 - the easiest answer to the question, "what's your favorite PEP?"</p>
<p><a href="https://www.python.org/dev/peps/">PEP 0 - Index of Python Enhancement Proposals (PEPs)</a>
lists all PEPs, including PEPs about PEPs, accepted PEPs, open PEPs,
finished PEPs, informational PEPs, and abandoned PEPs.</p>
<p>This is also a good place to search for a keyword or browse PEPs.</p>
<p>This PEP is the favorite of people who love enumerations, library card catalogs,
biblical genealogies, and litanies.</p>
<p><a name="p8"></a></p>
<h2>PEP 8: The Python Style Guide</h2>
<p><a href="https://www.python.org/dev/peps/pep-0008/">PEP 8</a>
covers the recommended Python style.
It is a surprisingly quick read.</p>
<p>This PEP dishes "official" opinions about 
controversial topics such as:</p>
<ul>
<li>tabs or spaces (spoiler: <strong><em>spaces</em></strong>)</li>
<li>line width</li>
<li>whitespace</li>
<li>naming conventions for variables, classes, and modules</li>
</ul>
<p>This PEP is the chosen favorite of those programmers who keep their
crayons organized in the correct color order.</p>
<p><a name="p20"></a></p>
<h2>PEP 20: The Zen of Python</h2>
<p><a href="https://www.python.org/dev/peps/pep-0020/">PEP 20</a> contains
20 aphorisms that compose the Zen of Python - only 19 of which
are contained in the PEP...</p>
<p>Also available from Python via:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">this</span>
</pre></div>


<p>Many of the aphorisms in PEP 20 come in pairs.</p>
<p>The first seven alone compose an excellent philosophy of programming.
Six symmetric rules:</p>
<div class="highlight"><pre><span></span>Beautiful is better than ugly.

Explicit is better than implicit.

Simple is better than complex.

Complex is better than complicated.

Flat is better than nested.

Sparse is better than dense.
</pre></div>


<p>The seventh, one of the principal ideas behind Python:</p>
<div class="highlight"><pre><span></span>Readability counts.
</pre></div>


<p>The next pair of aphorisms is important to our own style of programming:</p>
<div class="highlight"><pre><span></span>Special cases aren&#39;t special enough to break the rules.

Although practicality beats purity.
</pre></div>


<p>The latter aphorism is an acknowledgement that, ultimately, programming
is a means to an end, and Python (or whatever programming language you use)
should not <em>get in the way</em> of reaching that end - especially not for the
sake of some abstract principle or theory. </p>
<p>PEP 20 weighs in on errors:</p>
<div class="highlight"><pre><span></span>Errors should never pass silently.

Unless explicitly silenced.
</pre></div>


<p>Slightly perplexing:</p>
<div class="highlight"><pre><span></span>In the face of ambiguity, refuse the temptation to guess.
</pre></div>


<p>More pairs:</p>
<div class="highlight"><pre><span></span>There should be one-- and preferably only one -- obvious way to do it.

Although that way may not be obvious at first unless you&#39;re Dutch.
</pre></div>


<p>From the <a href="https://en.wikipedia.org/wiki/Guido_van_Rossum">Wikipedia page on Guido van Rossum</a>:</p>
<blockquote>
<p>Guido van Rossum is a Dutch programmer...</p>
</blockquote>
<div class="highlight"><pre><span></span>Now is better than never.

Although never is often better than *right* now.
</pre></div>


<p>That last one sounds like an excuse for procrastination.</p>
<div class="highlight"><pre><span></span>If the implementation is hard to explain, it&#39;s a bad idea.

If the implementation is easy to explain, it may be a good idea.
</pre></div>


<p>Finally, the last aphorism covers the reason you never see 
<code>from module import *</code>:</p>
<div class="highlight"><pre><span></span><span class="n">Namespaces</span> <span class="n">are</span> <span class="n">one</span> <span class="n">honking</span> <span class="n">great</span> <span class="n">idea</span> <span class="o">--</span> <span class="k">let</span><span class="c">&#39;s do more of those!</span>
</pre></div>


<p>Namespaces, in this case, come from importing everything in 
a Python package into a particular variable name - like 
<code>import itertools</code> or <code>import numpy as np</code>.</p>
<p>It turns out that, yes, in fact, namespaces are a great idea!</p>
<p><a name="p3099"></a></p>
<h2>PEP 3099: Things That Will Not Change in Python 3000</h2>
<p>We can't really decide what we enjoy most about <a href="https://www.python.org/dev/peps/pep-3099/">PEP 3099</a>.
Maybe it's the fact that it does the opposite of what most 
proclamations of a new major version do, which is, to say
what new features it will <em>not</em> have.
Maybe it's the way the language's creators demonstrate how well
they have learned from the mistakes of others who adopt
the "Burn it to the ground and rewrite from scratch"
philosophy. Or maybe it's the delightful nostalgia of 
"Python 3000".</p>
<p>In any case, PEP 3099 is an instructive read, because any feature
that will explicitly be kept during a major version bump is clearly
either (a) useful, (b) important, or (c) both. Additionally, it 
gives some insight into the design decisions made when Python
was implemented ("Why does Python do X this way, instead of 
some other easier way?").</p>
<p>Not only that, you also get to walk through a graveyard of
abandoned (but still interesting) ideas, and the links given
in the PEP to the Python mailing list can provide additional
useful information.</p>
<p><a name="2to3"></a></p>
<h2>Addendum: PEPs Affecting 2 to 3 Changes</h2>
<p>In contrast to PEP 3099, which contains a list of all the things
that <em>did not</em> change in Python 3, there were a large number of
PEPs that <em>did</em> cause Python 3 to behave differently from Python 2.</p>
<ul>
<li><a href="https://www.python.org/dev/peps/pep-0237">PEP 237</a>: Unified long integers and integers</li>
<li><a href="https://www.python.org/dev/peps/pep-0238">PEP 238</a>: Changed the division operator</li>
<li><a href="https://www.python.org/dev/peps/pep-0412">PEP 412</a>: Key-sharing dictionary</li>
<li><a href="https://www.python.org/dev/peps/pep-0428">PEP 428</a>: Object-oriented filesystem paths</li>
<li><a href="https://www.python.org/dev/peps/pep-0435">PEP 435</a>: Adding enum type</li>
<li><a href="https://www.python.org/dev/peps/pep-0448">PEP 448</a>: Unpacking</li>
<li><a href="https://www.python.org/dev/peps/pep-0450">PEP 450</a>: Adding stats to standard library</li>
<li><a href="https://www.python.org/dev/peps/pep-0498">PEP 498</a>: Literal string interpolation</li>
<li><a href="https://www.python.org/dev/peps/pep-0515">PEP 515</a>: Underscores in numeric literals</li>
<li><a href="https://www.python.org/dev/peps/pep-3101">PEP 3101</a>: Advanced string formatting</li>
<li><a href="https://www.python.org/dev/peps/pep-3102">PEP 3102</a>: Keyword-only arguments</li>
<li><a href="https://www.python.org/dev/peps/pep-3105">PEP 3105</a>: Make print a function</li>
<li><a href="https://www.python.org/dev/peps/pep-3111">PEP 3111</a>: User input in Python 3000</li>
<li><a href="https://www.python.org/dev/peps/pep-3114">PEP 3114</a>: Renaming <code>next()</code> to <code>__next__()</code></li>
<li><a href="https://www.python.org/dev/peps/pep-3135">PEP 3135</a>: Super behavior</li>
</ul>
<p><a name="p202"></a></p>
<h2>PEP 202: List Comprehensions</h2>
<p>Of course, picking your favorite PEP can also be an opportunity
to make a statement about your favorite language feature of Python,
since many of Python's most useful language features got their start 
as PEPs.</p>
<p>For us, list comprehensions (covered in <a href="https://www.python.org/dev/peps/pep-0202/">PEP 202</a>)
area clear winner in any competition of most useful language features. 
List comprehensions are a way of shortening for loop syntax, making it
much easier to perform map and filtering operations. Some examples
from PEP 202:</p>
<div class="highlight"><pre><span></span>&gt;&gt;&gt; print([i for i in range(20) if i%2 == 0])
[0, 2, 4, 6, 8, 10, 12, 14, 16, 18]

&gt;&gt;&gt; nums = [1, 2, 3, 4]

&gt;&gt;&gt; fruit = [&quot;Apples&quot;, &quot;Peaches&quot;, &quot;Pears&quot;, &quot;Bananas&quot;]

&gt;&gt;&gt; print [(i, f) for i in nums for f in fruit]
[(1, &#39;Apples&#39;), (1, &#39;Peaches&#39;), (1, &#39;Pears&#39;), (1, &#39;Bananas&#39;),
 (2, &#39;Apples&#39;), (2, &#39;Peaches&#39;), (2, &#39;Pears&#39;), (2, &#39;Bananas&#39;),
 (3, &#39;Apples&#39;), (3, &#39;Peaches&#39;), (3, &#39;Pears&#39;), (3, &#39;Bananas&#39;),
 (4, &#39;Apples&#39;), (4, &#39;Peaches&#39;), (4, &#39;Pears&#39;), (4, &#39;Bananas&#39;)]

&gt;&gt;&gt; print([(i, f) for i in nums for f in fruit if f[0] == &quot;P&quot;])
[(1, &#39;Peaches&#39;), (1, &#39;Pears&#39;),
 (2, &#39;Peaches&#39;), (2, &#39;Pears&#39;),
 (3, &#39;Peaches&#39;), (3, &#39;Pears&#39;),
 (4, &#39;Peaches&#39;), (4, &#39;Pears&#39;)]

&gt;&gt;&gt; print([(i, f) for i in nums for f in fruit if f[0] == &quot;P&quot; if i%2 == 1])
[(1, &#39;Peaches&#39;), (1, &#39;Pears&#39;), (3, &#39;Peaches&#39;), (3, &#39;Pears&#39;)]

&gt;&gt;&gt; print([i for i in zip(nums, fruit) if i[0]%2==0])
[(2, &#39;Peaches&#39;), (4, &#39;Bananas&#39;)]
</pre></div>


<p>List comprehensions enable code to be short but expressive, 
brief but elegant. Brevity is the soul of wit, after all.</p>
<p><a name="gh"></a></p>
<h2>All the PEPs on Github</h2>
<p><a href="https://github.com/python/peps">All the PEPs are available on Github.</a></p></div>

    </div>
</div>

<div class="v20"></div>

<div class="row">
    <div class="col-md-12" style="text-align: left;">

        <div class="tags">
            <p>Tags:&nbsp;&nbsp;&nbsp;
                    <a href="/tag/python.html">python</a>
                    &nbsp;&nbsp;
                    <a href="/tag/pep.html">pep</a>
                    &nbsp;&nbsp;
                    <a href="/tag/computer-science.html">computer science</a>
                    &nbsp;&nbsp;
                    <a href="/tag/programming.html">programming</a>
                    &nbsp;&nbsp;
        </div>

    </div>
</div>


<div class="v200"></div>
  	            	</article>
  	            	<article>
<header>
<div class="row">


    <div class="col-md-12">
        <div class="headtext" style="text-align: center;">
            <h1><b>
                Context Managers in Python
            </b></h1>
        
            <p class="lead">
                Posted 
                <time datetime="2019-02-02T10:00:00-08:00" pubdate>Saturday 02/02/2019</time>
                in 
                <a href="/category/python.html">Python</a>
                </p>
            <p>
            <span style="font-size: 14px">
                <a href="/context-managers-in-python.html">permalink</a>
            </span>
            </p>
        </div>

    </div>

</div>
</header>


<div class="v50"></div>


<div class="row">
    <div class="col-md-12" style="text-align: left;">

        <div class="entry-content"><h2>Table of Contents</h2>
<ul>
<li><a href="#predicament">A Predicament</a></li>
<li><a href="#wat">What is a context manager?</a></li>
<li><a href="#wat">What is Graphviz dot?</a></li>
<li><a href="#stdout">Capturing stdout</a></li>
<li><a href="#replacing">Replacing stdout</a></li>
<li><a href="#context">Creating a context manager</a><ul>
<li><a href="#_init">Constructor</a></li>
<li><a href="#_enter">Enter method</a></li>
<li><a href="#_exit">Exit method</a></li>
<li><a href="#action">In action</a></li>
</ul>
</li>
<li><a href="#using">Using the new dag flags</a></li>
<li><a href="#other">Other context manager applications</a><ul>
<li><a href="#ssh">SSH connections</a></li>
<li><a href="#ssh">Jupyter notebook</a></li>
<li><a href="#figs">iPython (Jupyter) notebook and matplotlib figure management</a></li>
<li><a href="#dbconn">Database connection</a></li>
</ul>
</li>
<li><a href="#refs">References</a></li>
</ul>
<p><br />
<br /></p>
<p><a name="predicament"></a></p>
<h2>A Predicament</h2>
<p>Recently we spent some time contributing to
<a href="https://github.com/dib-lab/eelpond">dib-lab/eelpond (renamed to elvers)</a>,
an executable <a href="https://snakemake.readthedocs.io/en/stable/">Snakemake</a>
workflow for running the 
<a href="https://khmer-protocols.readthedocs.io/en/latest/mrnaseq/index.html">eelpond mRNAseq workflow</a>.</p>
<p>In the process of tracking down a confusing
bug in the Snakemake workflow, we used Snakemake's
ability to print a directed acyclic graph (hereafter
referred to as a <strong>dag</strong>) representing
its task graph. Snakemake prints the dot notation
to stdout.</p>
<p>(The graph representation ended up identifying the problem,
which was two task graphs that were independent, but 
which were not supposed to be independent.)</p>
<p>When creating the Graphviz dot notation,
Snakemake is kind enough to direct all of its output
messages to stderr, and direct the dot graph output 
to stdout, which makes it easy to redirect stdout
to a <code>.dot</code> file and process it with Graphviz.</p>
<p>Github user <a href="https://github.com/bluegenes">@bluegenes</a>
(the principal author of elvers) <a href="https://github.com/dib-lab/eelpond/pull/69">added a <code>--dag</code> file to the <code>run_eelpond</code> script</a>,
which asks Snakemake to print the dag when it calls
the Snakemake API:</p>
<div class="highlight"><pre><span></span>./run_eelpond --dag ... &gt; eelpond_dag.dot
</pre></div>


<p>This .dot file can then be rendered into a .png file
with another command from the command line,</p>
<div class="highlight"><pre><span></span>dot eelpond_dag.dot -Tpng -o eelpond_dag.png
</pre></div>


<p>Simple, right?</p>
<p><strong>But here's the problem:</strong>
While this is a simple and easy way to generate the dag,
it introduces some extra steps for the user, and it
also prevents us from being able to print <em>anything</em> to
stdout before or after the dag is generated, since
anything printed out by the program to stdout will
be redirected to the final dot file along with all
the Graphviz dot output.</p>
<p>So how to avoid the extra steps on the command line,
while also improving the flexibility in printing to
stdout (i.e., only capturing Snakemake's output to
a file)?</p>
<p>Can we add two flags like <code>--dagfile</code> and <code>--dagpng</code>
that would, respectively, save the task graph 
directly into a .dot file, or render the dot output
from Snakemake directly into a png using dot?</p>
<p>We <a href="https://github.com/dib-lab/eelpond/pull/73">implemented precisely this functionality</a>
in dib-lab/eelpond PR #73. To do this,
we utilized a context manager to capture output
from Snakemake. In this post we'll cover how
this context manager works, and mention a few
other possibilities with context managers.</p>
<p><a name="wat"></a></p>
<h2>What is a context manager?</h2>
<p>If you have done even a little Python programming,
you have probably seen and used <a href="https://docs.python.org/3/reference/datamodel.html#context-managers">context managers</a>
before - they are blocks of code that are
opened using a <code>with</code> keyword in Python. For example,
the classic Pythonic way to write to a file uses
a context manager:</p>
<div class="highlight"><pre><span></span>with open(&#39;file.txt&#39;, &#39;w&#39;) as f:
    f.write(&quot;\n&quot;.join(range(10)))
</pre></div>


<p>The context manager defines a runtime context for
all the code in the block - and that can be a different
context than the rest of the program. When a context
is opened (when the <code>with</code> block is encountered), 
a context manager object is created and its <code>__enter__()</code>
method is run. This method will modify the runtime
context in whatever way it needs,
and the rest of the code in the block will be run.
When the context is done, where the block ends,
the context manager's <code>__exit__()</code> method is run.
This restores the runtime context to its
normal state for the rest of the program.</p>
<p>It's a general concept with a <em>lot</em> of different 
applications. We cover how to use it to capture
output to <code>sys.stdout</code> below.</p>
<p><a name="dot"></a></p>
<h2>What is Graphviz dot?</h2>
<p>We mentioned that Snakemake can output visualizations of
workflows in Graphviz dot format. For the purposes
of clarity we explain what that format is here.</p>
<p>Without getting too sidetracked, <a href="https://graphviz.org/">Graphviz dot</a>
defines a notation for drawing graphs, and provides software
for laying out the graphs in rendered images.</p>
<p>The user specifies the nodes and labels and edges, as well as
formatting and layout details, and dot takes care of laying
out the graph.</p>
<p>Here's an example of a simple graph in dot notation:</p>
<p><strong><code>plot.dot</code></strong></p>
<div class="highlight"><pre><span></span>digraph G {
    Boston
    &quot;New York&quot;
    Houston
    &quot;Los Angeles&quot;
    Seattle

    Boston -&gt; &quot;New York&quot;
    Boston -&gt; Houston
    Houston -&gt; Boston
    Houston -&gt; &quot;Los Angeles&quot;
    &quot;New York&quot; -&gt; Seattle
    Seattle -&gt; &quot;New York&quot;
    &quot;New York&quot; -&gt; &quot;Los Angeles&quot;
}
</pre></div>


<p>To render this as a .png image,</p>
<div class="highlight"><pre><span></span>dot cities.dot -Tpng -o cities.png
</pre></div>


<p>which becomes:</p>
<p><img alt="dot graph of cities" src="/images/dot_cities.png"></p>
<p>This tool makes visualizing workflows a breeze,
as the flow of tasks is much easier to understand
and troubleshoot than the convoluted logic of
Snakefile rules. Here is an example from elvers:</p>
<p><img alt="elvers dag" src="/images/elvers_dag.png"></p>
<p><a name="stdout"></a></p>
<h2>Capturing stdout</h2>
<p>In elvers, the <code>run_eelpond</code> command line wrapper that kicks
off the workflow is a Python script that calls the Snakemake
API (we covered this approach in a prior blog post,
<a href="https://charlesreid1.github.io/building-snakemake-command-line-wrappers-for-workflows.html">Building Snakemake Command Line Wrappers for Workflows</a>).</p>
<p>This Python script has a call to the Snakemake API; here
is the relevant snippet:</p>
<div class="highlight"><pre><span></span>        # ...set up...

        if not building_dag:
            print(&#39;--------&#39;)
            print(&#39;details!&#39;)
            print(&#39;\tsnakefile: {}&#39;.format(snakefile))
            print(&#39;\tconfig: {}&#39;.format(configfile))
            print(&#39;\tparams: {}&#39;.format(paramsfile))
            print(&#39;\ttargets: {}&#39;.format(repr(targs)))
            print(&#39;\treport: {}&#39;.format(repr(reportfile)))
            print(&#39;--------&#39;)

        # Begin snakemake API call

        status = snakemake.snakemake(snakefile, configfile=paramsfile, use_conda=True, 
                                 targets=[&#39;eelpond&#39;], printshellcmds=True, 
                                 cores=args.threads, cleanup_conda= args.cleanup_conda,
                                 dryrun=args.dry_run, lock=not args.nolock,
                                 unlock=args.unlock,
                                 verbose=args.verbose, debug_dag=args.debug, 
                                 conda_prefix=args.conda_prefix, 
                                 create_envs_only=args.create_envs_only,
                                 restart_times=args.restart_times,
                                 printdag=building_dag, keepgoing=args.keep_going,
                                 forcetargets=args.forcetargets,forceall=args.forceall)

        # End snakemake API call

        # ...clean up...
</pre></div>


<p>Most of the code that comes before this API call is processing
the flags provided by the user. We want to have the flexibility
to print to stdout while processing flags, before we get to the
Snakemake API call; and we want those messages to be kept separate
from the dag output.</p>
<p>In other words, we only want to capture output to stdout between
"Begin snakemake API call" and "End snakemake API call". Everywhere
else, stdout can go to stdout like normal.</p>
<p>We can do this by recognizing that any Python program printing to
stdout uses <code>sys.stdout</code> under the hood to send output to stdout -
so if we can somehow tell Python to swap out stdout with a string
buffer that has the same methods (print, printf, etc.), run Snakemake,
then replace stdout again, we can isolate and capture all stdout from
the Snakemake API call.</p>
<p><a name="replacing"></a></p>
<h2>Replacing stdout</h2>
<p>The strategy for our context manager and the entry and exit
methods, then, is clear:</p>
<ul>
<li>
<p>If the user has specified the <code>--dag</code> flag, 
  the <code>__entry__()</code> method should replace stdout
  with a StringIO buffer within our new runtime 
  context; otherwise, leave stdout alone.</p>
</li>
<li>
<p>If the user has specified the <code>--dag</code> flag,
  the <code>__exit__()</code> method should clean up by
  restoring <code>sys.stdout</code>; otherwise, do nothing.</p>
</li>
</ul>
<p>Now we are ready to make our context manager object.</p>
<p>But wait! What kind of object are we using? Do we need
some kind of special context manager class?
Nope! This is one of the features of context
managers that makes them magical: </p>
<p><em><strong>Any</strong> object can be a context manager.</em></p>
<p>All we need to do is add <code>__enter__()</code> and <code>__exit__()</code>
methods to an object, and it can become a context
manager.</p>
<p><a name="context"></a></p>
<h2>Creating a context manager</h2>
<p>In our case, we are capturing stdout from Snakemake
so that we can potentially process it, and then dump 
it to a file. We don't know how many lines Snakemake
will output, so we will replace <code>sys.stdout</code> with a string
buffer. But once the context closes, we want all those
strings in something more convenient, like a list.</p>
<p>So, we can define a new class that derives from the 
list class, and just adds <code>__enter__()</code> and <code>__exit__()</code>
methods, to enable this list to be a context manager:</p>
<div class="highlight"><pre><span></span><span class="kr">class</span> <span class="nx">CaptureStdout</span><span class="p">(</span><span class="nx">list</span><span class="p">)</span><span class="o">:</span>
    <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    A utility object that uses a context manager</span>
<span class="s2">    to capture stdout from Snakemake. Useful when</span>
<span class="s2">    creating the directed acyclic graph.</span>
<span class="s2">    &quot;&quot;&quot;</span>
    <span class="nx">def</span> <span class="nx">__init__</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span><span class="o">*</span><span class="nx">args</span><span class="p">,</span><span class="o">**</span><span class="nx">kwargs</span><span class="p">)</span><span class="o">:</span>
        <span class="nx">pass</span>

    <span class="nx">def</span> <span class="nx">__enter__</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span><span class="o">*</span><span class="nx">args</span><span class="p">,</span><span class="o">**</span><span class="nx">kwargs</span><span class="p">)</span><span class="o">:</span>
        <span class="nx">pass</span>

    <span class="nx">def</span> <span class="nx">__exit__</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span><span class="o">*</span><span class="nx">args</span><span class="p">,</span><span class="o">**</span><span class="nx">kwargs</span><span class="p">)</span><span class="o">:</span>

    <span class="p">...</span>
</pre></div>


<p>(Note that we include the constructor, since we
need the context manager to have a state so that
we can restore the original runtime context to
the way it was when we're done.)</p>
<p><a name="_init"></a></p>
<h3>Constructor</h3>
<p>The constructor is where we process any input
arguments passed in when the context is created.</p>
<p>Given that we want our context manager to handle
the case of a directed acyclic graph by capturing
stdout, and do nothing otherwise, we should have
a flag in the constructor indicating whether
we want to pass stdout through, or whether we
want to capture it.</p>
<p>Additionally, we don't need to call the parent
(super) class constructor, i.e., the list constructor,
because we always start with an empty list.
No need to call <code>super().__init__()</code>.</p>
<p>Here is the constructor:</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CaptureStdout</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A utility object that uses a context manager</span>
<span class="sd">    to capture stdout from Snakemake. Useful when</span>
<span class="sd">    creating the directed acyclic graph.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">passthru</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="c1"># Boolean: should we pass everything through to stdout?</span>
        <span class="c1"># (this object is only functional if passthru is False)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">passthru</span> <span class="o">=</span> <span class="n">passthru</span>
</pre></div>


<p><a name="_enter"></a></p>
<h3>Enter method</h3>
<p>When we open the context, we want to swap out
<code>sys.stdout</code> with a string buffer. But we also
want to save the original <code>sys.stdout</code> object
reference, so that we can restore the original
runtime context and let the program continue
printing to stdout after Snakemake is done.</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">StringIO</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="k">class</span> <span class="nc">CaptureStdout</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>

    <span class="o">...</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Open a new context with this CaptureStdout</span>
<span class="sd">        object. This happens when we say</span>
<span class="sd">        &quot;with CaptureStdout() as output:&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If we are just passing input on to output, pass thru</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">passthru</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="c1"># Otherwise, we want to swap out sys.stdout with</span>
        <span class="c1"># a StringIO object that will save stdout.</span>
        <span class="c1"># </span>
        <span class="c1"># Save the existing stdout object so we can</span>
        <span class="c1"># restore it when we&#39;re done</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stdout</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
        <span class="c1"># Now swap out stdout </span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stringio</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>
</pre></div>


<h3>Exit method</h3>
<p>To clean up, we will need to restore <code>sys.stdout</code>
using the pointer we saved in <code>__enter__</code>, then
process the string buffer.</p>
<p>We can also use the <code>del</code> operator to clean up
the space used by the buffer object once we've
transferred its contents.</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">StringIO</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="k">class</span> <span class="nc">CaptureStdout</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>

    <span class="o">...</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Close the context and clean up.</span>
<span class="sd">        The *args are needed in case there is an</span>
<span class="sd">        exception (we don&#39;t deal with those here).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If we are just passing input on to output, pass thru</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">passthru</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="c1"># This entire class extends the list class,</span>
        <span class="c1"># so we call self.extend() to add a list to </span>
        <span class="c1"># the end of self (in this case, all the new</span>
        <span class="c1"># lines from our StringIO object).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stringio</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">())</span>

        <span class="c1"># Clean up (if this is missing, the garbage collector</span>
        <span class="c1"># will eventually take care of this...)</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stringio</span>

        <span class="c1"># Clean up by setting sys.stdout back to what</span>
        <span class="c1"># it was before we opened up this context.</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stdout</span>
</pre></div>


<p><a name="action"></a></p>
<h3>In action</h3>
<p>To see the context manager in action, let's go back to
the snippet of code where we call the Snakemake API:</p>
<div class="highlight"><pre><span></span>        <span class="c1"># Set up a context manager to capture stdout if we&#39;re building</span>
        <span class="c1"># a directed acyclic graph (which prints the graph in dot format</span>
        <span class="c1"># to stdout instead of to a file).</span>
        <span class="c1"># If we are not bulding a dag, pass all output straight to stdout</span>
        <span class="c1"># without capturing any of it.</span>
        <span class="n">passthru</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">building_dag</span>
        <span class="k">with</span> <span class="n">CaptureStdout</span><span class="p">(</span><span class="n">passthru</span><span class="o">=</span><span class="n">passthru</span><span class="p">)</span> <span class="k">as</span> <span class="n">output</span><span class="p">:</span>
            <span class="c1"># run!!</span>
            <span class="c1"># params file becomes snakemake configfile</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">snakemake</span><span class="o">.</span><span class="n">snakemake</span><span class="p">(</span><span class="n">snakefile</span><span class="p">,</span> <span class="n">configfile</span><span class="o">=</span><span class="n">paramsfile</span><span class="p">,</span> <span class="n">use_conda</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> 
                                     <span class="n">targets</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;eelpond&#39;</span><span class="p">],</span> <span class="n">printshellcmds</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> 
                                     <span class="n">cores</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">threads</span><span class="p">,</span> <span class="n">cleanup_conda</span><span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">cleanup_conda</span><span class="p">,</span>
                                     <span class="n">dryrun</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">dry_run</span><span class="p">,</span> <span class="n">lock</span><span class="o">=</span><span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">nolock</span><span class="p">,</span>
                                     <span class="n">unlock</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">unlock</span><span class="p">,</span>
                                     <span class="n">verbose</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span> <span class="n">debug_dag</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span> 
                                     <span class="n">conda_prefix</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">conda_prefix</span><span class="p">,</span> 
                                     <span class="n">create_envs_only</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">create_envs_only</span><span class="p">,</span>
                                     <span class="n">restart_times</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">restart_times</span><span class="p">,</span>
                                     <span class="n">printdag</span><span class="o">=</span><span class="n">building_dag</span><span class="p">,</span> <span class="n">keepgoing</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">keep_going</span><span class="p">,</span>
                                     <span class="n">forcetargets</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">forcetargets</span><span class="p">,</span><span class="n">forceall</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">forceall</span><span class="p">)</span>
</pre></div>


<p>Once we have closed the runtime context, our variable
<code>output</code> is a list with all the output from Snakemake
(assuming we're creating a dag; if not, everything is
passed through to stdout like normal).</p>
<p>The last bit here is to handle the three different
dag flags: <code>--dag</code>, <code>--dagfile</code>, and <code>--dagpng</code>.</p>
<ul>
<li>
<p><code>--dag</code> prints the dot graph straight to stdout,
  like Snakemake's default dag behavior;</p>
</li>
<li>
<p><code>--dagfile=&lt;dotfile&gt;</code> dumps the dot graph to a 
  dot file</p>
</li>
<li>
<p><code>--dagpng=&lt;pngfile&gt;</code> uses dot (installed in the
  elvers conda environment) to render the dot output
  from Snakemake directly into a png image</p>
</li>
</ul>
<p>We handle these three cases like so:</p>
<div class="highlight"><pre><span></span>        if building_dag:

            # These three --build args are mutually exclusive,
            # and are checked in order of precedence (hi to low):
            # --dag         to stdout
            # --dagfile     to .dot
            # --dagpng      to .png

            if args.dag:
                # straight to stdout
                print(&quot;\n&quot;.join(output))

            elif args.dagfile:
                with open(args.dagfile,&#39;w&#39;) as f:
                    f.write(&quot;\n&quot;.join(output))
                print(f&quot;\tPrinted workflow dag to dot file {args.dagfile}\n\n &quot;)

            elif args.dagpng:
                # dump dot output to temporary dot file
                with open(&#39;.temp.dot&#39;,&#39;w&#39;) as f:
                    f.write(&quot;\n&quot;.join(output))
                subprocess.call([&#39;dot&#39;,&#39;-Tpng&#39;,&#39;.temp.dot&#39;,&#39;-o&#39;,args.dagpng])
                subprocess.call([&#39;rm&#39;,&#39;-f&#39;,&#39;.temp.dot&#39;])
                print(f&quot;\tPrinted workflow dag to png file {args.dagpng}\n\n &quot;)
</pre></div>


<p>Note that before the Snakemake API call, we also check
whether <code>dot</code> exists:</p>
<div class="highlight"><pre><span></span>        # if user specified --dagpng,
        # graphviz dot must be present
        if args.dagpng:
            if shutil.which(&#39;dot&#39;) is None:
                sys.stderr.write(f&quot;\n\tError: Cannot find &#39;dot&#39; utility, but --dotpng flag was specified. Fix this by installing graphviz dot.\n\n&quot;)
                sys.exit(-1)
</pre></div>


<p>The final code is implemented in the <a href="https://github.com/dib-lab/eelpond/tree/cmr_better_dag_handling"><code>cmr_better_dag_handling</code> branch of eelpond/elvers</a>
and <a href="https://github.com/dib-lab/eelpond/pull/73">pull request #73 in eelpond/elvers</a>.</p>
<p><a name="using"></a></p>
<h2>Using the new dag flags</h2>
<div class="highlight"><pre><span></span>$ git clone https://github.com/dib-lab/eelpond.git
$ <span class="nb">cd</span> eelpond
$ conda env create --file environment.yml -n eelpond
$ conda activate eelpond
</pre></div>


<p>Now we're ready to run the workflow.
We can use the <code>-w</code> flag to list all workflows,
then use the <code>-n</code> flag to do a dry run.</p>
<p>We'll use the <code>kmer_trim</code> workflow target:</p>
<div class="highlight"><pre><span></span>$ ./run_eelpond examples/nema.yaml kmer_trim -n

...lots of output...

Job counts:
    count   <span class="nb">jobs</span>
    <span class="m">1</span>   eelpond
    <span class="m">10</span>  http_get_fq1
    <span class="m">10</span>  http_get_fq2
    <span class="m">10</span>  khmer_pe_diginorm
    <span class="m">10</span>  khmer_split_paired
    <span class="m">10</span>  trimmomatic_pe
    <span class="m">51</span>
This was a dry-run <span class="o">(</span>flag -n<span class="o">)</span>. The order of <span class="nb">jobs</span> does not
reflect the order of execution.
</pre></div>


<p>Now we can create a dag for this workflow target:</p>
<div class="highlight"><pre><span></span>$ ./run_eelpond examples/nema.yaml kmer_trim --dagfile<span class="o">=</span>dag_kmertrimming.dot
    Added default parameters from rule-specific params files.
    Writing full params to examples/.ep_nema.yaml
Building DAG of jobs...
    Printed workflow dag to dot file dag_kmertrimming.dot
</pre></div>


<p>Finally, we can use the <code>--dagpng</code> flag for instant
gratification:</p>
<div class="highlight"><pre><span></span>$ ./run_eelpond examples/nema.yaml kmer_trim --dagpng<span class="o">=</span>dag_kmertrimming.png
    Added default parameters from rule-specific params files.
    Writing full params to examples/.ep_nema.yaml
Building DAG of jobs...
    Printed workflow dag to png file dag_kmertrimming.png
</pre></div>


<p>Note that you can add a line <code>rankdir=LR;</code> to your dot
file to change the orientation of the graph (left-to-right
order makes highly-parallel workflows vertically stretched,
so they are eaiser to view).</p>
<div class="highlight"><pre><span></span>digraph mydigraph {

    rankdir=LR;

    ...
</pre></div>


<p>and here is the result:</p>
<p><img alt="elvers dag" src="/images/elvers_dag.png"></p>
<p><a name="other"></a></p>
<h2>Other context manager applications</h2>
<p>Actions requiring temporary contexts, which are a bit like self-contained
workspaces, are good candidates for context managers. Following are a
few examples and references.</p>
<p><br /></p>
<p><a name="ssh"></a>
<strong>SSH connections:</strong> the context manager's <code>__enter__</code> function creates/loads
connection details, creates a connection object, and opens the connection.
The <code>__exit__</code> function cleans up by closing the connection. This way,
you can say something like</p>
<div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">SSHConnectionManager</span><span class="p">(</span><span class="n">device</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span><span class="s2">&quot;echo hello world&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Enountered an error running remote command&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</pre></div>


<p>Blog post: <a href="https://packetpushers.net/using-python-context-managers/">Using Python Context Managers for SSH connections</a></p>
<p>(Note: this blog post uses a context manager that is a generator
decorated with a context manager utility function; this is a 
different approach than our class-based approach but is still
valid.</p>
<p><br /></p>
<p><a name="figs"></a>
<strong>iPython notebook and matplotlib figure management:</strong> Camille Scott has
<a href="http://www.camillescott.org/2014/05/05/context-management/">a blog post</a> 
covering a way of managing large Jupyter notebooks with
lots of figures using context managers. In this case, the context
that is being set up and torn down is a matplotlib plot context,
and it is creating each plot, saving it to a file, then closing
the plot. This makes the notebook a lot faster than trying to render
every single plot, and makes it a lot cleaner than littering the code
with manual figure and axis management.</p>
<p>Here is the example usage Camille gives:</p>
<div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">FigManager</span><span class="p">(</span><span class="s1">&#39;genes_per_sample&#39;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">tall_size</span><span class="p">)</span> <span class="k">as</span> <span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">):</span>
    <span class="n">genes_support_df</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;barh&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> 
                                <span class="n">color</span><span class="o">=</span><span class="n">labels_df</span><span class="o">.</span><span class="n">color</span><span class="p">,</span> 
                                <span class="n">figure</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Represented Genes per Sample&#39;</span><span class="p">)</span>

<span class="n">FileLink</span><span class="p">(</span><span class="s1">&#39;genes_per_sample.svg&#39;</span><span class="p">)</span>
</pre></div>


<p>(The <code>FileLink</code> function opens/processes the resulting image.)</p>
<p>Nice!</p>
<p>Blog post: <a href="http://www.camillescott.org/2014/05/05/context-management/">Context Managers and IPython Notebook</a></p>
<p><br /></p>
<p><a name="dbconn"></a>
<strong>Database Connection:</strong> this example comes from Django's test suite.
In it, a context manager is defined that creates new MySQL database
connections when the context is opened, and closes them when the
context is done.</p>
<p>Here is the context manager, which again uses the decorator + generator
approach rather than the class approach:</p>
<p><strong><code>django/tests/backends/mysql/tests.py</code>:</strong></p>
<div class="highlight"><pre><span></span><span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">get_connection</span><span class="p">():</span>
    <span class="n">new_connection</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">new_connection</span>
    <span class="n">new_connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>


<p>(<a href="https://github.com/django/django/blob/master/tests/backends/mysql/tests.py">Link to file on Github</a>)</p>
<p>The first two lines of this function are equivalent to an <code>__enter__</code> method,
while the last line is equivalent to an <code>__exit__</code> method.</p>
<p>This context manager is then used like so:</p>
<div class="highlight"><pre><span></span>    <span class="k">with</span> <span class="n">get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">new_connection</span><span class="p">:</span>
        <span class="n">new_connection</span><span class="o">.</span><span class="n">settings_dict</span><span class="p">[</span><span class="s1">&#39;OPTIONS&#39;</span><span class="p">][</span><span class="s1">&#39;isolation_level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">other_isolation_level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_isolation_level</span><span class="p">(</span><span class="n">new_connection</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isolation_values</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">other_isolation_level</span><span class="p">]</span>
        <span class="p">)</span>
</pre></div>


<p>The context manager is a convenient way of creating a copy
of an existing MySQL connection, then closing it when the
requesting method is finished using it.</p>
<p><br />
<br /></p>
<p><a name="refs"></a></p>
<h2>References</h2>
<ol>
<li>
<p><a href="https://github.com/dib-lab/eelpond">elvers (dib-lab/eelpond on Github)</a>,</p>
<ul>
<li>Author: <a href="https://github.com/bluegenes">@bluegenes on Github</a></li>
<li><a href="https://github.com/dib-lab/eelpond/pull/69">PR adding <code>--dag</code> flag</a>,</li>
<li><a href="https://github.com/dib-lab/eelpond/pull/73">PR adding <code>--dagfile</code> and <code>--dagpng</code> flags</a></li>
</ul>
</li>
<li>
<p><a href="https://khmer-protocols.readthedocs.io/en/latest/mrnaseq/index.html">eelpond mRNAseq workflow</a>.</p>
<ul>
<li>this mRNAseq data processing protocol
  served as the original inspiration for
  elvers</li>
</ul>
</li>
<li>
<p><a href="https://docs.python.org/3/reference/datamodel.html#context-managers">Context managers (Python documentation)</a></p>
</li>
<li>
<p><a href="https://www.python.org/dev/peps/pep-0343/">PEP 343 - the "with" statement</a></p>
</li>
<li>
<p><a href="https://snakemake.readthedocs.io/en/stable/">Snakemake</a></p>
</li>
<li>
<p><a href="https://graphviz.org/">Graphviz dot</a></p>
</li>
<li>
<p><a href="https://charlesreid1.github.io/building-snakemake-command-line-wrappers-for-workflows.html">Building Snakemake Command Line Wrappers for Workflows (charlesreid1 blog)</a></p>
</li>
</ol></div>

    </div>
</div>

<div class="v20"></div>

<div class="row">
    <div class="col-md-12" style="text-align: left;">

        <div class="tags">
            <p>Tags:&nbsp;&nbsp;&nbsp;
                    <a href="/tag/context-managers.html">context managers</a>
                    &nbsp;&nbsp;
                    <a href="/tag/testing.html">testing</a>
                    &nbsp;&nbsp;
                    <a href="/tag/python.html">python</a>
                    &nbsp;&nbsp;
                    <a href="/tag/programming.html">programming</a>
                    &nbsp;&nbsp;
        </div>

    </div>
</div>


<div class="v200"></div>
  	            	</article>
  	            	<article>
<header>
<div class="row">


    <div class="col-md-12">
        <div class="headtext" style="text-align: center;">
            <h1><b>
                Building Snakemake Command Line Wrappers for Kubernetes Workflows
            </b></h1>
        
            <p class="lead">
                Posted 
                <time datetime="2019-01-28T20:00:00-08:00" pubdate>Monday 01/28/2019</time>
                in 
                <a href="/category/snakemake.html">Snakemake</a>
                </p>
            <p>
            <span style="font-size: 14px">
                <a href="/building-snakemake-command-line-wrappers-for-kubernetes-workflows.html">permalink</a>
            </span>
            </p>
        </div>

    </div>

</div>
</header>


<div class="v50"></div>


<div class="row">
    <div class="col-md-12" style="text-align: left;">

        <div class="entry-content"><p><strong>NOTE:</strong> These ideas are implemented in the repository
<a href="https://github.com/charlesreid/2019-snakemake-byok8s">charlesreid1/2019-snakemake-byok8s</a>.</p>
<p><br />
<br /></p>
<h2>Table of Contents:</h2>
<ul>
<li><a href="#exe">Recap: Workflows as Executables</a><ul>
<li><a href="#2018">2018-snakemake-cli</a></li>
<li><a href="#2019">2019-snakemake-cli</a></li>
<li><a href="#byok8s">2019-snakemake-byok8s</a></li>
</ul>
</li>
<li><a href="#byok8s2">Overview of 2019-snakemake-byok8s</a><ul>
<li><a href="#k8s">Cloud + Scale = Kubernetes</a></li>
<li><a href="#smkk8s">Snakemake k8s support</a></li>
</ul>
</li>
<li><a href="#cli">Modifying the CLI</a><ul>
<li><a href="#ns">Namespaces</a></li>
<li><a href="#flags">Adding flags</a></li>
</ul>
</li>
<li><a href="#minikube">Local Kubernetes Clusters with Minikube</a><ul>
<li><a href="#minikube">What is minikube?</a></li>
<li><a href="#aws">AWS</a></li>
<li><a href="#dns-aws">Fixing DNS issues with AWS</a></li>
<li><a href="#travis">Travis</a></li>
<li><a href="#travis-yml"><code>.travis.yml</code></a></li>
</ul>
</li>
<li><a href="#byok8s3">End Product: byok8s</a></li>
<li><a href="#docs">Documentation</a></li>
<li><a href="#next">Next Steps</a></li>
</ul>
<p><br />
<br /></p>
<p><a name="exe"></a></p>
<h1>Recap: Workflows as Executables</h1>
<p>In our previous blog post, <a href="https://charlesreid1.github.io/building-snakemake-command-line-wrappers.html">Building Snakemake Command Line Wrappers</a>,
we covered some approaches to making Snakemake
workflows into executables that can be run as
command line utilities.</p>
<p>In this post, we extend those ideas to Snakemake workflows
that run on Kubernetes clusters.</p>
<p><a name="2018"></a></p>
<h2>2018-snakemake-cli</h2>
<p>To recap, back in March 2018 Titus Brown wrote a blog post titled
<a href="http://ivory.idyll.org/blog/2018-workflows-applications.html">Pydoit, snakemake, and workflows-as-applications</a>
in which he implemented a proof-of-concept command
line utility wrapping the Snakemake API to create
an executable Snakemake workflow.</p>
<p>The end result was a command line utility that could
be run like so:</p>
<div class="highlight"><pre><span></span>./run &lt;workflow-config&gt; &lt;workflow-params&gt;
</pre></div>


<p>Relevant code is in <a href="https://github.com/ctb/2018-snakemake-cli">ctb/2018-snakemake-cli</a>.</p>
<p><a name="2019"></a></p>
<h2>2019-snakemake-cli</h2>
<p>In our previous blog post, <a href="https://charlesreid1.github.io/building-snakemake-command-line-wrappers.html">Building Snakemake Command Line Wrappers</a>,
we extended this idea to create a bundled executable
command line utility that could be installed with
<code>setup.py</code> and run from a working directory. We also
demonstrated a method of writing tests for the 
Snakemake workflow and running those tests with
Travis CI.</p>
<p>We packaged the Snakefile with the command line utility,
but the approach is flexible and can be modified to
use a user-provided Snakemake workflow or Snakefile.</p>
<p>The end result was a command line utility called
<code>bananas</code> that could be installed and run like
the <code>run</code> wrapper above:</p>
<div class="highlight"><pre><span></span>bananas &lt;workflow-config&gt; &lt;workflow-params&gt;
</pre></div>


<p>Relevant code is in <a href="https://github.com/charlesreid1/2019-snakemake-cli">charlesreid1/2019-snakemake-cli</a>.</p>
<p><a name="byok8s"></a></p>
<h2>2019-snakemake-byok8s</h2>
<p>The next logical step in bundling workflows was to take
advantage of Snakemake's ability to run workflows across
distributed systems.</p>
<p>Specifically, we wanted to modify the command line utility
above to run the workflow on a user-provided Kubernetes
cluster, instead of running the workflow locally.</p>
<p>The result is <a href="https://github.com/charlesreid1/2019-snakemake-byok8s">2019-snakemake-byok8s</a>,
a command line utility that can be installed with
a <code>setup.py</code> and that launches a Snakemake workflow 
on a user-provided Kubernetes cluster. Furthermore,
we demonstrate how to use minikube to run a local
Kubernetes cluster to test Snakemake workflows on
Kubernetes clusters.</p>
<p>Here's what it looks like in practice:</p>
<div class="highlight"><pre><span></span># Get byok8s
git clone https://github.com/charlesreid1/2019-snakemake-byok8s.git
cd ~/2019-snakemake-byok8s

# Create a virtual environment
virtualenv vp
vp/bin/actiavte

# Install byok8s
pip install -r requirements.txt
python setup.py build install

# Create virtual k8s cluster
minikube start

# Run the workflow on the k8s cluster
cd /path/to/workflow/
byok8s my-workflowfile my-paramsfile --s3-bucket=my-bucket

# Clean up the virtual k8s cluster
minikube stop
</pre></div>


<p>We cover the details below.</p>
<p><br />
<br /></p>
<p><a name="byok8s2"></a></p>
<h1>Overview of 2019-snakemake-byok8s</h1>
<p><a name="k8s"></a></p>
<h2>Cloud + Scale = Kubernetes (k8s)</h2>
<p>First, why kubernetes (k8s)?</p>
<p>To scale Snakemake workflows to multiple compute nodes,
it is not enough to just give Snakemake a pile of
compute nodes and a way to remotely connect to each.
Snakemake requires the compute nodes to have a 
controller and a job submission system.</p>
<p>When using cloud computing platforms like GCP (Google 
Cloud Platform) or AWS (Amazon Web Services),
k8s is a simple and popular way to orchestrate
multiple compute nodes (support for Docker images
is also baked directly into k8s).</p>
<p><a name="smkk8s"></a></p>
<h2>Snakemake k8s Support</h2>
<p>Snakemake has built-in support for k8s, making
the combination a logical choice for running 
Snakemake workflows at scale in the cloud. </p>
<p>The <code>minikube</code> tool, which we will cover later
in this blog post, makes it easy to run a local
virtual k8s cluster for testing purposes, and
even makes it possible to run k8s tests using
Travis CI.</p>
<p>Snakemake only requires the <code>--kubernetes</code> flag,
and an optional namespace, to connect to
the k8s cluster. (Under the hood, Snakemake
uses the Kubernetes Python API to connect
to the cluster and launch jobs.)</p>
<p>If you can run <code>kubectl</code> from a computer
to control the Kubernetes cluster, you can
run a Snakemake workflow on that cluster.</p>
<p>Let's get into the changes required in the Python code.</p>
<p><br />
<br /></p>
<p><a name="cli"></a></p>
<h1>Modifying the CLI</h1>
<p>In our <a href="https://charlesreid1.github.io/building-snakemake-command-line-wrappers.html">prior post</a>
covering <a href="https://github.com/charlesreid1/2019-snakemake-cli">charlesreid1/2019-snakemake-cli</a>,
we showed how to create a command line utility
using the <code>cli/</code> directory for the command line
interface package, and specifying it is a cli
entrypoint in <code>setup.py</code>:</p>
<div class="highlight"><pre><span></span>cli/
 Snakefile
 __init__.py
 command.py
</pre></div>


<p>and the relevant bit from <code>setup.py</code>:</p>
<div class="highlight"><pre><span></span><span class="n">setup</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;bananas&#39;</span><span class="p">,</span>
        <span class="o">...</span>
        <span class="n">entry_points</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">[console_scripts]</span>
<span class="s2">{program} = cli.command:main</span>
<span class="s2">      &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">program</span> <span class="o">=</span> <span class="n">_program</span><span class="p">),</span>
</pre></div>


<p>We want our new command line utility, <code>byok8s</code>, to work
the same way, so we can do a <code>s/byok8s/bananas/g</code>
across the package.</p>
<p>The only change required happens in the file
<code>command.py</code>, where the Snakemake API call 
happens.</p>
<p><a name="ns"></a></p>
<h2>Namespaces</h2>
<p>Checking the <a href="https://snakemake.readthedocs.io/en/stable/api_reference/snakemake.html">Snakemake API documentation</a>,
we can see that the API has a <code>kubernetes</code> option:</p>
<blockquote>
<p><strong>kubernetes</strong> <em>(str)</em>  submit jobs to kubernetes,
using the given namespace.</p>
</blockquote>
<p>so <code>command.py</code> should modify the Snakmake API call
accordingly, adding a kubernetes namespace.
This is a parameter the user usually won't need
to provide (<code>default</code> is the typical namespace
we want to use) but we added a <code>-k</code> argument
to the ArgParser to allow the user to specify
the Kubernetes namespace name. By default
the Kubernetes namespace used is <code>default</code>.</p>
<p><a name="flags"></a></p>
<h2>Adding flags</h2>
<p>We add and modify some flags to make the workflow
more flexible:</p>
<ul>
<li>
<p>The user now provides the Snakefile, which is
  called <code>Snakefile</code> in the current working directory
  by default but can be specified with the <code>--snakefile</code>
  or <code>-s</code> flag</p>
</li>
<li>
<p>The user provides the k8s namespace using the
  <code>--k8s-namespace</code> or <code>-k</code> flag</p>
</li>
<li>
<p>The user provides the name of an S3 bucket for
  Snakemake worker nodes to use for I/O using the
  <code>--s3-bucket</code> flag</p>
</li>
</ul>
<p>Finally, the user is also required to provide their
AWS credentials to access the S3 bucket, via two
environment variables that Snakemake passes through
to the Kubernetes worker nodes:</p>
<div class="highlight"><pre><span></span>AWS_ACCESS_KEY_ID
AWS_SECRET_ACCESS_KEY
</pre></div>


<p>For Travis CI testing, these environment variables
can be set in the repository settings on the Travis
website once Travis CI has been enabled.</p>
<p>See <a href="https://charlesreid1.github.io/2019-snakemake-byok8s/travis_tests/">https://charlesreid1.github.io/2019-snakemake-byok8s/travis_tests/</a>
for details.</p>
<p><br />
<br /></p>
<p><a name="minikube"></a></p>
<h1>Local Kubernetes Clusters with Minikube</h1>
<p><a name="minikube"></a></p>
<h2>What is minikube?</h2>
<p>Minikube is a Go program that allows users to simulate
a single-node kubernetes cluster using a virtual machine.
This is useful for local testing of Kubernetes workflows,
as it does not require setting up or tearing down cloud
infrastructure, or long waits for remote resources to
become ready.</p>
<p>We cover two ways to use it:</p>
<ol>
<li>
<p>Installing and running a minikube virtual kubernetes cluster on
   AWS (for development and testing of Snakemake + kubernetes
   workflows)</p>
</li>
<li>
<p>Running a minikube cluster on a Travis CI worker node
   to enable us to <em>test</em> Snakemake + kubernetes workflows.</p>
</li>
</ol>
<p><a name="aws"></a></p>
<h2>AWS</h2>
<p>Using Minikube from an AWS EC2 compute node comes 
with two hangups.</p>
<p>The first is that AWS nodes are virtual machines,
and you can't run virtual machines within virtual
machines, so it is not possible to use minikube's
normal VirtualBox mode, which creates a kubernetes
cluster using a virutal machine.</p>
<p>Instead, we must use minikube's native driver, meaning
minikube uses docker directly. This is tricky for several
reasons:</p>
<ul>
<li>we can't bind-mount a local directory into the
  kubernetes cluster</li>
<li>the minikube cluster must be run with sudo
  privileges, which means permissions can be
  a problem</li>
</ul>
<p>The second hangup with minikube on AWS nodes is that the
DNS settings of AWS nodes are copied into the Kubernetes
containers, including the kubernetes system's DNS service
container. Unfortunately, the AWS node's DNS settings are
not valid in the kubernetes cluster, so the DNS container
crashes, and no container in the kubernetes cluster can
reach the outside world.  This must be fixed with a
custom config file (provided with byok8s; details below).</p>
<h3>Installing Python Prerequisites</h3>
<p>To use byok8s from a fresh Ubuntu AWS node
(tested with Ubuntu 16.04 (xenial) and 18.04
(bionic)), you will want to install a version
of conda; we recommend using pyenv and miniconda:</p>
<div class="highlight"><pre><span></span>curl https://pyenv.run | bash
</pre></div>


<p>Restart your shell and install miniconda:</p>
<div class="highlight"><pre><span></span>pyenv update
pyenv install miniconda3-4.3.30
pyenv global miniconda3-4.3.30
</pre></div>


<p>You will also need the virtualenv package to
set up a virtual environment:</p>
<div class="highlight"><pre><span></span>pip install virtualenv
</pre></div>


<h3>Installing byok8s</h3>
<p>Start by cloning the repo and installing byok8s:</p>
<div class="highlight"><pre><span></span>cd 
git clone https://github.com/charlesreid1/2019-snakemake-byok8s.git
cd ~/2019-snakemake-byok8s
</pre></div>


<p>Next, you'll create a virtual environment:</p>
<div class="highlight"><pre><span></span>virtualenv vp
source vp/bin/activate

pip install -r requirements.txt
python setup.py build install
</pre></div>


<p>Now you should be ready to rock:</p>
<div class="highlight"><pre><span></span>which byok8s
</pre></div>


<h3>Starting a k8s cluster with minikube</h3>
<p>Install minikube:</p>
<div class="highlight"><pre><span></span>curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64 \
  &amp;&amp; sudo install minikube-linux-amd64 /usr/local/bin/minikube
</pre></div>


<p>Now you're ready to start a minikube k8s
cluster on your AWS node! Start a k8s cluster
as root with:</p>
<div class="highlight"><pre><span></span>sudo minikube start
</pre></div>


<p><strong>NOTE:</strong> The <code>minikube start</code> command will print
some commands for you to run to fix permissions -
it is importat you run them!</p>
<p>Tear down the cluster with:</p>
<div class="highlight"><pre><span></span>sudo minikube stop
</pre></div>


<p>While the k8s cluster is running, you can control
it and interact with it like a normal k8s cluster
using <code>kubectl</code>.</p>
<p>However, as-is, the cluster's DNS settings are broken!
We need to fix them before running.</p>
<p><a name="dns-aws"></a></p>
<h2>Fixing DNS issues with AWS</h2>
<p>We mentioned a second hangup with AWS was with the
DNS settings. </p>
<p>The problem is with <code>/etc/resolv.conf</code> on the
AWS host node. It is set up for AWS's internal 
cloud network routing, but this is copied
into the CoreDNS container, which is the
kube-system container that manages DNS requests
from all k8s containers. The settings from the
AWS host confuse the DNS container, and it cannot
route any DNS requests.</p>
<h3>The Problem</h3>
<p>If you're having the problem, you will see
something like this with <code>kubectl</code>, where the
coredns containers are in a <code>CrashLoopBackOff</code>:</p>
<div class="highlight"><pre><span></span>$ kubectl get pods --namespace<span class="o">=</span>kube-system

NAME                               READY   STATUS             RESTARTS   AGE
coredns-86c58d9df4-lvq8b           <span class="m">0</span>/1     CrashLoopBackOff   <span class="m">5</span>          5m17s
coredns-86c58d9df4-pr52t           <span class="m">0</span>/1     CrashLoopBackOff   <span class="m">5</span>          5m17s
etcd-minikube                      <span class="m">1</span>/1     Running            <span class="m">15</span>         4h43m
kube-addon-manager-minikube        <span class="m">1</span>/1     Running            <span class="m">16</span>         4h43m
kube-apiserver-minikube            <span class="m">1</span>/1     Running            <span class="m">15</span>         4h43m
kube-controller-manager-minikube   <span class="m">1</span>/1     Running            <span class="m">15</span>         4h43m
kube-proxy-sq77h                   <span class="m">1</span>/1     Running            <span class="m">3</span>          4h44m
kube-scheduler-minikube            <span class="m">1</span>/1     Running            <span class="m">15</span>         4h43m
storage-provisioner                <span class="m">1</span>/1     Running            <span class="m">6</span>          4h44m
</pre></div>


<p>This will cause all Snakemake jobs to fail with a name
resolution failure when it tries to write its output
files to the AWS S3 bucket:</p>
<div class="highlight"><pre><span></span>$ kubectl logs snakejob-c71fba38-f64b-5803-915d-933ae273d7a4

Building DAG of jobs...
Using shell: /bin/bash
Provided cores: <span class="m">4</span>
Rules claiming more threads will be scaled down.
Job counts:
    count   <span class="nb">jobs</span>
    <span class="m">1</span>   target1
    <span class="m">1</span>

<span class="o">[</span>Thu Jan <span class="m">24</span> <span class="m">00</span>:06:03 <span class="m">2019</span><span class="o">]</span>
rule target1:
    output: cmr-smk-0123/alpha.txt
    jobid: <span class="m">0</span>

<span class="nb">echo</span> alpha blue &gt; cmr-smk-0123/alpha.txt
Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
  File <span class="s2">&quot;/opt/conda/lib/python3.7/site-packages/urllib3/connection.py&quot;</span>, line <span class="m">171</span>, in _new_conn
    <span class="o">(</span>self._dns_host, self.port<span class="o">)</span>, self.timeout, **extra_kw<span class="o">)</span>
  File <span class="s2">&quot;/opt/conda/lib/python3.7/site-packages/urllib3/util/connection.py&quot;</span>, line <span class="m">56</span>, in create_connection
    <span class="k">for</span> res in socket.getaddrinfo<span class="o">(</span>host, port, family, socket.SOCK_STREAM<span class="o">)</span>:
  File <span class="s2">&quot;/opt/conda/lib/python3.7/socket.py&quot;</span>, line <span class="m">748</span>, in getaddrinfo
    <span class="k">for</span> res in _socket.getaddrinfo<span class="o">(</span>host, port, family, type, proto, flags<span class="o">)</span>:
socket.gaierror: <span class="o">[</span>Errno -3<span class="o">]</span> Temporary failure in name resolution
</pre></div>


<p>and the kubernetes log for the CoreDNS container</p>
<div class="highlight"><pre><span></span>$ kubectl logs --namespace<span class="o">=</span>kube-system coredns-86c58d9df4-lvq8b

.:53
<span class="m">2019</span>/01/25 <span class="m">14</span>:54:48 <span class="o">[</span>INFO<span class="o">]</span> CoreDNS-1.2.2
<span class="m">2019</span>/01/25 <span class="m">14</span>:54:48 <span class="o">[</span>INFO<span class="o">]</span> linux/amd64, go1.11, fc62f9c
CoreDNS-1.2.2
linux/amd64, go1.11, eb51e8b
<span class="m">2019</span>/01/25 <span class="m">14</span>:54:48 <span class="o">[</span>INFO<span class="o">]</span> plugin/reload: Running configuration <span class="nv">MD5</span> <span class="o">=</span> 486384b491cef6cb69c1f57a02087373
<span class="m">2019</span>/01/25 <span class="m">14</span>:54:48 <span class="o">[</span>FATAL<span class="o">]</span> plugin/loop: Seen <span class="s2">&quot;HINFO IN 9273194449250285441.798654804648663468.&quot;</span> more than twice, loop detected
</pre></div>


<p>Basically, the AWS node's DNS name server settings cause 
an infinite DNS loop to be set up.</p>
<h3>The Fix</h3>
<p>Fixing this problem requires manually setting the DNS 
name servers inside the CoreDNS container to Google's
public DNS servers, <code>8.8.8.8</code> and <code>8.8.4.4</code>.</p>
<p>To apply this fix, we use a YAML configuration file to patch the
CoreDNS container image.</p>
<p>Hat tip to <a href="https://github.com/kubernetes/minikube/issues/2027">this long Github issue</a>
in the minikube Github repo, and specifically 
<a href="https://github.com/kubernetes/minikube/issues/2027#issuecomment-381574807">this comment</a>
by Github user <a href="https://github.com/jgoclawski">jgoclawski</a>.
and also <a href="https://github.com/kubernetes/minikube/issues/2027#issuecomment-419733791">this comment</a>
by Github user <a href="https://github.com/bw2">bw2</a>.
(Note that neither of these quite solve the problem -
jgoclawski's solution is for kube-dns, not CoreDNS,
and bw2's YAML is not valid, but both got me most
of the way to a solution.)</p>
<p>Here is the YAML file (also in the 2019-snakemake-byok8s
repo here: <a href="https://github.com/charlesreid1/2019-snakemake-byok8s/blob/master/test/fixcoredns.yml">https://github.com/charlesreid1/2019-snakemake-byok8s/blob/master/test/fixcoredns.yml</a>):</p>
<p><strong><code>fixcoredns.yml</code>:</strong></p>
<div class="highlight"><pre><span></span><span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
<span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">data</span><span class="p">:</span>
  <span class="nt">Corefile</span><span class="p">:</span> <span class="p p-Indicator">|</span>
    <span class="no">.:53 {</span>
        <span class="no">errors</span>
        <span class="no">health</span>
        <span class="no">kubernetes cluster.local in-addr.arpa ip6.arpa {</span>
           <span class="no">upstream 8.8.8.8 8.8.4.4</span>
           <span class="no">pods insecure</span>
           <span class="no">fallthrough in-addr.arpa ip6.arpa</span>
        <span class="no">}</span>
        <span class="no">proxy .  8.8.8.8 8.8.4.4</span>
        <span class="no">cache 30</span>
        <span class="no">reload</span>
    <span class="no">}</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">creationTimestamp</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">2019-01-25T22:55:15Z</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">coredns</span>
  <span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kube-system</span>
</pre></div>


<p>(<strong>NOTE:</strong> There is also a <code>fixkubedns.yml</code> if you are using
an older Kubernetes version that uses kube-dns instead of
CoreDNS.)</p>
<p>To tell the k8s cluster to use this image
when it creates a CoreDNS container, run
this kubectl command <em>while the cluster is
running</em>:</p>
<div class="highlight"><pre><span></span>kubectl apply -f fixcoredns.yml
</pre></div>


<p>Last but not least, delete all <code>kube-system</code> containers
and let Kubernetes regenerate them:</p>
<div class="highlight"><pre><span></span>kubectl delete --all pods --namespace kube-system
</pre></div>


<p>The pods will regenerate quickly, and you can
check to confirm that the CoreDNS container
is no longer in the <code>CrashLoopBackOff</code> state
and is <code>Running</code> nicely:</p>
<div class="highlight"><pre><span></span>kubectl get pods --namespace=kube-system
</pre></div>


<p>This is all documented in <a href="https://github.com/kubernetes/minikube/issues/2027#issuecomment-457808462">this comment</a>
in the same Github issue in the minikube repo
that was linked to above, <a href="https://github.com/kubernetes/minikube/issues/2027">kubernetes/minikube
issue #2027: dnsmasq pod CrashLoopBackOff</a>.</p>
<p><a name="aws-byok8s"></a></p>
<h2>AWS + byok8s Workflow</h2>
<p>Now that the k8s cluster is running successfully,
run the example byok8s workflow in the <code>test/</code> 
directory of the byok8s repository (assuming
you cloned the repo to <code>~/byok8s</code>, and are in
the same virtual environment as before):</p>
<div class="highlight"><pre><span></span># Return to our virtual environment
cd ~/2019-snakemake-byok8s/test/
source vp/bin/activate

# Verify k8s is running
minikube status

# Export AWS keys for Snakemake
export AWS_ACCESS_KEY_ID=&quot;XXXXX&quot;
export AWS_SECRET_ACCESS_KEY=&quot;XXXXX&quot;

# Run byok8s
byok8s workflow-alpha params-blue --s3-bucket=mah-bukkit 
</pre></div>


<p>The bucket you specify must be created in advance
and be writable by the account whose credentials
you are passing in via environment variables.</p>
<p>When you do all of this, you should see the job
running, then exiting successfully:</p>
<div class="highlight"><pre><span></span>$ byok8s --s3-bucket<span class="o">=</span>cmr-0123 -f workflow-alpha params-blue
--------
details!
    snakefile: /home/ubuntu/2019-snakemake-byok8s/test/Snakefile
    config: /home/ubuntu/2019-snakemake-byok8s/test/workflow-alpha.json
    params: /home/ubuntu/2019-snakemake-byok8s/test/params-blue.json
    target: target1
    k8s namespace: default
--------
Building DAG of jobs...
Using shell: /bin/bash
Provided cores: <span class="m">1</span>
Rules claiming more threads will be scaled down.
Job counts:
    count   <span class="nb">jobs</span>
    <span class="m">1</span>   target1
    <span class="m">1</span>
Resources before job selection: <span class="o">{</span><span class="s1">&#39;_cores&#39;</span>: <span class="m">1</span>, <span class="s1">&#39;_nodes&#39;</span>: <span class="m">9223372036854775807</span><span class="o">}</span>
Ready <span class="nb">jobs</span> <span class="o">(</span><span class="m">1</span><span class="o">)</span>:
    target1
Selected <span class="nb">jobs</span> <span class="o">(</span><span class="m">1</span><span class="o">)</span>:
    target1
Resources after job selection: <span class="o">{</span><span class="s1">&#39;_cores&#39;</span>: <span class="m">0</span>, <span class="s1">&#39;_nodes&#39;</span>: <span class="m">9223372036854775806</span><span class="o">}</span>

<span class="o">[</span>Mon Jan <span class="m">28</span> <span class="m">18</span>:06:08 <span class="m">2019</span><span class="o">]</span>
rule target1:
    output: cmr-0123/alpha.txt
    jobid: <span class="m">0</span>

<span class="nb">echo</span> alpha blue &gt; cmr-0123/alpha.txt
Get status with:
kubectl describe pod snakejob-e585b53f-f9d5-5142-ac50-af5a0d532e85
kubectl logs snakejob-e585b53f-f9d5-5142-ac50-af5a0d532e85
Checking status <span class="k">for</span> pod snakejob-e585b53f-f9d5-5142-ac50-af5a0d532e85
<span class="o">[</span>Mon Jan <span class="m">28</span> <span class="m">18</span>:06:18 <span class="m">2019</span><span class="o">]</span>
Finished job <span class="m">0</span>.
<span class="m">1</span> of <span class="m">1</span> steps <span class="o">(</span><span class="m">100</span>%<span class="o">)</span> <span class="k">done</span>
Complete log: /home/ubuntu/2019-snakemake-byok8s/test/.snakemake/log/2019-01-28T180607.988313.snakemake.log
unlocking
removing lock
removing lock
removed all locks
</pre></div>


<p>Woo hoo! You've successfully run a Snakemake workflow 
on a virtual Kubernetes cluster!</p>
<p><a name="travis"></a></p>
<h2>Travis</h2>
<p>Like running minikube on an AWS node, running minikube on Travis workers
also suffers from DNS issues. Fortunately, Github user 
<a href="https://github.com/LiliC">LiliC</a> worked out how to run
minikube on Travis, and importantly, <em>did so for multiple versions</em>
of minikube and kubernetes.</p>
<p>The relevant <code>.travis.yml</code> file is available in the 
<a href="https://github.com/LiliC/travis-minikube">LiliC/travis-minikube</a>
repo on Github.</p>
<p>We ended up using the <a href="https://github.com/LiliC/travis-minikube/tree/minikube-30-kube-1.12"><code>minikube-30-kube-1.12</code></a>
branch of LiliC/travis-minikube, which used the most up-to-date
version of minikube and kubernetes available in that repo. The <code>.travis.yml</code> file
provided by LiliC on that branch is 
<a href="https://github.com/LiliC/travis-minikube/blob/minikube-30-kube-1.12/.travis.yml">here</a>.</p>
<p>The example script by LiliC provided 90% of the legwork (thanks!!!),
and we only needed to modify a few lines of LiliC's Travis file
(which launches a redis container using kubectl)
to use Snakemake (launched via byok8s) instead.</p>
<p><a name="travis-yml"></a></p>
<h2><code>.travis.yml</code></h2>
<p>Here is the final <code>.travis.yml</code> file, which has explanatory comments.</p>
<p><strong><code>.travis.yml</code>:</strong></p>
<div class="highlight"><pre><span></span><span class="c1"># Modified from original:</span>
<span class="c1"># https://raw.githubusercontent.com/LiliC/travis-minikube/minikube-30-kube-1.12/.travis.yml</span>

<span class="c1"># byok8s and Snakemake both require Python,</span>
<span class="c1"># so we make this Travis CI test Python-based.</span>
<span class="nt">language</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">python</span>
<span class="nt">python</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="s">&quot;3.6&quot;</span>

<span class="c1"># Running minikube via travis requires sudo</span>
<span class="nt">sudo</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">required</span>

<span class="c1"># We need the systemd for the kubeadm and it&#39;s default from 16.04+</span>
<span class="nt">dist</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">xenial</span>

<span class="c1"># This moves Kubernetes specific config files.</span>
<span class="nt">env</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">CHANGE_MINIKUBE_NONE_USER=true</span>

<span class="nt">install</span><span class="p">:</span>
<span class="c1"># Install byok8s requirements (snakemake, python-kubernetes)</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">pip install -r requirements.txt</span>
<span class="c1"># Install byok8s cli tool</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">python setup.py build install</span>

<span class="nt">before_script</span><span class="p">:</span>
<span class="c1"># Do everything from test/</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">cd test</span>
<span class="c1"># Make root mounted as rshared to fix kube-dns issues.</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">sudo mount --make-rshared /</span>
<span class="c1"># Download kubectl, which is a requirement for using minikube.</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">curl -Lo kubectl https://storage.googleapis.com/kubernetes-release/release/v1.12.0/bin/linux/amd64/kubectl &amp;&amp; chmod +x kubectl &amp;&amp; sudo mv kubectl /usr/local/bin/</span>
<span class="c1"># Download minikube.</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">curl -Lo minikube https://storage.googleapis.com/minikube/releases/v0.30.0/minikube-linux-amd64 &amp;&amp; chmod +x minikube &amp;&amp; sudo mv minikube /usr/local/bin/</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">sudo minikube start --vm-driver=none --bootstrapper=kubeadm --kubernetes-version=v1.12.0</span>
<span class="c1"># Fix the kubectl context, as it&#39;s often stale.</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">minikube update-context</span>
<span class="c1"># Wait for Kubernetes to be up and ready.</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">JSONPATH=&#39;{range .items[*]}{@.metadata.name}:{range @.status.conditions[*]}{@.type}={@.status};{end}{end}&#39;; until kubectl get nodes -o jsonpath=&quot;$JSONPATH&quot; 2&gt;&amp;1 | grep -q &quot;Ready=True&quot;; do sleep 1; done</span>

<span class="c1">################</span>
<span class="c1">## easy test</span>
<span class="nt">script</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">kubectl cluster-info</span>
<span class="c1"># Verify kube-addon-manager.</span>
<span class="c1"># kube-addon-manager is responsible for managing other kubernetes components, such as kube-dns, dashboard, storage-provisioner..</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">JSONPATH=&#39;{range .items[*]}{@.metadata.name}:{range @.status.conditions[*]}{@.type}={@.status};{end}{end}&#39;; until kubectl -n kube-system get pods -lcomponent=kube-addon-manager -o jsonpath=&quot;$JSONPATH&quot; 2&gt;&amp;1 | grep -q &quot;Ready=True&quot;; do sleep 1;echo &quot;waiting for kube-addon-manager to be available&quot;; kubectl get pods --all-namespaces; done</span>
<span class="c1"># Wait for kube-dns to be ready.</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">JSONPATH=&#39;{range .items[*]}{@.metadata.name}:{range @.status.conditions[*]}{@.type}={@.status};{end}{end}&#39;; until kubectl -n kube-system get pods -lk8s-app=kube-dns -o jsonpath=&quot;$JSONPATH&quot; 2&gt;&amp;1 | grep -q &quot;Ready=True&quot;; do sleep 1;echo &quot;waiting for kube-dns to be available&quot;; kubectl get pods --all-namespaces; done</span>

<span class="c1">################ </span>
<span class="c1">## hard test</span>
<span class="c1"># run byok8s workflow on the k8s cluster</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">byok8s --s3-bucket=cmr-0123 -f workflow-alpha params-blue</span>
</pre></div>


<p><a name="byok8s3"></a></p>
<h1>End Product: byok8s</h1>
<p>The final byok8s package can be found in the
<a href="https://github.com/charlesreid1/2019-snakemake-byok8s">charlesreid1/2019-snakemake-byok8s</a>
repository on Github.</p>
<p>You can find documentation for 2019-snakemake-byok8s 
here: <a href="https://charlesreid1.github.io/2019-snakemake-byok8s/">https://charlesreid1.github.io/2019-snakemake-byok8s/</a></p>
<p>To return to our quick start, here is what running
byok8s end-to-end on a minikube kubernetes cluster 
on an AWS node looks like (slightly modified from
the intro of our post):</p>
<div class="highlight"><pre><span></span># Install minikube
curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64 \
  &amp;&amp; sudo install minikube-linux-amd64 /usr/local/bin/minikube

# Get byok8s
git clone https://github.com/charlesreid1/2019-snakemake-byok8s.git
cd ~/2019-snakemake-byok8s

# Create a virtual environment
virtualenv vp
vp/bin/actiavte

# Install byok8s
pip install -r requirements.txt
python setup.py build install

# Create virtual k8s cluster
sudo minikube start

# Fix CoreDNS
kubectl apply -f fixcoredns.yml
kubectl delete --all pods --namespace kube-system

# Wait for kube-system to respawn
kubectl get pods --namespace=kube-system

# Run the workflow on the k8s cluster
cd test/
byok8s workflow-alpha params-blue --s3-bucket=mah-bukkit 

# Clean up the virtual k8s cluster
sudo minikube stop
</pre></div>


<p><br />
<br /></p>
<p><a name="docs"></a></p>
<h1>Documentation</h1>
<p>You can find documentation for 2019-snakemake-byok8s 
here: <a href="https://charlesreid1.github.io/2019-snakemake-byok8s/">https://charlesreid1.github.io/2019-snakemake-byok8s/</a></p>
<p>The documentation covers a quick start on AWS nodes, 
similar to what is covered above, as well as more information
about running byok8s on other types of Kubernetes clusters
(e.g., AWS, Google Cloud, and Digital Ocean).</p>
<p><br />
<br /></p>
<p><a name="next"></a></p>
<h1>Next Steps</h1>
<p>Last year we were working on implementing metagenomic pipelines for
shotgun sequencing data as part of the <a href="https://github.com/dahak-metagenomics">dahak-metagenomics</a>
project. We implemented several Snakemake workflows
in the <a href="https://github.com/dahak-metagenomics/dahak">dahak</a>
repo, and began (but never completed) work on a command line utility
to run these workflows called <a href="https://github.com/dahak-metagenomics/dahak-taco">dahak-taco</a>.</p>
<p>Our next major goal is to reboot dahak-taco and redesign it to run metagenomic
workflows from dahak on Kubernetes clusters, similar to the way byok8s works.</p>
<p>Stay tuned for more!</p></div>

    </div>
</div>

<div class="v20"></div>

<div class="row">
    <div class="col-md-12" style="text-align: left;">

        <div class="tags">
            <p>Tags:&nbsp;&nbsp;&nbsp;
                    <a href="/tag/python.html">python</a>
                    &nbsp;&nbsp;
                    <a href="/tag/bioinformatics.html">bioinformatics</a>
                    &nbsp;&nbsp;
                    <a href="/tag/workflows.html">workflows</a>
                    &nbsp;&nbsp;
                    <a href="/tag/pipelines.html">pipelines</a>
                    &nbsp;&nbsp;
                    <a href="/tag/snakemake.html">snakemake</a>
                    &nbsp;&nbsp;
                    <a href="/tag/travis.html">travis</a>
                    &nbsp;&nbsp;
                    <a href="/tag/kubernetes.html">kubernetes</a>
                    &nbsp;&nbsp;
                    <a href="/tag/minikube.html">minikube</a>
                    &nbsp;&nbsp;
        </div>

    </div>
</div>


<div class="v200"></div>
  	            	</article>

<div class="row">
    <div class="col-md-4 col-centered" style="text-align: center;">

        <div class="pagination">



            <a class="prev" href="/index2.html">Older &rarr;</a>
        
          <br />
        </div>

    </div>
</div>

<div class="v50"></div>


        </div>

        <div class="col-md-4" style="text-align: center;">
<a name="a_archive"></a>


        <div class="well">

            <h2>February 2019</h2>

            <p class="archive">
            <a href="/a-few-of-my-favorite-peps.html">A Few of My Favorite PEPs</a>
            </p>
            <p class="archive">
            <a href="/context-managers-in-python.html">Context Managers in Python</a>
            </p>

        </div>

        <div class="v20"></div>


        <div class="well">

            <h2>January 2019</h2>

            <p class="archive">
            <a href="/building-snakemake-command-line-wrappers-for-kubernetes-workflows.html">Building Snakemake Command Line Wrappers for Kubernetes Workflows</a>
            </p>
            <p class="archive">
            <a href="/building-snakemake-command-line-wrappers-for-workflows.html">Building Snakemake Command Line Wrappers for Workflows</a>
            </p>
            <p class="archive">
            <a href="/recursive-backtracking-in-go-for-bioinformatics-applications-3-go-implementation-of-backtracking.html">Recursive Backtracking in Go for Bioinformatics Applications: 3. Go Implementation of Backtracking</a>
            </p>

        </div>

        <div class="v20"></div>


        <div class="well">

            <h2>December 2018</h2>

            <p class="archive">
            <a href="/recursive-backtracking-in-go-for-bioinformatics-applications-2-generating-variations.html">Recursive Backtracking in Go for Bioinformatics Applications: 2. Generating Variations</a>
            </p>
            <p class="archive">
            <a href="/recursive-backtracking-in-go-for-bioinformatics-applications-1-counting-variations.html">Recursive Backtracking in Go for Bioinformatics Applications: 1. Counting Variations</a>
            </p>
            <p class="archive">
            <a href="/basic-data-structures-in-go-maps.html">Basic Data Structures in Go: Maps</a>
            </p>
            <p class="archive">
            <a href="/learning-bioinformatics-with-go-and-rosalind.html">Learning Bioinformatics with Go and Rosalind</a>
            </p>

        </div>

        <div class="v20"></div>


        <div class="well">

            <h2>October 2018</h2>

            <p class="archive">
            <a href="/first-post-of-the-fall-part-2-flaskadillo.html">First Post of the Fall, Part 2: Flaskadillo</a>
            </p>
            <p class="archive">
            <a href="/first-post-of-the-fall-part-1-data-commons.html">First Post of the Fall, Part 1: Data Commons</a>
            </p>

        </div>

        <div class="v20"></div>


        <div class="well">

            <h2>May 2018</h2>

            <p class="archive">
            <a href="/current-projects.html">Current Projects</a>
            </p>

        </div>

        <div class="v20"></div>


        <div class="well">

            <h2>March 2018</h2>

            <p class="archive">
            <a href="/charlesreid1com-stack.html">Charlesreid1.com Stack</a>
            </p>

        </div>

        <div class="v20"></div>


        <div class="well">

            <h2>February 2018</h2>

            <p class="archive">
            <a href="/d3-calendar-visualizations.html">D3 Calendar Visualizations</a>
            </p>
            <p class="archive">
            <a href="/project-euler-problem-172.html">Project Euler Problem 172</a>
            </p>

        </div>

        <div class="v20"></div>


        <div class="well">

            <h2>January 2018</h2>

            <p class="archive">
            <a href="/4x4-rubiks-cube-part-4-sequence-order.html">4x4 Rubik's Cube: Part 4: Sequence Order</a>
            </p>
            <p class="archive">
            <a href="/4x4-rubiks-cube-part-3-factoring-permutations.html">4x4 Rubik's Cube: Part 3: Factoring Permutations</a>
            </p>
            <p class="archive">
            <a href="/4x4-rubiks-cube-part-2-permutations.html">4x4 Rubik's Cube: Part 2: Permutations</a>
            </p>
            <p class="archive">
            <a href="/4x4-rubiks-cube-part-1-representations.html">4x4 Rubik's Cube: Part 1: Representations</a>
            </p>
            <p class="archive">
            <a href="/lets-generate-permutations.html">Let's Generate Permutations!</a>
            </p>

        </div>

        <div class="v20"></div>


        <div class="well">

            <h2>September 2017</h2>

            <p class="archive">
            <a href="/five-letter-words-part-3-letter-coverage-and-dynamic-programming.html">Five Letter Words: Part 3: Letter Coverage and Dynamic Programming</a>
            </p>
            <p class="archive">
            <a href="/five-letter-words-part-2-more-five-word-algorithms.html">Five Letter Words: Part 2: More Five-Word Algorithms</a>
            </p>
            <p class="archive">
            <a href="/five-letter-words-part-1-getting-familiar-with-the-list.html">Five Letter Words: Part 1: Getting Familiar With The List</a>
            </p>

        </div>

        <div class="v20"></div>


        <div class="well">

            <h2>August 2017</h2>

            <p class="archive">
            <a href="/eulers-theorem-the-totient-function-and-calculating-totients-by-hand.html">Euler's Theorem, the Totient Function, and Calculating Totients By Hand</a>
            </p>

        </div>

        <div class="v20"></div>


        <div class="well">

            <h2>July 2017</h2>

            <p class="archive">
            <a href="/mad-combinatoric-castles.html">Mad Combinatoric Castles</a>
            </p>
            <p class="archive">
            <a href="/project-euler-problem-1.html">Project Euler Problem 1</a>
            </p>
            <p class="archive">
            <a href="/shortest-lattice-paths-and-multiset-permutations.html">Shortest Lattice Paths and Multiset Permutations</a>
            </p>
            <p class="archive">
            <a href="/computing-square-roots-part-2-using-continued-fractions.html">Computing Square Roots: Part 2: Using Continued Fractions</a>
            </p>
            <p class="archive">
            <a href="/computing-square-roots-part-1-using-newtons-method.html">Computing Square Roots: Part 1: Using Newton's Method</a>
            </p>

        </div>

        <div class="v20"></div>


        <div class="well">

            <h2>June 2017</h2>

            <p class="archive">
            <a href="/cse-143-final-project-hilbert-sort-3-the-code.html">CSE 143 Final Project: Hilbert Sort: 3. The Code</a>
            </p>
            <p class="archive">
            <a href="/cse-143-final-project-hilbert-sort-2-the-solution-algorithm.html">CSE 143 Final Project: Hilbert Sort: 2. The Solution Algorithm</a>
            </p>
            <p class="archive">
            <a href="/cse-143-final-project-hilbert-sort-1-the-problem.html">CSE 143 Final Project: Hilbert Sort: 1. The Problem</a>
            </p>
            <p class="archive">
            <a href="/cse-143-final-project-classy.html">CSE 143 Final Project: Classy</a>
            </p>
            <p class="archive">
            <a href="/cse-143-final-project-checkers.html">CSE 143 Final Project: Checkers</a>
            </p>

        </div>

        <div class="v20"></div>


        <div class="well">

            <h2>May 2017</h2>

            <p class="archive">
            <a href="/teaching-recursion-with-the-n-queens-problem.html">Teaching Recursion with the N Queens Problem</a>
            </p>
            <p class="archive">
            <a href="/undergraduate-research-project-wireless-sensor-networks-for-internet-of-things-applications-part-2-the-technologies.html">Undergraduate Research Project: Wireless Sensor Networks for Internet of Things Applications (Part 2: The Technologies)</a>
            </p>
            <p class="archive">
            <a href="/undergraduate-research-project-wireless-sensor-networks-for-internet-of-things-applications-part-1-the-project.html">Undergraduate Research Project: Wireless Sensor Networks for Internet of Things Applications (Part 1: The Project)</a>
            </p>

        </div>

        <div class="v20"></div>


        <div class="well">

            <h2>April 2017</h2>

            <p class="archive">
            <a href="/stunnel.html">Stunnel</a>
            </p>
            <p class="archive">
            <a href="/traveling-schoolteacher-problem.html">Traveling Schoolteacher Problem</a>
            </p>
            <p class="archive">
            <a href="/the-z-machine-a-simple-turing-machine.html">The Z-Machine: A Simple Turing Machine</a>
            </p>
            <p class="archive">
            <a href="/awsome-day-seattle-notes-part-2-networking-security-and-miscellany.html">AWSome Day Seattle Notes: Part 2: Networking, Security, and Miscellany</a>
            </p>
            <p class="archive">
            <a href="/awsome-day-seattle-notes-part-1-the-basics.html">AWSome Day Seattle Notes: Part 1: The Basics</a>
            </p>
            <p class="archive">
            <a href="/setting-up-a-self-hosted-github-clone-with-gitea.html">Setting Up a Self-Hosted Github Clone with Gitea</a>
            </p>
            <p class="archive">
            <a href="/better-timing-of-guava-traveling-salesperson-problem-code-timing-scripts.html">Better Timing of Guava Traveling Salesperson Problem Code: Timing Scripts</a>
            </p>

        </div>

        <div class="v20"></div>


        <div class="well">

            <h2>March 2017</h2>

            <p class="archive">
            <a href="/fixing-bottlenecks-in-the-guava-traveling-salesperson-problem-code.html">Fixing Bottlenecks in the Guava Traveling Salesperson Problem Code</a>
            </p>
            <p class="archive">
            <a href="/python-vs-perl-n-queens-problem.html">Python vs. Perl: N Queens Problem</a>
            </p>
            <p class="archive">
            <a href="/solving-the-traveling-salesperson-problem-with-java-and-guava.html">Solving the Traveling Salesperson Problem with Java and Guava</a>
            </p>
            <p class="archive">
            <a href="/perl-vs-java-n-queens-problem.html">Perl vs. Java: N Queens Problem</a>
            </p>
            <p class="archive">
            <a href="/enigma-cipher-implementation-part-4-combinatorics.html">Enigma Cipher Implementation: Part 4: Combinatorics</a>
            </p>
            <p class="archive">
            <a href="/enigma-cipher-implementation-part-3-enigma-in-java-without-objects.html">Enigma Cipher Implementation: Part 3: Enigma in Java Without Objects</a>
            </p>
            <p class="archive">
            <a href="/enigma-cipher-implementation-part-2-pseudocode.html">Enigma Cipher Implementation: Part 2: Pseudocode</a>
            </p>
            <p class="archive">
            <a href="/enigma-cipher-implementation-part-1-how-it-works.html">Enigma Cipher Implementation: Part 1: How It Works</a>
            </p>

        </div>

        <div class="v20"></div>



<div class="v100"></div>
        </div>

    </div>



</div>



<script type="text/javascript" src="/theme/js/jquery-1.11.2.js"></script>
<script type="text/javascript" src="/theme/js/bootstrap-3.3.4.js"></script>
<script type="text/javascript" src="/theme/js/d3-3.5.5.js"></script><script type="text/javascript" src="/theme/js/jquery-1.11.2.js"></script>
<script type="text/javascript" src="/theme/js/bootstrap-3.3.4.js"></script>

<footer id="contentinfo" class="body">
<p>&nbsp;</p>
<p>&nbsp;</p>
<center>
	<hr />
</center>
<p>&nbsp;</p>
<p style="text-align: center">
    <span class="fa-stack fa-lg">
        <i class="fa fa-square fa-stack-2x" style="color:#000;"></i>
        <i class="fa fa-terminal fa-stack-1x fa-inverse"></i>
    </span>
    Made from the command line with vim by 
    <a href="http://charlesreid1.com">charlesreid1</a><br />
    with help from <a href="https://getbootstrap.com/">Bootstrap</a> and <a href="http://getpelican.com">Pelican</a>.
</p>

<br />

<p style="text-align: center">
    <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">
    <span class="fa-stack fa-lg">
        <i class="fa fa-square fa-stack-2x" style="color:#000;"></i>
        <i class="fa fa-creative-commons fa-stack-1x fa-inverse"></i>
    </span>
    </a>
    <br />
    Licensed under the <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">Creative Commons Attribution-NonCommercial 4.0 License</a>.
</p>

<!-- Start of StatCounter Code for Default Guide -->
<script type="text/javascript">
var sc_project=11611748;
var sc_invisible=1;
var sc_security="9fcba820";
</script>
<script type="text/javascript"
src="https://www.statcounter.com/counter/counter.js"
async></script>

<noscript><div class="statcounter"><a title="Web Analytics"
href="http://statcounter.com/" target="_blank"><img
class="statcounter"
src="//c.statcounter.com/11611748/0/9fcba820/1/" alt="Web
Analytics"></a></div></noscript>
<!-- End of StatCounter Code for Default Guide -->
</footer><!-- /#contentinfo -->
</body>
</html>